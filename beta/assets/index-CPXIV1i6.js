var so=Object.defineProperty;var io=(n,e,t)=>e in n?so(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var p=(n,e,t)=>io(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const W=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,Y=Object.keys,oe=Array.isArray;function pe(n,e){return typeof e!="object"||Y(e).forEach(function(t){n[t]=e[t]}),n}typeof Promise>"u"||W.Promise||(W.Promise=Promise);const nn=Object.getPrototypeOf,ro={}.hasOwnProperty;function ke(n,e){return ro.call(n,e)}function At(n,e){typeof e=="function"&&(e=e(nn(n))),(typeof Reflect>"u"?Y:Reflect.ownKeys)(e).forEach(t=>{Be(n,t,e[t])})}const ta=Object.defineProperty;function Be(n,e,t,s){ta(n,e,pe(t&&ke(t,"get")&&typeof t.get=="function"?{get:t.get,set:t.set,configurable:!0}:{value:t,configurable:!0,writable:!0},s))}function Ct(n){return{from:function(e){return n.prototype=Object.create(e.prototype),Be(n.prototype,"constructor",n),{extend:At.bind(null,n.prototype)}}}}const ao=Object.getOwnPropertyDescriptor;function yi(n,e){let t;return ao(n,e)||(t=nn(n))&&yi(t,e)}const oo=[].slice;function Un(n,e,t){return oo.call(n,e,t)}function na(n,e){return e(n)}function jt(n){if(!n)throw new Error("Assertion Failed")}function sa(n){W.setImmediate?setImmediate(n):setTimeout(n,0)}function ia(n,e){return n.reduce((t,s,i)=>{var r=e(s,i);return r&&(t[r[0]]=r[1]),t},{})}function Fe(n,e){if(typeof e=="string"&&ke(n,e))return n[e];if(!e)return n;if(typeof e!="string"){for(var t=[],s=0,i=e.length;s<i;++s){var r=Fe(n,e[s]);t.push(r)}return t}var a=e.indexOf(".");if(a!==-1){var l=n[e.substr(0,a)];return l==null?void 0:Fe(l,e.substr(a+1))}}function Se(n,e,t){if(n&&e!==void 0&&(!("isFrozen"in Object)||!Object.isFrozen(n)))if(typeof e!="string"&&"length"in e){jt(typeof t!="string"&&"length"in t);for(var s=0,i=e.length;s<i;++s)Se(n,e[s],t[s])}else{var r=e.indexOf(".");if(r!==-1){var a=e.substr(0,r),l=e.substr(r+1);if(l==="")t===void 0?oe(n)&&!isNaN(parseInt(a))?n.splice(a,1):delete n[a]:n[a]=t;else{var o=n[a];o&&ke(n,a)||(o=n[a]={}),Se(o,l,t)}}else t===void 0?oe(n)&&!isNaN(parseInt(e))?n.splice(e,1):delete n[e]:n[e]=t}}function ra(n){var e={};for(var t in n)ke(n,t)&&(e[t]=n[t]);return e}const lo=[].concat;function aa(n){return lo.apply([],n)}const oa="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(aa([8,16,32,64].map(n=>["Int","Uint","Float"].map(e=>e+n+"Array")))).filter(n=>W[n]),co=oa.map(n=>W[n]);ia(oa,n=>[n,!0]);let Ke=null;function un(n){Ke=typeof WeakMap<"u"&&new WeakMap;const e=Ns(n);return Ke=null,e}function Ns(n){if(!n||typeof n!="object")return n;let e=Ke&&Ke.get(n);if(e)return e;if(oe(n)){e=[],Ke&&Ke.set(n,e);for(var t=0,s=n.length;t<s;++t)e.push(Ns(n[t]))}else if(co.indexOf(n.constructor)>=0)e=n;else{const r=nn(n);for(var i in e=r===Object.prototype?{}:Object.create(r),Ke&&Ke.set(n,e),n)ke(n,i)&&(e[i]=Ns(n[i]))}return e}const{toString:uo}={};function Bs(n){return uo.call(n).slice(8,-1)}const Fs=typeof Symbol<"u"?Symbol.iterator:"@@iterator",ho=typeof Fs=="symbol"?function(n){var e;return n!=null&&(e=n[Fs])&&e.apply(n)}:function(){return null},Et={};function Me(n){var e,t,s,i;if(arguments.length===1){if(oe(n))return n.slice();if(this===Et&&typeof n=="string")return[n];if(i=ho(n)){for(t=[];!(s=i.next()).done;)t.push(s.value);return t}if(n==null)return[n];if(typeof(e=n.length)=="number"){for(t=new Array(e);e--;)t[e]=n[e];return t}return[n]}for(e=arguments.length,t=new Array(e);e--;)t[e]=arguments[e];return t}const ki=typeof Symbol<"u"?n=>n[Symbol.toStringTag]==="AsyncFunction":()=>!1;var Ae=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function la(n,e){Ae=n,ca=e}var ca=()=>!0;const po=!new Error("").stack;function ht(){if(po)try{throw ht.arguments,new Error}catch(n){return n}return new Error}function Vs(n,e){var t=n.stack;return t?(e=e||0,t.indexOf(n.name)===0&&(e+=(n.name+n.message).split(`
`).length),t.split(`
`).slice(e).filter(ca).map(s=>`
`+s).join("")):""}var ua=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],bi=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(ua),fo={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function It(n,e){this._e=ht(),this.name=n,this.message=e}function ha(n,e){return n+". Errors: "+Object.keys(e).map(t=>e[t].toString()).filter((t,s,i)=>i.indexOf(t)===s).join(`
`)}function qn(n,e,t,s){this._e=ht(),this.failures=e,this.failedKeys=s,this.successCount=t,this.message=ha(n,e)}function Zt(n,e){this._e=ht(),this.name="BulkError",this.failures=Object.keys(e).map(t=>e[t]),this.failuresByPos=e,this.message=ha(n,e)}Ct(It).from(Error).extend({stack:{get:function(){return this._stack||(this._stack=this.name+": "+this.message+Vs(this._e,2))}},toString:function(){return this.name+": "+this.message}}),Ct(qn).from(It),Ct(Zt).from(It);var vi=bi.reduce((n,e)=>(n[e]=e+"Error",n),{});const go=It;var D=bi.reduce((n,e)=>{var t=e+"Error";function s(i,r){this._e=ht(),this.name=t,i?typeof i=="string"?(this.message=`${i}${r?`
 `+r:""}`,this.inner=r||null):typeof i=="object"&&(this.message=`${i.name} ${i.message}`,this.inner=i):(this.message=fo[e]||t,this.inner=null)}return Ct(s).from(go),n[e]=s,n},{});D.Syntax=SyntaxError,D.Type=TypeError,D.Range=RangeError;var or=ua.reduce((n,e)=>(n[e+"Error"]=D[e],n),{}),$n=bi.reduce((n,e)=>(["Syntax","Type","Range"].indexOf(e)===-1&&(n[e+"Error"]=D[e]),n),{});function V(){}function sn(n){return n}function mo(n,e){return n==null||n===sn?e:function(t){return e(n(t))}}function lt(n,e){return function(){n.apply(this,arguments),e.apply(this,arguments)}}function yo(n,e){return n===V?e:function(){var t=n.apply(this,arguments);t!==void 0&&(arguments[0]=t);var s=this.onsuccess,i=this.onerror;this.onsuccess=null,this.onerror=null;var r=e.apply(this,arguments);return s&&(this.onsuccess=this.onsuccess?lt(s,this.onsuccess):s),i&&(this.onerror=this.onerror?lt(i,this.onerror):i),r!==void 0?r:t}}function ko(n,e){return n===V?e:function(){n.apply(this,arguments);var t=this.onsuccess,s=this.onerror;this.onsuccess=this.onerror=null,e.apply(this,arguments),t&&(this.onsuccess=this.onsuccess?lt(t,this.onsuccess):t),s&&(this.onerror=this.onerror?lt(s,this.onerror):s)}}function bo(n,e){return n===V?e:function(t){var s=n.apply(this,arguments);pe(t,s);var i=this.onsuccess,r=this.onerror;this.onsuccess=null,this.onerror=null;var a=e.apply(this,arguments);return i&&(this.onsuccess=this.onsuccess?lt(i,this.onsuccess):i),r&&(this.onerror=this.onerror?lt(r,this.onerror):r),s===void 0?a===void 0?void 0:a:pe(s,a)}}function vo(n,e){return n===V?e:function(){return e.apply(this,arguments)!==!1&&n.apply(this,arguments)}}function wi(n,e){return n===V?e:function(){var t=n.apply(this,arguments);if(t&&typeof t.then=="function"){for(var s=this,i=arguments.length,r=new Array(i);i--;)r[i]=arguments[i];return t.then(function(){return e.apply(s,r)})}return e.apply(this,arguments)}}$n.ModifyError=qn,$n.DexieError=It,$n.BulkError=Zt;var rn={};const da=100,[Hs,jn,Ws]=typeof Promise>"u"?[]:(()=>{let n=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[n,nn(n),n];const e=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[e,nn(e),n]})(),pa=jn&&jn.then,Mn=Hs&&Hs.constructor,xi=!!Ws;var zs=!1,wo=Ws?()=>{Ws.then(wn)}:W.setImmediate?setImmediate.bind(null,wn):W.MutationObserver?()=>{var n=document.createElement("div");new MutationObserver(()=>{wn(),n=null}).observe(n,{attributes:!0}),n.setAttribute("i","1")}:()=>{setTimeout(wn,0)},Xt=function(n,e){Kt.push([n,e]),Kn&&(wo(),Kn=!1)},Us=!0,Kn=!0,rt=[],Nn=[],qs=null,js=sn,_t={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:ur,pgp:!1,env:{},finalize:function(){this.unhandleds.forEach(n=>{try{ur(n[0],n[1])}catch{}})}},R=_t,Kt=[],at=0,Bn=[];function _(n){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this.onuncatched=V,this._lib=!1;var e=this._PSD=R;if(Ae&&(this._stackHolder=ht(),this._prev=null,this._numPrev=0),typeof n!="function"){if(n!==rn)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&Gs(this,this._value))}this._state=null,this._value=null,++e.ref,ga(this,n)}const Ks={get:function(){var n=R,e=Gn;function t(s,i){var r=!n.global&&(n!==R||e!==Gn);const a=r&&!Ve();var l=new _((o,u)=>{Si(this,new fa(Yn(s,n,r,a),Yn(i,n,r,a),o,u,n))});return Ae&&ka(l,this),l}return t.prototype=rn,t},set:function(n){Be(this,"then",n&&n.prototype===rn?Ks:{get:function(){return n},set:Ks.set})}};function fa(n,e,t,s,i){this.onFulfilled=typeof n=="function"?n:null,this.onRejected=typeof e=="function"?e:null,this.resolve=t,this.reject=s,this.psd=i}function ga(n,e){try{e(t=>{if(n._state===null){if(t===n)throw new TypeError("A promise cannot be resolved with itself.");var s=n._lib&&hn();t&&typeof t.then=="function"?ga(n,(i,r)=>{t instanceof _?t._then(i,r):t.then(i,r)}):(n._state=!0,n._value=t,ma(n)),s&&dn()}},Gs.bind(null,n))}catch(t){Gs(n,t)}}function Gs(n,e){if(Nn.push(e),n._state===null){var t=n._lib&&hn();e=js(e),n._state=!1,n._value=e,Ae&&e!==null&&typeof e=="object"&&!e._promise&&function(s,i,r){try{s.apply(null,r)}catch{}}(()=>{var s=yi(e,"stack");e._promise=n,Be(e,"stack",{get:()=>zs?s&&(s.get?s.get.apply(e):s.value):n.stack})}),function(s){rt.some(i=>i._value===s._value)||rt.push(s)}(n),ma(n),t&&dn()}}function ma(n){var e=n._listeners;n._listeners=[];for(var t=0,s=e.length;t<s;++t)Si(n,e[t]);var i=n._PSD;--i.ref||i.finalize(),at===0&&(++at,Xt(()=>{--at==0&&Ti()},[]))}function Si(n,e){if(n._state!==null){var t=n._state?e.onFulfilled:e.onRejected;if(t===null)return(n._state?e.resolve:e.reject)(n._value);++e.psd.ref,++at,Xt(xo,[t,n,e])}else n._listeners.push(e)}function xo(n,e,t){try{qs=e;var s,i=e._value;e._state?s=n(i):(Nn.length&&(Nn=[]),s=n(i),Nn.indexOf(i)===-1&&function(r){for(var a=rt.length;a;)if(rt[--a]._value===r._value)return void rt.splice(a,1)}(e)),t.resolve(s)}catch(r){t.reject(r)}finally{qs=null,--at==0&&Ti(),--t.psd.ref||t.psd.finalize()}}function ya(n,e,t){if(e.length===t)return e;var s="";if(n._state===!1){var i,r,a=n._value;a!=null?(i=a.name||"Error",r=a.message||a,s=Vs(a,0)):(i=a,r=""),e.push(i+(r?": "+r:"")+s)}return Ae&&((s=Vs(n._stackHolder,2))&&e.indexOf(s)===-1&&e.push(s),n._prev&&ya(n._prev,e,t)),e}function ka(n,e){var t=e?e._numPrev+1:0;t<100&&(n._prev=e,n._numPrev=t)}function wn(){hn()&&dn()}function hn(){var n=Us;return Us=!1,Kn=!1,n}function dn(){var n,e,t;do for(;Kt.length>0;)for(n=Kt,Kt=[],t=n.length,e=0;e<t;++e){var s=n[e];s[0].apply(null,s[1])}while(Kt.length>0);Us=!0,Kn=!0}function Ti(){var n=rt;rt=[],n.forEach(s=>{s._PSD.onunhandled.call(null,s._value,s)});for(var e=Bn.slice(0),t=e.length;t;)e[--t]()}function xn(n){return new _(rn,!1,n)}function q(n,e){var t=R;return function(){var s=hn(),i=R;try{return Xe(t,!0),n.apply(this,arguments)}catch(r){e&&e(r)}finally{Xe(i,!1),s&&dn()}}}At(_.prototype,{then:Ks,_then:function(n,e){Si(this,new fa(null,null,n,e,R))},catch:function(n){if(arguments.length===1)return this.then(null,n);var e=arguments[0],t=arguments[1];return typeof e=="function"?this.then(null,s=>s instanceof e?t(s):xn(s)):this.then(null,s=>s&&s.name===e?t(s):xn(s))},finally:function(n){return this.then(e=>(n(),e),e=>(n(),xn(e)))},stack:{get:function(){if(this._stack)return this._stack;try{zs=!0;var n=ya(this,[],20).join(`
From previous: `);return this._state!==null&&(this._stack=n),n}finally{zs=!1}}},timeout:function(n,e){return n<1/0?new _((t,s)=>{var i=setTimeout(()=>s(new D.Timeout(e)),n);this.then(t,s).finally(clearTimeout.bind(null,i))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&Be(_.prototype,Symbol.toStringTag,"Dexie.Promise"),_t.env=ba(),At(_,{all:function(){var n=Me.apply(null,arguments).map(Sn);return new _(function(e,t){n.length===0&&e([]);var s=n.length;n.forEach((i,r)=>_.resolve(i).then(a=>{n[r]=a,--s||e(n)},t))})},resolve:n=>{if(n instanceof _)return n;if(n&&typeof n.then=="function")return new _((t,s)=>{n.then(t,s)});var e=new _(rn,!0,n);return ka(e,qs),e},reject:xn,race:function(){var n=Me.apply(null,arguments).map(Sn);return new _((e,t)=>{n.map(s=>_.resolve(s).then(e,t))})},PSD:{get:()=>R,set:n=>R=n},totalEchoes:{get:()=>Gn},newPSD:Ze,usePSD:Ot,scheduler:{get:()=>Xt,set:n=>{Xt=n}},rejectionMapper:{get:()=>js,set:n=>{js=n}},follow:(n,e)=>new _((t,s)=>Ze((i,r)=>{var a=R;a.unhandleds=[],a.onunhandled=r,a.finalize=lt(function(){(function(l){function o(){l(),Bn.splice(Bn.indexOf(o),1)}Bn.push(o),++at,Xt(()=>{--at==0&&Ti()},[])})(()=>{this.unhandleds.length===0?i():r(this.unhandleds[0])})},a.finalize),n()},e,t,s))}),Mn&&(Mn.allSettled&&Be(_,"allSettled",function(){const n=Me.apply(null,arguments).map(Sn);return new _(e=>{n.length===0&&e([]);let t=n.length;const s=new Array(t);n.forEach((i,r)=>_.resolve(i).then(a=>s[r]={status:"fulfilled",value:a},a=>s[r]={status:"rejected",reason:a}).then(()=>--t||e(s)))})}),Mn.any&&typeof AggregateError<"u"&&Be(_,"any",function(){const n=Me.apply(null,arguments).map(Sn);return new _((e,t)=>{n.length===0&&t(new AggregateError([]));let s=n.length;const i=new Array(s);n.forEach((r,a)=>_.resolve(r).then(l=>e(l),l=>{i[a]=l,--s||t(new AggregateError(i))}))})}));const ae={awaits:0,echoes:0,id:0};var So=0,Fn=[],ys=0,Gn=0,To=0;function Ze(n,e,t,s){var i=R,r=Object.create(i);r.parent=i,r.ref=0,r.global=!1,r.id=++To;var a=_t.env;r.env=xi?{Promise:_,PromiseProp:{value:_,configurable:!0,writable:!0},all:_.all,race:_.race,allSettled:_.allSettled,any:_.any,resolve:_.resolve,reject:_.reject,nthen:lr(a.nthen,r),gthen:lr(a.gthen,r)}:{},e&&pe(r,e),++i.ref,r.finalize=function(){--this.parent.ref||this.parent.finalize()};var l=Ot(r,n,t,s);return r.ref===0&&r.finalize(),l}function Lt(){return ae.id||(ae.id=++So),++ae.awaits,ae.echoes+=da,ae.id}function Ve(){return!!ae.awaits&&(--ae.awaits==0&&(ae.id=0),ae.echoes=ae.awaits*da,!0)}function Sn(n){return ae.echoes&&n&&n.constructor===Mn?(Lt(),n.then(e=>(Ve(),e),e=>(Ve(),Q(e)))):n}function Eo(n){++Gn,ae.echoes&&--ae.echoes!=0||(ae.echoes=ae.id=0),Fn.push(R),Xe(n,!0)}function Co(){var n=Fn[Fn.length-1];Fn.pop(),Xe(n,!1)}function Xe(n,e){var t=R;if((e?!ae.echoes||ys++&&n===R:!ys||--ys&&n===R)||va(e?Eo.bind(null,n):Co),n!==R&&(R=n,t===_t&&(_t.env=ba()),xi)){var s=_t.env.Promise,i=n.env;jn.then=i.nthen,s.prototype.then=i.gthen,(t.global||n.global)&&(Object.defineProperty(W,"Promise",i.PromiseProp),s.all=i.all,s.race=i.race,s.resolve=i.resolve,s.reject=i.reject,i.allSettled&&(s.allSettled=i.allSettled),i.any&&(s.any=i.any))}}function ba(){var n=W.Promise;return xi?{Promise:n,PromiseProp:Object.getOwnPropertyDescriptor(W,"Promise"),all:n.all,race:n.race,allSettled:n.allSettled,any:n.any,resolve:n.resolve,reject:n.reject,nthen:jn.then,gthen:n.prototype.then}:{}}function Ot(n,e,t,s,i){var r=R;try{return Xe(n,!0),e(t,s,i)}finally{Xe(r,!1)}}function va(n){pa.call(Hs,n)}function Yn(n,e,t,s){return typeof n!="function"?n:function(){var i=R;t&&Lt(),Xe(e,!0);try{return n.apply(this,arguments)}finally{Xe(i,!1),s&&va(Ve)}}}function lr(n,e){return function(t,s){return n.call(this,Yn(t,e),Yn(s,e))}}(""+pa).indexOf("[native code]")===-1&&(Lt=Ve=V);const cr="unhandledrejection";function ur(n,e){var t;try{t=e.onuncatched(n)}catch{}if(t!==!1)try{var s,i={promise:e,reason:n};if(W.document&&document.createEvent?((s=document.createEvent("Event")).initEvent(cr,!0,!0),pe(s,i)):W.CustomEvent&&pe(s=new CustomEvent(cr,{detail:i}),i),s&&W.dispatchEvent&&(dispatchEvent(s),!W.PromiseRejectionEvent&&W.onunhandledrejection))try{W.onunhandledrejection(s)}catch{}Ae&&s&&!s.defaultPrevented&&console.warn(`Unhandled rejection: ${n.stack||n}`)}catch{}}var Q=_.reject;function Ys(n,e,t,s){if(n.idbdb&&(n._state.openComplete||R.letThrough||n._vip)){var i=n._createTransaction(e,t,n._dbSchema);try{i.create(),n._state.PR1398_maxLoop=3}catch(r){return r.name===vi.InvalidState&&n.isOpen()&&--n._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),n._close(),n.open().then(()=>Ys(n,e,t,s))):Q(r)}return i._promise(e,(r,a)=>Ze(()=>(R.trans=i,s(r,a,i)))).then(r=>i._completion.then(()=>r))}if(n._state.openComplete)return Q(new D.DatabaseClosed(n._state.dbOpenError));if(!n._state.isBeingOpened){if(!n._options.autoOpen)return Q(new D.DatabaseClosed);n.open().catch(V)}return n._state.dbReadyPromise.then(()=>Ys(n,e,t,s))}const hr="3.2.7",it="ï¿¿",Zs=-1/0,Oe="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",wa="String expected.",Qt=[],ts=typeof navigator<"u"&&/(MSIE|Trident|Edge)/.test(navigator.userAgent),Io=ts,_o=ts,xa=n=>!/(dexie\.js|dexie\.min\.js)/.test(n),ns="__dbnames",ks="readonly",bs="readwrite";function ct(n,e){return n?e?function(){return n.apply(this,arguments)&&e.apply(this,arguments)}:n:e}const Sa={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Tn(n){return typeof n!="string"||/\./.test(n)?e=>e:e=>(e[n]===void 0&&n in e&&delete(e=un(e))[n],e)}class Ao{_trans(e,t,s){const i=this._tx||R.trans,r=this.name;function a(o,u,c){if(!c.schema[r])throw new D.NotFound("Table "+r+" not part of transaction");return t(c.idbtrans,c)}const l=hn();try{return i&&i.db===this.db?i===R.trans?i._promise(e,a,s):Ze(()=>i._promise(e,a,s),{trans:i,transless:R.transless||R}):Ys(this.db,e,[this.name],a)}finally{l&&dn()}}get(e,t){return e&&e.constructor===Object?this.where(e).first(t):this._trans("readonly",s=>this.core.get({trans:s,key:e}).then(i=>this.hook.reading.fire(i))).then(t)}where(e){if(typeof e=="string")return new this.db.WhereClause(this,e);if(oe(e))return new this.db.WhereClause(this,`[${e.join("+")}]`);const t=Y(e);if(t.length===1)return this.where(t[0]).equals(e[t[0]]);const s=this.schema.indexes.concat(this.schema.primKey).filter(u=>{if(u.compound&&t.every(c=>u.keyPath.indexOf(c)>=0)){for(let c=0;c<t.length;++c)if(t.indexOf(u.keyPath[c])===-1)return!1;return!0}return!1}).sort((u,c)=>u.keyPath.length-c.keyPath.length)[0];if(s&&this.db._maxKey!==it){const u=s.keyPath.slice(0,t.length);return this.where(u).equals(u.map(c=>e[c]))}!s&&Ae&&console.warn(`The query ${JSON.stringify(e)} on ${this.name} would benefit of a compound index [${t.join("+")}]`);const{idxByName:i}=this.schema,r=this.db._deps.indexedDB;function a(u,c){try{return r.cmp(u,c)===0}catch{return!1}}const[l,o]=t.reduce(([u,c],d)=>{const h=i[d],g=e[d];return[u||h,u||!h?ct(c,h&&h.multi?m=>{const y=Fe(m,d);return oe(y)&&y.some(w=>a(g,w))}:m=>a(g,Fe(m,d))):c]},[null,null]);return l?this.where(l.name).equals(e[l.keyPath]).filter(o):s?this.filter(o):this.where(t).equals("")}filter(e){return this.toCollection().and(e)}count(e){return this.toCollection().count(e)}offset(e){return this.toCollection().offset(e)}limit(e){return this.toCollection().limit(e)}each(e){return this.toCollection().each(e)}toArray(e){return this.toCollection().toArray(e)}toCollection(){return new this.db.Collection(new this.db.WhereClause(this))}orderBy(e){return new this.db.Collection(new this.db.WhereClause(this,oe(e)?`[${e.join("+")}]`:e))}reverse(){return this.toCollection().reverse()}mapToClass(e){this.schema.mappedClass=e;const t=s=>{if(!s)return s;const i=Object.create(e.prototype);for(var r in s)if(ke(s,r))try{i[r]=s[r]}catch{}return i};return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=t,this.hook("reading",t),e}defineClass(){return this.mapToClass(function(e){pe(this,e)})}add(e,t){const{auto:s,keyPath:i}=this.schema.primKey;let r=e;return i&&s&&(r=Tn(i)(e)),this._trans("readwrite",a=>this.core.mutate({trans:a,type:"add",keys:t!=null?[t]:null,values:[r]})).then(a=>a.numFailures?_.reject(a.failures[0]):a.lastResult).then(a=>{if(i)try{Se(e,i,a)}catch{}return a})}update(e,t){if(typeof e!="object"||oe(e))return this.where(":id").equals(e).modify(t);{const s=Fe(e,this.schema.primKey.keyPath);if(s===void 0)return Q(new D.InvalidArgument("Given object does not contain its primary key"));try{typeof t!="function"?Y(t).forEach(i=>{Se(e,i,t[i])}):t(e,{value:e,primKey:s})}catch{}return this.where(":id").equals(s).modify(t)}}put(e,t){const{auto:s,keyPath:i}=this.schema.primKey;let r=e;return i&&s&&(r=Tn(i)(e)),this._trans("readwrite",a=>this.core.mutate({trans:a,type:"put",values:[r],keys:t!=null?[t]:null})).then(a=>a.numFailures?_.reject(a.failures[0]):a.lastResult).then(a=>{if(i)try{Se(e,i,a)}catch{}return a})}delete(e){return this._trans("readwrite",t=>this.core.mutate({trans:t,type:"delete",keys:[e]})).then(t=>t.numFailures?_.reject(t.failures[0]):void 0)}clear(){return this._trans("readwrite",e=>this.core.mutate({trans:e,type:"deleteRange",range:Sa})).then(e=>e.numFailures?_.reject(e.failures[0]):void 0)}bulkGet(e){return this._trans("readonly",t=>this.core.getMany({keys:e,trans:t}).then(s=>s.map(i=>this.hook.reading.fire(i))))}bulkAdd(e,t,s){const i=Array.isArray(t)?t:void 0,r=(s=s||(i?void 0:t))?s.allKeys:void 0;return this._trans("readwrite",a=>{const{auto:l,keyPath:o}=this.schema.primKey;if(o&&i)throw new D.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(i&&i.length!==e.length)throw new D.InvalidArgument("Arguments objects and keys must have the same length");const u=e.length;let c=o&&l?e.map(Tn(o)):e;return this.core.mutate({trans:a,type:"add",keys:i,values:c,wantResults:r}).then(({numFailures:d,results:h,lastResult:g,failures:m})=>{if(d===0)return r?h:g;throw new Zt(`${this.name}.bulkAdd(): ${d} of ${u} operations failed`,m)})})}bulkPut(e,t,s){const i=Array.isArray(t)?t:void 0,r=(s=s||(i?void 0:t))?s.allKeys:void 0;return this._trans("readwrite",a=>{const{auto:l,keyPath:o}=this.schema.primKey;if(o&&i)throw new D.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(i&&i.length!==e.length)throw new D.InvalidArgument("Arguments objects and keys must have the same length");const u=e.length;let c=o&&l?e.map(Tn(o)):e;return this.core.mutate({trans:a,type:"put",keys:i,values:c,wantResults:r}).then(({numFailures:d,results:h,lastResult:g,failures:m})=>{if(d===0)return r?h:g;throw new Zt(`${this.name}.bulkPut(): ${d} of ${u} operations failed`,m)})})}bulkDelete(e){const t=e.length;return this._trans("readwrite",s=>this.core.mutate({trans:s,type:"delete",keys:e})).then(({numFailures:s,lastResult:i,failures:r})=>{if(s===0)return i;throw new Zt(`${this.name}.bulkDelete(): ${s} of ${t} operations failed`,r)})}}function Jt(n){var e={},t=function(a,l){if(l){for(var o=arguments.length,u=new Array(o-1);--o;)u[o-1]=arguments[o];return e[a].subscribe.apply(null,u),n}if(typeof a=="string")return e[a]};t.addEventType=r;for(var s=1,i=arguments.length;s<i;++s)r(arguments[s]);return t;function r(a,l,o){if(typeof a!="object"){var u;l||(l=vo),o||(o=V);var c={subscribers:[],fire:o,subscribe:function(d){c.subscribers.indexOf(d)===-1&&(c.subscribers.push(d),c.fire=l(c.fire,d))},unsubscribe:function(d){c.subscribers=c.subscribers.filter(function(h){return h!==d}),c.fire=c.subscribers.reduce(l,o)}};return e[a]=t[a]=c,c}Y(u=a).forEach(function(d){var h=u[d];if(oe(h))r(d,u[d][0],u[d][1]);else{if(h!=="asap")throw new D.InvalidArgument("Invalid event config");var g=r(d,sn,function(){for(var m=arguments.length,y=new Array(m);m--;)y[m]=arguments[m];g.subscribers.forEach(function(w){sa(function(){w.apply(null,y)})})})}})}}function Nt(n,e){return Ct(e).from({prototype:n}),e}function wt(n,e){return!(n.filter||n.algorithm||n.or)&&(e?n.justLimit:!n.replayFilter)}function vs(n,e){n.filter=ct(n.filter,e)}function ws(n,e,t){var s=n.replayFilter;n.replayFilter=s?()=>ct(s(),e()):e,n.justLimit=t&&!s}function Vn(n,e){if(n.isPrimKey)return e.primaryKey;const t=e.getIndexByKeyPath(n.index);if(!t)throw new D.Schema("KeyPath "+n.index+" on object store "+e.name+" is not indexed");return t}function dr(n,e,t){const s=Vn(n,e.schema);return e.openCursor({trans:t,values:!n.keysOnly,reverse:n.dir==="prev",unique:!!n.unique,query:{index:s,range:n.range}})}function En(n,e,t,s){const i=n.replayFilter?ct(n.filter,n.replayFilter()):n.filter;if(n.or){const r={},a=(l,o,u)=>{if(!i||i(o,u,h=>o.stop(h),h=>o.fail(h))){var c=o.primaryKey,d=""+c;d==="[object ArrayBuffer]"&&(d=""+new Uint8Array(c)),ke(r,d)||(r[d]=!0,e(l,o,u))}};return Promise.all([n.or._iterate(a,t),pr(dr(n,s,t),n.algorithm,a,!n.keysOnly&&n.valueMapper)])}return pr(dr(n,s,t),ct(n.algorithm,i),e,!n.keysOnly&&n.valueMapper)}function pr(n,e,t,s){var i=q(s?(r,a,l)=>t(s(r),a,l):t);return n.then(r=>{if(r)return r.start(()=>{var a=()=>r.continue();e&&!e(r,l=>a=l,l=>{r.stop(l),a=V},l=>{r.fail(l),a=V})||i(r.value,r,l=>a=l),a()})})}function he(n,e){try{const t=fr(n),s=fr(e);if(t!==s)return t==="Array"?1:s==="Array"?-1:t==="binary"?1:s==="binary"?-1:t==="string"?1:s==="string"?-1:t==="Date"?1:s!=="Date"?NaN:-1;switch(t){case"number":case"Date":case"string":return n>e?1:n<e?-1:0;case"binary":return function(i,r){const a=i.length,l=r.length,o=a<l?a:l;for(let u=0;u<o;++u)if(i[u]!==r[u])return i[u]<r[u]?-1:1;return a===l?0:a<l?-1:1}(gr(n),gr(e));case"Array":return function(i,r){const a=i.length,l=r.length,o=a<l?a:l;for(let u=0;u<o;++u){const c=he(i[u],r[u]);if(c!==0)return c}return a===l?0:a<l?-1:1}(n,e)}}catch{}return NaN}function fr(n){const e=typeof n;if(e!=="object")return e;if(ArrayBuffer.isView(n))return"binary";const t=Bs(n);return t==="ArrayBuffer"?"binary":t}function gr(n){return n instanceof Uint8Array?n:ArrayBuffer.isView(n)?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):new Uint8Array(n)}class Po{_read(e,t){var s=this._ctx;return s.error?s.table._trans(null,Q.bind(null,s.error)):s.table._trans("readonly",e).then(t)}_write(e){var t=this._ctx;return t.error?t.table._trans(null,Q.bind(null,t.error)):t.table._trans("readwrite",e,"locked")}_addAlgorithm(e){var t=this._ctx;t.algorithm=ct(t.algorithm,e)}_iterate(e,t){return En(this._ctx,e,t,this._ctx.table.core)}clone(e){var t=Object.create(this.constructor.prototype),s=Object.create(this._ctx);return e&&pe(s,e),t._ctx=s,t}raw(){return this._ctx.valueMapper=null,this}each(e){var t=this._ctx;return this._read(s=>En(t,e,s,t.table.core))}count(e){return this._read(t=>{const s=this._ctx,i=s.table.core;if(wt(s,!0))return i.count({trans:t,query:{index:Vn(s,i.schema),range:s.range}}).then(a=>Math.min(a,s.limit));var r=0;return En(s,()=>(++r,!1),t,i).then(()=>r)}).then(e)}sortBy(e,t){const s=e.split(".").reverse(),i=s[0],r=s.length-1;function a(u,c){return c?a(u[s[c]],c-1):u[i]}var l=this._ctx.dir==="next"?1:-1;function o(u,c){var d=a(u,r),h=a(c,r);return d<h?-l:d>h?l:0}return this.toArray(function(u){return u.sort(o)}).then(t)}toArray(e){return this._read(t=>{var s=this._ctx;if(s.dir==="next"&&wt(s,!0)&&s.limit>0){const{valueMapper:i}=s,r=Vn(s,s.table.core.schema);return s.table.core.query({trans:t,limit:s.limit,values:!0,query:{index:r,range:s.range}}).then(({result:a})=>i?a.map(i):a)}{const i=[];return En(s,r=>i.push(r),t,s.table.core).then(()=>i)}},e)}offset(e){var t=this._ctx;return e<=0||(t.offset+=e,wt(t)?ws(t,()=>{var s=e;return(i,r)=>s===0||(s===1?(--s,!1):(r(()=>{i.advance(s),s=0}),!1))}):ws(t,()=>{var s=e;return()=>--s<0})),this}limit(e){return this._ctx.limit=Math.min(this._ctx.limit,e),ws(this._ctx,()=>{var t=e;return function(s,i,r){return--t<=0&&i(r),t>=0}},!0),this}until(e,t){return vs(this._ctx,function(s,i,r){return!e(s.value)||(i(r),t)}),this}first(e){return this.limit(1).toArray(function(t){return t[0]}).then(e)}last(e){return this.reverse().first(e)}filter(e){var t,s;return vs(this._ctx,function(i){return e(i.value)}),t=this._ctx,s=e,t.isMatch=ct(t.isMatch,s),this}and(e){return this.filter(e)}or(e){return new this.db.WhereClause(this._ctx.table,e,this)}reverse(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this}desc(){return this.reverse()}eachKey(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(s,i){e(i.key,i)})}eachUniqueKey(e){return this._ctx.unique="unique",this.eachKey(e)}eachPrimaryKey(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(s,i){e(i.primaryKey,i)})}keys(e){var t=this._ctx;t.keysOnly=!t.isMatch;var s=[];return this.each(function(i,r){s.push(r.key)}).then(function(){return s}).then(e)}primaryKeys(e){var t=this._ctx;if(t.dir==="next"&&wt(t,!0)&&t.limit>0)return this._read(i=>{var r=Vn(t,t.table.core.schema);return t.table.core.query({trans:i,values:!1,limit:t.limit,query:{index:r,range:t.range}})}).then(({result:i})=>i).then(e);t.keysOnly=!t.isMatch;var s=[];return this.each(function(i,r){s.push(r.primaryKey)}).then(function(){return s}).then(e)}uniqueKeys(e){return this._ctx.unique="unique",this.keys(e)}firstKey(e){return this.limit(1).keys(function(t){return t[0]}).then(e)}lastKey(e){return this.reverse().firstKey(e)}distinct(){var e=this._ctx,t=e.index&&e.table.schema.idxByName[e.index];if(!t||!t.multi)return this;var s={};return vs(this._ctx,function(i){var r=i.primaryKey.toString(),a=ke(s,r);return s[r]=!0,!a}),this}modify(e){var t=this._ctx;return this._write(s=>{var i;if(typeof e=="function")i=e;else{var r=Y(e),a=r.length;i=function(y){for(var w=!1,b=0;b<a;++b){var k=r[b],S=e[k];Fe(y,k)!==S&&(Se(y,k,S),w=!0)}return w}}const l=t.table.core,{outbound:o,extractKey:u}=l.schema.primaryKey,c=this.db._options.modifyChunkSize||200,d=[];let h=0;const g=[],m=(y,w)=>{const{failures:b,numFailures:k}=w;h+=y-k;for(let S of Y(b))d.push(b[S])};return this.clone().primaryKeys().then(y=>{const w=b=>{const k=Math.min(c,y.length-b);return l.getMany({trans:s,keys:y.slice(b,b+k),cache:"immutable"}).then(S=>{const x=[],C=[],I=o?[]:null,v=[];for(let E=0;E<k;++E){const B=S[E],L={value:un(B),primKey:y[b+E]};i.call(L,L.value,L)!==!1&&(L.value==null?v.push(y[b+E]):o||he(u(B),u(L.value))===0?(C.push(L.value),o&&I.push(y[b+E])):(v.push(y[b+E]),x.push(L.value)))}const O=wt(t)&&t.limit===1/0&&(typeof e!="function"||e===xs)&&{index:t.index,range:t.range};return Promise.resolve(x.length>0&&l.mutate({trans:s,type:"add",values:x}).then(E=>{for(let B in E.failures)v.splice(parseInt(B),1);m(x.length,E)})).then(()=>(C.length>0||O&&typeof e=="object")&&l.mutate({trans:s,type:"put",keys:I,values:C,criteria:O,changeSpec:typeof e!="function"&&e}).then(E=>m(C.length,E))).then(()=>(v.length>0||O&&e===xs)&&l.mutate({trans:s,type:"delete",keys:v,criteria:O}).then(E=>m(v.length,E))).then(()=>y.length>b+k&&w(b+c))})};return w(0).then(()=>{if(d.length>0)throw new qn("Error modifying one or more objects",d,h,g);return y.length})})})}delete(){var e=this._ctx,t=e.range;return wt(e)&&(e.isPrimKey&&!_o||t.type===3)?this._write(s=>{const{primaryKey:i}=e.table.core.schema,r=t;return e.table.core.count({trans:s,query:{index:i,range:r}}).then(a=>e.table.core.mutate({trans:s,type:"deleteRange",range:r}).then(({failures:l,lastResult:o,results:u,numFailures:c})=>{if(c)throw new qn("Could not delete some values",Object.keys(l).map(d=>l[d]),a-c);return a-c}))}):this.modify(xs)}}const xs=(n,e)=>e.value=null;function Ro(n,e){return n<e?-1:n===e?0:1}function Lo(n,e){return n>e?-1:n===e?0:1}function ye(n,e,t){var s=n instanceof Ea?new n.Collection(n):n;return s._ctx.error=t?new t(e):new TypeError(e),s}function xt(n){return new n.Collection(n,()=>Ta("")).limit(0)}function Oo(n,e,t,s,i,r){for(var a=Math.min(n.length,s.length),l=-1,o=0;o<a;++o){var u=e[o];if(u!==s[o])return i(n[o],t[o])<0?n.substr(0,o)+t[o]+t.substr(o+1):i(n[o],s[o])<0?n.substr(0,o)+s[o]+t.substr(o+1):l>=0?n.substr(0,l)+e[l]+t.substr(l+1):null;i(n[o],u)<0&&(l=o)}return a<s.length&&r==="next"?n+t.substr(n.length):a<n.length&&r==="prev"?n.substr(0,t.length):l<0?null:n.substr(0,l)+s[l]+t.substr(l+1)}function Cn(n,e,t,s){var i,r,a,l,o,u,c,d=t.length;if(!t.every(y=>typeof y=="string"))return ye(n,wa);function h(y){i=function(b){return b==="next"?k=>k.toUpperCase():k=>k.toLowerCase()}(y),r=function(b){return b==="next"?k=>k.toLowerCase():k=>k.toUpperCase()}(y),a=y==="next"?Ro:Lo;var w=t.map(function(b){return{lower:r(b),upper:i(b)}}).sort(function(b,k){return a(b.lower,k.lower)});l=w.map(function(b){return b.upper}),o=w.map(function(b){return b.lower}),u=y,c=y==="next"?"":s}h("next");var g=new n.Collection(n,()=>je(l[0],o[d-1]+s));g._ondirectionchange=function(y){h(y)};var m=0;return g._addAlgorithm(function(y,w,b){var k=y.key;if(typeof k!="string")return!1;var S=r(k);if(e(S,o,m))return!0;for(var x=null,C=m;C<d;++C){var I=Oo(k,S,l[C],o[C],a,u);I===null&&x===null?m=C+1:(x===null||a(x,I)>0)&&(x=I)}return w(x!==null?function(){y.continue(x+c)}:b),!1}),g}function je(n,e,t,s){return{type:2,lower:n,upper:e,lowerOpen:t,upperOpen:s}}function Ta(n){return{type:1,lower:n,upper:n}}class Ea{get Collection(){return this._ctx.table.db.Collection}between(e,t,s,i){s=s!==!1,i=i===!0;try{return this._cmp(e,t)>0||this._cmp(e,t)===0&&(s||i)&&(!s||!i)?xt(this):new this.Collection(this,()=>je(e,t,!s,!i))}catch{return ye(this,Oe)}}equals(e){return e==null?ye(this,Oe):new this.Collection(this,()=>Ta(e))}above(e){return e==null?ye(this,Oe):new this.Collection(this,()=>je(e,void 0,!0))}aboveOrEqual(e){return e==null?ye(this,Oe):new this.Collection(this,()=>je(e,void 0,!1))}below(e){return e==null?ye(this,Oe):new this.Collection(this,()=>je(void 0,e,!1,!0))}belowOrEqual(e){return e==null?ye(this,Oe):new this.Collection(this,()=>je(void 0,e))}startsWith(e){return typeof e!="string"?ye(this,wa):this.between(e,e+it,!0,!0)}startsWithIgnoreCase(e){return e===""?this.startsWith(e):Cn(this,(t,s)=>t.indexOf(s[0])===0,[e],it)}equalsIgnoreCase(e){return Cn(this,(t,s)=>t===s[0],[e],"")}anyOfIgnoreCase(){var e=Me.apply(Et,arguments);return e.length===0?xt(this):Cn(this,(t,s)=>s.indexOf(t)!==-1,e,"")}startsWithAnyOfIgnoreCase(){var e=Me.apply(Et,arguments);return e.length===0?xt(this):Cn(this,(t,s)=>s.some(i=>t.indexOf(i)===0),e,it)}anyOf(){const e=Me.apply(Et,arguments);let t=this._cmp;try{e.sort(t)}catch{return ye(this,Oe)}if(e.length===0)return xt(this);const s=new this.Collection(this,()=>je(e[0],e[e.length-1]));s._ondirectionchange=r=>{t=r==="next"?this._ascending:this._descending,e.sort(t)};let i=0;return s._addAlgorithm((r,a,l)=>{const o=r.key;for(;t(o,e[i])>0;)if(++i,i===e.length)return a(l),!1;return t(o,e[i])===0||(a(()=>{r.continue(e[i])}),!1)}),s}notEqual(e){return this.inAnyRange([[Zs,e],[e,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})}noneOf(){const e=Me.apply(Et,arguments);if(e.length===0)return new this.Collection(this);try{e.sort(this._ascending)}catch{return ye(this,Oe)}const t=e.reduce((s,i)=>s?s.concat([[s[s.length-1][1],i]]):[[Zs,i]],null);return t.push([e[e.length-1],this.db._maxKey]),this.inAnyRange(t,{includeLowers:!1,includeUppers:!1})}inAnyRange(e,t){const s=this._cmp,i=this._ascending,r=this._descending,a=this._min,l=this._max;if(e.length===0)return xt(this);if(!e.every(k=>k[0]!==void 0&&k[1]!==void 0&&i(k[0],k[1])<=0))return ye(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",D.InvalidArgument);const o=!t||t.includeLowers!==!1,u=t&&t.includeUppers===!0;let c,d=i;function h(k,S){return d(k[0],S[0])}try{c=e.reduce(function(k,S){let x=0,C=k.length;for(;x<C;++x){const I=k[x];if(s(S[0],I[1])<0&&s(S[1],I[0])>0){I[0]=a(I[0],S[0]),I[1]=l(I[1],S[1]);break}}return x===C&&k.push(S),k},[]),c.sort(h)}catch{return ye(this,Oe)}let g=0;const m=u?k=>i(k,c[g][1])>0:k=>i(k,c[g][1])>=0,y=o?k=>r(k,c[g][0])>0:k=>r(k,c[g][0])>=0;let w=m;const b=new this.Collection(this,()=>je(c[0][0],c[c.length-1][1],!o,!u));return b._ondirectionchange=k=>{k==="next"?(w=m,d=i):(w=y,d=r),c.sort(h)},b._addAlgorithm((k,S,x)=>{for(var C=k.key;w(C);)if(++g,g===c.length)return S(x),!1;return!!function(I){return!m(I)&&!y(I)}(C)||(this._cmp(C,c[g][1])===0||this._cmp(C,c[g][0])===0||S(()=>{d===i?k.continue(c[g][0]):k.continue(c[g][1])}),!1)}),b}startsWithAnyOf(){const e=Me.apply(Et,arguments);return e.every(t=>typeof t=="string")?e.length===0?xt(this):this.inAnyRange(e.map(t=>[t,t+it])):ye(this,"startsWithAnyOf() only works with strings")}}function _e(n){return q(function(e){return an(e),n(e.target.error),!1})}function an(n){n.stopPropagation&&n.stopPropagation(),n.preventDefault&&n.preventDefault()}const on="storagemutated",Ye="x-storagemutated-1",Qe=Jt(null,on);class Do{_lock(){return jt(!R.global),++this._reculock,this._reculock!==1||R.global||(R.lockOwnerFor=this),this}_unlock(){if(jt(!R.global),--this._reculock==0)for(R.global||(R.lockOwnerFor=null);this._blockedFuncs.length>0&&!this._locked();){var e=this._blockedFuncs.shift();try{Ot(e[1],e[0])}catch{}}return this}_locked(){return this._reculock&&R.lockOwnerFor!==this}create(e){if(!this.mode)return this;const t=this.db.idbdb,s=this.db._state.dbOpenError;if(jt(!this.idbtrans),!e&&!t)switch(s&&s.name){case"DatabaseClosedError":throw new D.DatabaseClosed(s);case"MissingAPIError":throw new D.MissingAPI(s.message,s);default:throw new D.OpenFailed(s)}if(!this.active)throw new D.TransactionInactive;return jt(this._completion._state===null),(e=this.idbtrans=e||(this.db.core?this.db.core.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}):t.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}))).onerror=q(i=>{an(i),this._reject(e.error)}),e.onabort=q(i=>{an(i),this.active&&this._reject(new D.Abort(e.error)),this.active=!1,this.on("abort").fire(i)}),e.oncomplete=q(()=>{this.active=!1,this._resolve(),"mutatedParts"in e&&Qe.storagemutated.fire(e.mutatedParts)}),this}_promise(e,t,s){if(e==="readwrite"&&this.mode!=="readwrite")return Q(new D.ReadOnly("Transaction is readonly"));if(!this.active)return Q(new D.TransactionInactive);if(this._locked())return new _((r,a)=>{this._blockedFuncs.push([()=>{this._promise(e,t,s).then(r,a)},R])});if(s)return Ze(()=>{var r=new _((a,l)=>{this._lock();const o=t(a,l,this);o&&o.then&&o.then(a,l)});return r.finally(()=>this._unlock()),r._lib=!0,r});var i=new _((r,a)=>{var l=t(r,a,this);l&&l.then&&l.then(r,a)});return i._lib=!0,i}_root(){return this.parent?this.parent._root():this}waitFor(e){var t=this._root();const s=_.resolve(e);if(t._waitingFor)t._waitingFor=t._waitingFor.then(()=>s);else{t._waitingFor=s,t._waitingQueue=[];var i=t.idbtrans.objectStore(t.storeNames[0]);(function a(){for(++t._spinCount;t._waitingQueue.length;)t._waitingQueue.shift()();t._waitingFor&&(i.get(-1/0).onsuccess=a)})()}var r=t._waitingFor;return new _((a,l)=>{s.then(o=>t._waitingQueue.push(q(a.bind(null,o))),o=>t._waitingQueue.push(q(l.bind(null,o)))).finally(()=>{t._waitingFor===r&&(t._waitingFor=null)})})}abort(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new D.Abort))}table(e){const t=this._memoizedTables||(this._memoizedTables={});if(ke(t,e))return t[e];const s=this.schema[e];if(!s)throw new D.NotFound("Table "+e+" not part of transaction");const i=new this.db.Table(e,s,this);return i.core=this.db.core.table(e),t[e]=i,i}}function Xs(n,e,t,s,i,r,a){return{name:n,keyPath:e,unique:t,multi:s,auto:i,compound:r,src:(t&&!a?"&":"")+(s?"*":"")+(i?"++":"")+Ca(e)}}function Ca(n){return typeof n=="string"?n:n?"["+[].join.call(n,"+")+"]":""}function Ia(n,e,t){return{name:n,primKey:e,indexes:t,mappedClass:null,idxByName:ia(t,s=>[s.name,s])}}let ln=n=>{try{return n.only([[]]),ln=()=>[[]],[[]]}catch{return ln=()=>it,it}};function Qs(n){return n==null?()=>{}:typeof n=="string"?function(e){return e.split(".").length===1?s=>s[e]:s=>Fe(s,e)}(n):e=>Fe(e,n)}function mr(n){return[].slice.call(n)}let $o=0;function en(n){return n==null?":id":typeof n=="string"?n:`[${n.join("+")}]`}function Mo(n,e,t){function s(o){if(o.type===3)return null;if(o.type===4)throw new Error("Cannot convert never type to IDBKeyRange");const{lower:u,upper:c,lowerOpen:d,upperOpen:h}=o;return u===void 0?c===void 0?null:e.upperBound(c,!!h):c===void 0?e.lowerBound(u,!!d):e.bound(u,c,!!d,!!h)}const{schema:i,hasGetAll:r}=function(o,u){const c=mr(o.objectStoreNames);return{schema:{name:o.name,tables:c.map(d=>u.objectStore(d)).map(d=>{const{keyPath:h,autoIncrement:g}=d,m=oe(h),y=h==null,w={},b={name:d.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:y,compound:m,keyPath:h,autoIncrement:g,unique:!0,extractKey:Qs(h)},indexes:mr(d.indexNames).map(k=>d.index(k)).map(k=>{const{name:S,unique:x,multiEntry:C,keyPath:I}=k,v={name:S,compound:oe(I),keyPath:I,unique:x,multiEntry:C,extractKey:Qs(I)};return w[en(I)]=v,v}),getIndexByKeyPath:k=>w[en(k)]};return w[":id"]=b.primaryKey,h!=null&&(w[en(h)]=b.primaryKey),b})},hasGetAll:c.length>0&&"getAll"in u.objectStore(c[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}}(n,t),a=i.tables.map(o=>function(u){const c=u.name;return{name:c,schema:u,mutate:function({trans:d,type:h,keys:g,values:m,range:y}){return new Promise((w,b)=>{w=q(w);const k=d.objectStore(c),S=k.keyPath==null,x=h==="put"||h==="add";if(!x&&h!=="delete"&&h!=="deleteRange")throw new Error("Invalid operation type: "+h);const{length:C}=g||m||{length:1};if(g&&m&&g.length!==m.length)throw new Error("Given keys array must have same length as given values array.");if(C===0)return w({numFailures:0,failures:{},results:[],lastResult:void 0});let I;const v=[],O=[];let E=0;const B=j=>{++E,an(j)};if(h==="deleteRange"){if(y.type===4)return w({numFailures:E,failures:O,results:[],lastResult:void 0});y.type===3?v.push(I=k.clear()):v.push(I=k.delete(s(y)))}else{const[j,z]=x?S?[m,g]:[m,null]:[g,null];if(x)for(let H=0;H<C;++H)v.push(I=z&&z[H]!==void 0?k[h](j[H],z[H]):k[h](j[H])),I.onerror=B;else for(let H=0;H<C;++H)v.push(I=k[h](j[H])),I.onerror=B}const L=j=>{const z=j.target.result;v.forEach((H,He)=>H.error!=null&&(O[He]=H.error)),w({numFailures:E,failures:O,results:h==="delete"?g:v.map(H=>H.result),lastResult:z})};I.onerror=j=>{B(j),L(j)},I.onsuccess=L})},getMany:({trans:d,keys:h})=>new Promise((g,m)=>{g=q(g);const y=d.objectStore(c),w=h.length,b=new Array(w);let k,S=0,x=0;const C=v=>{const O=v.target;b[O._pos]=O.result,++x===S&&g(b)},I=_e(m);for(let v=0;v<w;++v)h[v]!=null&&(k=y.get(h[v]),k._pos=v,k.onsuccess=C,k.onerror=I,++S);S===0&&g(b)}),get:({trans:d,key:h})=>new Promise((g,m)=>{g=q(g);const y=d.objectStore(c).get(h);y.onsuccess=w=>g(w.target.result),y.onerror=_e(m)}),query:function(d){return h=>new Promise((g,m)=>{g=q(g);const{trans:y,values:w,limit:b,query:k}=h,S=b===1/0?void 0:b,{index:x,range:C}=k,I=y.objectStore(c),v=x.isPrimaryKey?I:I.index(x.name),O=s(C);if(b===0)return g({result:[]});if(d){const E=w?v.getAll(O,S):v.getAllKeys(O,S);E.onsuccess=B=>g({result:B.target.result}),E.onerror=_e(m)}else{let E=0;const B=w||!("openKeyCursor"in v)?v.openCursor(O):v.openKeyCursor(O),L=[];B.onsuccess=j=>{const z=B.result;return z?(L.push(w?z.value:z.primaryKey),++E===b?g({result:L}):void z.continue()):g({result:L})},B.onerror=_e(m)}})}(r),openCursor:function({trans:d,values:h,query:g,reverse:m,unique:y}){return new Promise((w,b)=>{w=q(w);const{index:k,range:S}=g,x=d.objectStore(c),C=k.isPrimaryKey?x:x.index(k.name),I=m?y?"prevunique":"prev":y?"nextunique":"next",v=h||!("openKeyCursor"in C)?C.openCursor(s(S),I):C.openKeyCursor(s(S),I);v.onerror=_e(b),v.onsuccess=q(O=>{const E=v.result;if(!E)return void w(null);E.___id=++$o,E.done=!1;const B=E.continue.bind(E);let L=E.continuePrimaryKey;L&&(L=L.bind(E));const j=E.advance.bind(E),z=()=>{throw new Error("Cursor not stopped")};E.trans=d,E.stop=E.continue=E.continuePrimaryKey=E.advance=()=>{throw new Error("Cursor not started")},E.fail=q(b),E.next=function(){let H=1;return this.start(()=>H--?this.continue():this.stop()).then(()=>this)},E.start=H=>{const He=new Promise((ie,Te)=>{ie=q(ie),v.onerror=_e(Te),E.fail=Te,E.stop=Je=>{E.stop=E.continue=E.continuePrimaryKey=E.advance=z,ie(Je)}}),We=()=>{if(v.result)try{H()}catch(ie){E.fail(ie)}else E.done=!0,E.start=()=>{throw new Error("Cursor behind last entry")},E.stop()};return v.onsuccess=q(ie=>{v.onsuccess=We,We()}),E.continue=B,E.continuePrimaryKey=L,E.advance=j,We(),He},w(E)},b)})},count({query:d,trans:h}){const{index:g,range:m}=d;return new Promise((y,w)=>{const b=h.objectStore(c),k=g.isPrimaryKey?b:b.index(g.name),S=s(m),x=S?k.count(S):k.count();x.onsuccess=q(C=>y(C.target.result)),x.onerror=_e(w)})}}}(o)),l={};return a.forEach(o=>l[o.name]=o),{stack:"dbcore",transaction:n.transaction.bind(n),table(o){if(!l[o])throw new Error(`Table '${o}' not found`);return l[o]},MIN_KEY:-1/0,MAX_KEY:ln(e),schema:i}}function Js({_novip:n},e){const t=e.db,s=function(i,r,{IDBKeyRange:a,indexedDB:l},o){return{dbcore:function(c,d){return d.reduce((h,{create:g})=>({...h,...g(h)}),c)}(Mo(r,a,o),i.dbcore)}}(n._middlewares,t,n._deps,e);n.core=s.dbcore,n.tables.forEach(i=>{const r=i.name;n.core.schema.tables.some(a=>a.name===r)&&(i.core=n.core.table(r),n[r]instanceof n.Table&&(n[r].core=i.core))})}function Zn({_novip:n},e,t,s){t.forEach(i=>{const r=s[i];e.forEach(a=>{const l=yi(a,i);(!l||"value"in l&&l.value===void 0)&&(a===n.Transaction.prototype||a instanceof n.Transaction?Be(a,i,{get(){return this.table(i)},set(o){ta(this,i,{value:o,writable:!0,configurable:!0,enumerable:!0})}}):a[i]=new n.Table(i,r))})})}function ei({_novip:n},e){e.forEach(t=>{for(let s in t)t[s]instanceof n.Table&&delete t[s]})}function No(n,e){return n._cfg.version-e._cfg.version}function Bo(n,e,t,s){const i=n._dbSchema,r=n._createTransaction("readwrite",n._storeNames,i);r.create(t),r._completion.catch(s);const a=r._reject.bind(r),l=R.transless||R;Ze(()=>{R.trans=r,R.transless=l,e===0?(Y(i).forEach(o=>{Ss(t,o,i[o].primKey,i[o].indexes)}),Js(n,t),_.follow(()=>n.on.populate.fire(r)).catch(a)):function({_novip:o},u,c,d){const h=[],g=o._versions;let m=o._dbSchema=ni(o,o.idbdb,d),y=!1;const w=g.filter(k=>k._cfg.version>=u);function b(){return h.length?_.resolve(h.shift()(c.idbtrans)).then(b):_.resolve()}return w.forEach(k=>{h.push(()=>{const S=m,x=k._cfg.dbschema;si(o,S,d),si(o,x,d),m=o._dbSchema=x;const C=_a(S,x);C.add.forEach(v=>{Ss(d,v[0],v[1].primKey,v[1].indexes)}),C.change.forEach(v=>{if(v.recreate)throw new D.Upgrade("Not yet support for changing primary key");{const O=d.objectStore(v.name);v.add.forEach(E=>ti(O,E)),v.change.forEach(E=>{O.deleteIndex(E.name),ti(O,E)}),v.del.forEach(E=>O.deleteIndex(E))}});const I=k._cfg.contentUpgrade;if(I&&k._cfg.version>u){Js(o,d),c._memoizedTables={},y=!0;let v=ra(x);C.del.forEach(L=>{v[L]=S[L]}),ei(o,[o.Transaction.prototype]),Zn(o,[o.Transaction.prototype],Y(v),v),c.schema=v;const O=ki(I);let E;O&&Lt();const B=_.follow(()=>{if(E=I(c),E&&O){var L=Ve.bind(null,null);E.then(L,L)}});return E&&typeof E.then=="function"?_.resolve(E):B.then(()=>E)}}),h.push(S=>{(!y||!Io)&&function(x,C){[].slice.call(C.db.objectStoreNames).forEach(I=>x[I]==null&&C.db.deleteObjectStore(I))}(k._cfg.dbschema,S),ei(o,[o.Transaction.prototype]),Zn(o,[o.Transaction.prototype],o._storeNames,o._dbSchema),c.schema=o._dbSchema})}),b().then(()=>{var k,S;S=d,Y(k=m).forEach(x=>{S.db.objectStoreNames.contains(x)||Ss(S,x,k[x].primKey,k[x].indexes)})})}(n,e,r,t).catch(a)})}function _a(n,e){const t={del:[],add:[],change:[]};let s;for(s in n)e[s]||t.del.push(s);for(s in e){const i=n[s],r=e[s];if(i){const a={name:s,def:r,recreate:!1,del:[],add:[],change:[]};if(""+(i.primKey.keyPath||"")!=""+(r.primKey.keyPath||"")||i.primKey.auto!==r.primKey.auto&&!ts)a.recreate=!0,t.change.push(a);else{const l=i.idxByName,o=r.idxByName;let u;for(u in l)o[u]||a.del.push(u);for(u in o){const c=l[u],d=o[u];c?c.src!==d.src&&a.change.push(d):a.add.push(d)}(a.del.length>0||a.add.length>0||a.change.length>0)&&t.change.push(a)}}else t.add.push([s,r])}return t}function Ss(n,e,t,s){const i=n.db.createObjectStore(e,t.keyPath?{keyPath:t.keyPath,autoIncrement:t.auto}:{autoIncrement:t.auto});return s.forEach(r=>ti(i,r)),i}function ti(n,e){n.createIndex(e.name,e.keyPath,{unique:e.unique,multiEntry:e.multi})}function ni(n,e,t){const s={};return Un(e.objectStoreNames,0).forEach(i=>{const r=t.objectStore(i);let a=r.keyPath;const l=Xs(Ca(a),a||"",!1,!1,!!r.autoIncrement,a&&typeof a!="string",!0),o=[];for(let c=0;c<r.indexNames.length;++c){const d=r.index(r.indexNames[c]);a=d.keyPath;var u=Xs(d.name,a,!!d.unique,!!d.multiEntry,!1,a&&typeof a!="string",!1);o.push(u)}s[i]=Ia(i,l,o)}),s}function si({_novip:n},e,t){const s=t.db.objectStoreNames;for(let i=0;i<s.length;++i){const r=s[i],a=t.objectStore(r);n._hasGetAll="getAll"in a;for(let l=0;l<a.indexNames.length;++l){const o=a.indexNames[l],u=a.index(o).keyPath,c=typeof u=="string"?u:"["+Un(u).join("+")+"]";if(e[r]){const d=e[r].idxByName[c];d&&(d.name=o,delete e[r].idxByName[c],e[r].idxByName[o]=d)}}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&W.WorkerGlobalScope&&W instanceof W.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(n._hasGetAll=!1)}class Fo{_parseStoresSpec(e,t){Y(e).forEach(s=>{if(e[s]!==null){var i=e[s].split(",").map((a,l)=>{const o=(a=a.trim()).replace(/([&*]|\+\+)/g,""),u=/^\[/.test(o)?o.match(/^\[(.*)\]$/)[1].split("+"):o;return Xs(o,u||null,/\&/.test(a),/\*/.test(a),/\+\+/.test(a),oe(u),l===0)}),r=i.shift();if(r.multi)throw new D.Schema("Primary key cannot be multi-valued");i.forEach(a=>{if(a.auto)throw new D.Schema("Only primary key can be marked as autoIncrement (++)");if(!a.keyPath)throw new D.Schema("Index must have a name and cannot be an empty string")}),t[s]=Ia(s,r,i)}})}stores(e){const t=this.db;this._cfg.storesSource=this._cfg.storesSource?pe(this._cfg.storesSource,e):e;const s=t._versions,i={};let r={};return s.forEach(a=>{pe(i,a._cfg.storesSource),r=a._cfg.dbschema={},a._parseStoresSpec(i,r)}),t._dbSchema=r,ei(t,[t._allTables,t,t.Transaction.prototype]),Zn(t,[t._allTables,t,t.Transaction.prototype,this._cfg.tables],Y(r),r),t._storeNames=Y(r),this}upgrade(e){return this._cfg.contentUpgrade=wi(this._cfg.contentUpgrade||V,e),this}}function Ei(n,e){let t=n._dbNamesDB;return t||(t=n._dbNamesDB=new ot(ns,{addons:[],indexedDB:n,IDBKeyRange:e}),t.version(1).stores({dbnames:"name"})),t.table("dbnames")}function Ci(n){return n&&typeof n.databases=="function"}function ii(n){return Ze(function(){return R.letThrough=!0,n()})}function Vo(){var n;return!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(e){var t=function(){return indexedDB.databases().finally(e)};n=setInterval(t,100),t()}).finally(function(){return clearInterval(n)}):Promise.resolve()}function Ho(n){const e=n._state,{indexedDB:t}=n._deps;if(e.isBeingOpened||n.idbdb)return e.dbReadyPromise.then(()=>e.dbOpenError?Q(e.dbOpenError):n);Ae&&(e.openCanceller._stackHolder=ht()),e.isBeingOpened=!0,e.dbOpenError=null,e.openComplete=!1;const s=e.openCanceller;function i(){if(e.openCanceller!==s)throw new D.DatabaseClosed("db.open() was cancelled")}let r=e.dbReadyResolve,a=null,l=!1;const o=()=>new _((u,c)=>{if(i(),!t)throw new D.MissingAPI;const d=n.name,h=e.autoSchema?t.open(d):t.open(d,Math.round(10*n.verno));if(!h)throw new D.MissingAPI;h.onerror=_e(c),h.onblocked=q(n._fireOnBlocked),h.onupgradeneeded=q(g=>{if(a=h.transaction,e.autoSchema&&!n._options.allowEmptyDB){h.onerror=an,a.abort(),h.result.close();const y=t.deleteDatabase(d);y.onsuccess=y.onerror=q(()=>{c(new D.NoSuchDatabase(`Database ${d} doesnt exist`))})}else{a.onerror=_e(c);var m=g.oldVersion>Math.pow(2,62)?0:g.oldVersion;l=m<1,n._novip.idbdb=h.result,Bo(n,m/10,a,c)}},c),h.onsuccess=q(()=>{a=null;const g=n._novip.idbdb=h.result,m=Un(g.objectStoreNames);if(m.length>0)try{const w=g.transaction((y=m).length===1?y[0]:y,"readonly");e.autoSchema?function({_novip:b},k,S){b.verno=k.version/10;const x=b._dbSchema=ni(0,k,S);b._storeNames=Un(k.objectStoreNames,0),Zn(b,[b._allTables],Y(x),x)}(n,g,w):(si(n,n._dbSchema,w),function(b,k){const S=_a(ni(0,b.idbdb,k),b._dbSchema);return!(S.add.length||S.change.some(x=>x.add.length||x.change.length))}(n,w)||console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Some queries may fail.")),Js(n,w)}catch{}var y;Qt.push(n),g.onversionchange=q(w=>{e.vcFired=!0,n.on("versionchange").fire(w)}),g.onclose=q(w=>{n.on("close").fire(w)}),l&&function({indexedDB:w,IDBKeyRange:b},k){!Ci(w)&&k!==ns&&Ei(w,b).put({name:k}).catch(V)}(n._deps,d),u()},c)}).catch(u=>u&&u.name==="UnknownError"&&e.PR1398_maxLoop>0?(e.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),o()):_.reject(u));return _.race([s,(typeof navigator>"u"?_.resolve():Vo()).then(o)]).then(()=>(i(),e.onReadyBeingFired=[],_.resolve(ii(()=>n.on.ready.fire(n.vip))).then(function u(){if(e.onReadyBeingFired.length>0){let c=e.onReadyBeingFired.reduce(wi,V);return e.onReadyBeingFired=[],_.resolve(ii(()=>c(n.vip))).then(u)}}))).finally(()=>{e.onReadyBeingFired=null,e.isBeingOpened=!1}).then(()=>n).catch(u=>{e.dbOpenError=u;try{a&&a.abort()}catch{}return s===e.openCanceller&&n._close(),Q(u)}).finally(()=>{e.openComplete=!0,r()})}function ri(n){var e=r=>n.next(r),t=i(e),s=i(r=>n.throw(r));function i(r){return a=>{var l=r(a),o=l.value;return l.done?o:o&&typeof o.then=="function"?o.then(t,s):oe(o)?Promise.all(o).then(t,s):t(o)}}return i(e)()}function Wo(n,e,t){var s=arguments.length;if(s<2)throw new D.InvalidArgument("Too few arguments");for(var i=new Array(s-1);--s;)i[s-1]=arguments[s];return t=i.pop(),[n,aa(i),t]}function Aa(n,e,t,s,i){return _.resolve().then(()=>{const r=R.transless||R,a=n._createTransaction(e,t,n._dbSchema,s),l={trans:a,transless:r};if(s)a.idbtrans=s.idbtrans;else try{a.create(),n._state.PR1398_maxLoop=3}catch(d){return d.name===vi.InvalidState&&n.isOpen()&&--n._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),n._close(),n.open().then(()=>Aa(n,e,t,null,i))):Q(d)}const o=ki(i);let u;o&&Lt();const c=_.follow(()=>{if(u=i.call(a,a),u)if(o){var d=Ve.bind(null,null);u.then(d,d)}else typeof u.next=="function"&&typeof u.throw=="function"&&(u=ri(u))},l);return(u&&typeof u.then=="function"?_.resolve(u).then(d=>a.active?d:Q(new D.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))):c.then(()=>u)).then(d=>(s&&a._resolve(),a._completion.then(()=>d))).catch(d=>(a._reject(d),Q(d)))})}function In(n,e,t){const s=oe(n)?n.slice():[n];for(let i=0;i<t;++i)s.push(e);return s}const zo={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(n){return{...n,table(e){const t=n.table(e),{schema:s}=t,i={},r=[];function a(c,d,h){const g=en(c),m=i[g]=i[g]||[],y=c==null?0:typeof c=="string"?1:c.length,w=d>0,b={...h,isVirtual:w,keyTail:d,keyLength:y,extractKey:Qs(c),unique:!w&&h.unique};return m.push(b),b.isPrimaryKey||r.push(b),y>1&&a(y===2?c[0]:c.slice(0,y-1),d+1,h),m.sort((k,S)=>k.keyTail-S.keyTail),b}const l=a(s.primaryKey.keyPath,0,s.primaryKey);i[":id"]=[l];for(const c of s.indexes)a(c.keyPath,0,c);function o(c){const d=c.query.index;return d.isVirtual?{...c,query:{index:d,range:(h=c.query.range,g=d.keyTail,{type:h.type===1?2:h.type,lower:In(h.lower,h.lowerOpen?n.MAX_KEY:n.MIN_KEY,g),lowerOpen:!0,upper:In(h.upper,h.upperOpen?n.MIN_KEY:n.MAX_KEY,g),upperOpen:!0})}}:c;var h,g}return{...t,schema:{...s,primaryKey:l,indexes:r,getIndexByKeyPath:function(c){const d=i[en(c)];return d&&d[0]}},count:c=>t.count(o(c)),query:c=>t.query(o(c)),openCursor(c){const{keyTail:d,isVirtual:h,keyLength:g}=c.query.index;return h?t.openCursor(o(c)).then(m=>m&&function(y){return Object.create(y,{continue:{value:function(b){b!=null?y.continue(In(b,c.reverse?n.MAX_KEY:n.MIN_KEY,d)):c.unique?y.continue(y.key.slice(0,g).concat(c.reverse?n.MIN_KEY:n.MAX_KEY,d)):y.continue()}},continuePrimaryKey:{value(b,k){y.continuePrimaryKey(In(b,n.MAX_KEY,d),k)}},primaryKey:{get:()=>y.primaryKey},key:{get(){const b=y.key;return g===1?b[0]:b.slice(0,g)}},value:{get:()=>y.value}})}(m)):t.openCursor(c)}}}}}};function Ii(n,e,t,s){return t=t||{},s=s||"",Y(n).forEach(i=>{if(ke(e,i)){var r=n[i],a=e[i];if(typeof r=="object"&&typeof a=="object"&&r&&a){const l=Bs(r);l!==Bs(a)?t[s+i]=e[i]:l==="Object"?Ii(r,a,t,s+i+"."):r!==a&&(t[s+i]=e[i])}else r!==a&&(t[s+i]=e[i])}else t[s+i]=void 0}),Y(e).forEach(i=>{ke(n,i)||(t[s+i]=e[i])}),t}const Uo={stack:"dbcore",name:"HooksMiddleware",level:2,create:n=>({...n,table(e){const t=n.table(e),{primaryKey:s}=t.schema;return{...t,mutate(r){const a=R.trans,{deleting:l,creating:o,updating:u}=a.table(e).hook;switch(r.type){case"add":if(o.fire===V)break;return a._promise("readwrite",()=>c(r),!0);case"put":if(o.fire===V&&u.fire===V)break;return a._promise("readwrite",()=>c(r),!0);case"delete":if(l.fire===V)break;return a._promise("readwrite",()=>c(r),!0);case"deleteRange":if(l.fire===V)break;return a._promise("readwrite",()=>function(h){return d(h.trans,h.range,1e4)}(r),!0)}return t.mutate(r);function c(h){const g=R.trans,m=h.keys||function(y,w){return w.type==="delete"?w.keys:w.keys||w.values.map(y.extractKey)}(s,h);if(!m)throw new Error("Keys missing");return(h=h.type==="add"||h.type==="put"?{...h,keys:m}:{...h}).type!=="delete"&&(h.values=[...h.values]),h.keys&&(h.keys=[...h.keys]),function(y,w,b){return w.type==="add"?Promise.resolve([]):y.getMany({trans:w.trans,keys:b,cache:"immutable"})}(t,h,m).then(y=>{const w=m.map((b,k)=>{const S=y[k],x={onerror:null,onsuccess:null};if(h.type==="delete")l.fire.call(x,b,S,g);else if(h.type==="add"||S===void 0){const C=o.fire.call(x,b,h.values[k],g);b==null&&C!=null&&(b=C,h.keys[k]=b,s.outbound||Se(h.values[k],s.keyPath,b))}else{const C=Ii(S,h.values[k]),I=u.fire.call(x,C,b,S,g);if(I){const v=h.values[k];Object.keys(I).forEach(O=>{ke(v,O)?v[O]=I[O]:Se(v,O,I[O])})}}return x});return t.mutate(h).then(({failures:b,results:k,numFailures:S,lastResult:x})=>{for(let C=0;C<m.length;++C){const I=k?k[C]:m[C],v=w[C];I==null?v.onerror&&v.onerror(b[C]):v.onsuccess&&v.onsuccess(h.type==="put"&&y[C]?h.values[C]:I)}return{failures:b,results:k,numFailures:S,lastResult:x}}).catch(b=>(w.forEach(k=>k.onerror&&k.onerror(b)),Promise.reject(b)))})}function d(h,g,m){return t.query({trans:h,values:!1,query:{index:s,range:g},limit:m}).then(({result:y})=>c({type:"delete",keys:y,trans:h}).then(w=>w.numFailures>0?Promise.reject(w.failures[0]):y.length<m?{failures:[],numFailures:0,lastResult:void 0}:d(h,{...g,lower:y[y.length-1],lowerOpen:!0},m)))}}}}})};function Pa(n,e,t){try{if(!e||e.keys.length<n.length)return null;const s=[];for(let i=0,r=0;i<e.keys.length&&r<n.length;++i)he(e.keys[i],n[r])===0&&(s.push(t?un(e.values[i]):e.values[i]),++r);return s.length===n.length?s:null}catch{return null}}const qo={stack:"dbcore",level:-1,create:n=>({table:e=>{const t=n.table(e);return{...t,getMany:s=>{if(!s.cache)return t.getMany(s);const i=Pa(s.keys,s.trans._cache,s.cache==="clone");return i?_.resolve(i):t.getMany(s).then(r=>(s.trans._cache={keys:s.keys,values:s.cache==="clone"?un(r):r},r))},mutate:s=>(s.type!=="add"&&(s.trans._cache=null),t.mutate(s))}}})};function _i(n){return!("from"in n)}const $e=function(n,e){if(!this){const t=new $e;return n&&"d"in n&&pe(t,n),t}pe(this,arguments.length?{d:1,from:n,to:arguments.length>1?e:n}:{d:0})};function cn(n,e,t){const s=he(e,t);if(isNaN(s))return;if(s>0)throw RangeError();if(_i(n))return pe(n,{from:e,to:t,d:1});const i=n.l,r=n.r;if(he(t,n.from)<0)return i?cn(i,e,t):n.l={from:e,to:t,d:1,l:null,r:null},yr(n);if(he(e,n.to)>0)return r?cn(r,e,t):n.r={from:e,to:t,d:1,l:null,r:null},yr(n);he(e,n.from)<0&&(n.from=e,n.l=null,n.d=r?r.d+1:1),he(t,n.to)>0&&(n.to=t,n.r=null,n.d=n.l?n.l.d+1:1);const a=!n.r;i&&!n.l&&Xn(n,i),r&&a&&Xn(n,r)}function Xn(n,e){_i(e)||function t(s,{from:i,to:r,l:a,r:l}){cn(s,i,r),a&&t(s,a),l&&t(s,l)}(n,e)}function jo(n,e){const t=ai(e);let s=t.next();if(s.done)return!1;let i=s.value;const r=ai(n);let a=r.next(i.from),l=a.value;for(;!s.done&&!a.done;){if(he(l.from,i.to)<=0&&he(l.to,i.from)>=0)return!0;he(i.from,l.from)<0?i=(s=t.next(l.from)).value:l=(a=r.next(i.from)).value}return!1}function ai(n){let e=_i(n)?null:{s:0,n};return{next(t){const s=arguments.length>0;for(;e;)switch(e.s){case 0:if(e.s=1,s)for(;e.n.l&&he(t,e.n.from)<0;)e={up:e,n:e.n.l,s:1};else for(;e.n.l;)e={up:e,n:e.n.l,s:1};case 1:if(e.s=2,!s||he(t,e.n.to)<=0)return{value:e.n,done:!1};case 2:if(e.n.r){e.s=3,e={up:e,n:e.n.r,s:0};continue}case 3:e=e.up}return{done:!0}}}}function yr(n){var e,t;const s=(((e=n.r)===null||e===void 0?void 0:e.d)||0)-(((t=n.l)===null||t===void 0?void 0:t.d)||0),i=s>1?"r":s<-1?"l":"";if(i){const r=i==="r"?"l":"r",a={...n},l=n[i];n.from=l.from,n.to=l.to,n[i]=l[i],a[i]=l[r],n[r]=a,a.d=kr(a)}n.d=kr(n)}function kr({r:n,l:e}){return(n?e?Math.max(n.d,e.d):n.d:e?e.d:0)+1}At($e.prototype,{add(n){return Xn(this,n),this},addKey(n){return cn(this,n,n),this},addKeys(n){return n.forEach(e=>cn(this,e,e)),this},[Fs](){return ai(this)}});const Ko={stack:"dbcore",level:0,create:n=>{const e=n.schema.name,t=new $e(n.MIN_KEY,n.MAX_KEY);return{...n,table:s=>{const i=n.table(s),{schema:r}=i,{primaryKey:a}=r,{extractKey:l,outbound:o}=a,u={...i,mutate:h=>{const g=h.trans,m=g.mutatedParts||(g.mutatedParts={}),y=I=>{const v=`idb://${e}/${s}/${I}`;return m[v]||(m[v]=new $e)},w=y(""),b=y(":dels"),{type:k}=h;let[S,x]=h.type==="deleteRange"?[h.range]:h.type==="delete"?[h.keys]:h.values.length<50?[[],h.values]:[];const C=h.trans._cache;return i.mutate(h).then(I=>{if(oe(S)){k!=="delete"&&(S=I.results),w.addKeys(S);const v=Pa(S,C);v||k==="add"||b.addKeys(S),(v||x)&&function(O,E,B,L){function j(z){const H=O(z.name||"");function He(ie){return ie!=null?z.extractKey(ie):null}const We=ie=>z.multiEntry&&oe(ie)?ie.forEach(Te=>H.addKey(Te)):H.addKey(ie);(B||L).forEach((ie,Te)=>{const Je=B&&He(B[Te]),pt=L&&He(L[Te]);he(Je,pt)!==0&&(Je!=null&&We(Je),pt!=null&&We(pt))})}E.indexes.forEach(j)}(y,r,v,x)}else if(S){const v={from:S.lower,to:S.upper};b.add(v),w.add(v)}else w.add(t),b.add(t),r.indexes.forEach(v=>y(v.name).add(t));return I})}},c=({query:{index:h,range:g}})=>{var m,y;return[h,new $e((m=g.lower)!==null&&m!==void 0?m:n.MIN_KEY,(y=g.upper)!==null&&y!==void 0?y:n.MAX_KEY)]},d={get:h=>[a,new $e(h.key)],getMany:h=>[a,new $e().addKeys(h.keys)],count:c,query:c,openCursor:c};return Y(d).forEach(h=>{u[h]=function(g){const{subscr:m}=R;if(m){const y=x=>{const C=`idb://${e}/${s}/${x}`;return m[C]||(m[C]=new $e)},w=y(""),b=y(":dels"),[k,S]=d[h](g);if(y(k.name||"").add(S),!k.isPrimaryKey){if(h!=="count"){const x=h==="query"&&o&&g.values&&i.query({...g,values:!1});return i[h].apply(this,arguments).then(C=>{if(h==="query"){if(o&&g.values)return x.then(({result:v})=>(w.addKeys(v),C));const I=g.values?C.result.map(l):C.result;g.values?w.addKeys(I):b.addKeys(I)}else if(h==="openCursor"){const I=C,v=g.values;return I&&Object.create(I,{key:{get:()=>(b.addKey(I.primaryKey),I.key)},primaryKey:{get(){const O=I.primaryKey;return b.addKey(O),O}},value:{get:()=>(v&&w.addKey(I.primaryKey),I.value)}})}return C})}b.add(t)}}return i[h].apply(this,arguments)}}),u}}}};class ot{constructor(e,t){this._middlewares={},this.verno=0;const s=ot.dependencies;this._options=t={addons:ot.addons,autoOpen:!0,indexedDB:s.indexedDB,IDBKeyRange:s.IDBKeyRange,...t},this._deps={indexedDB:t.indexedDB,IDBKeyRange:t.IDBKeyRange};const{addons:i}=t;this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;const r={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:V,dbReadyPromise:null,cancelOpen:V,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3};var a;r.dbReadyPromise=new _(l=>{r.dbReadyResolve=l}),r.openCanceller=new _((l,o)=>{r.cancelOpen=o}),this._state=r,this.name=e,this.on=Jt(this,"populate","blocked","versionchange","close",{ready:[wi,V]}),this.on.ready.subscribe=na(this.on.ready.subscribe,l=>(o,u)=>{ot.vip(()=>{const c=this._state;if(c.openComplete)c.dbOpenError||_.resolve().then(o),u&&l(o);else if(c.onReadyBeingFired)c.onReadyBeingFired.push(o),u&&l(o);else{l(o);const d=this;u||l(function h(){d.on.ready.unsubscribe(o),d.on.ready.unsubscribe(h)})}})}),this.Collection=(a=this,Nt(Po.prototype,function(l,o){this.db=a;let u=Sa,c=null;if(o)try{u=o()}catch(m){c=m}const d=l._ctx,h=d.table,g=h.hook.reading.fire;this._ctx={table:h,index:d.index,isPrimKey:!d.index||h.schema.primKey.keyPath&&d.index===h.schema.primKey.name,range:u,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:c,or:d.or,valueMapper:g!==sn?g:null}})),this.Table=function(l){return Nt(Ao.prototype,function(o,u,c){this.db=l,this._tx=c,this.name=o,this.schema=u,this.hook=l._allTables[o]?l._allTables[o].hook:Jt(null,{creating:[yo,V],reading:[mo,sn],updating:[bo,V],deleting:[ko,V]})})}(this),this.Transaction=function(l){return Nt(Do.prototype,function(o,u,c,d,h){this.db=l,this.mode=o,this.storeNames=u,this.schema=c,this.chromeTransactionDurability=d,this.idbtrans=null,this.on=Jt(this,"complete","error","abort"),this.parent=h||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new _((g,m)=>{this._resolve=g,this._reject=m}),this._completion.then(()=>{this.active=!1,this.on.complete.fire()},g=>{var m=this.active;return this.active=!1,this.on.error.fire(g),this.parent?this.parent._reject(g):m&&this.idbtrans&&this.idbtrans.abort(),Q(g)})})}(this),this.Version=function(l){return Nt(Fo.prototype,function(o){this.db=l,this._cfg={version:o,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})}(this),this.WhereClause=function(l){return Nt(Ea.prototype,function(o,u,c){this.db=l,this._ctx={table:o,index:u===":id"?null:u,or:c};const d=l._deps.indexedDB;if(!d)throw new D.MissingAPI;this._cmp=this._ascending=d.cmp.bind(d),this._descending=(h,g)=>d.cmp(g,h),this._max=(h,g)=>d.cmp(h,g)>0?h:g,this._min=(h,g)=>d.cmp(h,g)<0?h:g,this._IDBKeyRange=l._deps.IDBKeyRange})}(this),this.on("versionchange",l=>{l.newVersion>0?console.warn(`Another connection wants to upgrade database '${this.name}'. Closing db now to resume the upgrade.`):console.warn(`Another connection wants to delete database '${this.name}'. Closing db now to resume the delete request.`),this.close()}),this.on("blocked",l=>{!l.newVersion||l.newVersion<l.oldVersion?console.warn(`Dexie.delete('${this.name}') was blocked`):console.warn(`Upgrade '${this.name}' blocked by other connection holding version ${l.oldVersion/10}`)}),this._maxKey=ln(t.IDBKeyRange),this._createTransaction=(l,o,u,c)=>new this.Transaction(l,o,u,this._options.chromeTransactionDurability,c),this._fireOnBlocked=l=>{this.on("blocked").fire(l),Qt.filter(o=>o.name===this.name&&o!==this&&!o._state.vcFired).map(o=>o.on("versionchange").fire(l))},this.use(zo),this.use(Uo),this.use(Ko),this.use(qo),this.vip=Object.create(this,{_vip:{value:!0}}),i.forEach(l=>l(this))}version(e){if(isNaN(e)||e<.1)throw new D.Type("Given version is not a positive number");if(e=Math.round(10*e)/10,this.idbdb||this._state.isBeingOpened)throw new D.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,e);const t=this._versions;var s=t.filter(i=>i._cfg.version===e)[0];return s||(s=new this.Version(e),t.push(s),t.sort(No),s.stores({}),this._state.autoSchema=!1,s)}_whenReady(e){return this.idbdb&&(this._state.openComplete||R.letThrough||this._vip)?e():new _((t,s)=>{if(this._state.openComplete)return s(new D.DatabaseClosed(this._state.dbOpenError));if(!this._state.isBeingOpened){if(!this._options.autoOpen)return void s(new D.DatabaseClosed);this.open().catch(V)}this._state.dbReadyPromise.then(t,s)}).then(e)}use({stack:e,create:t,level:s,name:i}){i&&this.unuse({stack:e,name:i});const r=this._middlewares[e]||(this._middlewares[e]=[]);return r.push({stack:e,create:t,level:s??10,name:i}),r.sort((a,l)=>a.level-l.level),this}unuse({stack:e,name:t,create:s}){return e&&this._middlewares[e]&&(this._middlewares[e]=this._middlewares[e].filter(i=>s?i.create!==s:!!t&&i.name!==t)),this}open(){return Ho(this)}_close(){const e=this._state,t=Qt.indexOf(this);if(t>=0&&Qt.splice(t,1),this.idbdb){try{this.idbdb.close()}catch{}this._novip.idbdb=null}e.dbReadyPromise=new _(s=>{e.dbReadyResolve=s}),e.openCanceller=new _((s,i)=>{e.cancelOpen=i})}close(){this._close();const e=this._state;this._options.autoOpen=!1,e.dbOpenError=new D.DatabaseClosed,e.isBeingOpened&&e.cancelOpen(e.dbOpenError)}delete(){const e=arguments.length>0,t=this._state;return new _((s,i)=>{const r=()=>{this.close();var a=this._deps.indexedDB.deleteDatabase(this.name);a.onsuccess=q(()=>{(function({indexedDB:l,IDBKeyRange:o},u){!Ci(l)&&u!==ns&&Ei(l,o).delete(u).catch(V)})(this._deps,this.name),s()}),a.onerror=_e(i),a.onblocked=this._fireOnBlocked};if(e)throw new D.InvalidArgument("Arguments not allowed in db.delete()");t.isBeingOpened?t.dbReadyPromise.then(r):r()})}backendDB(){return this.idbdb}isOpen(){return this.idbdb!==null}hasBeenClosed(){const e=this._state.dbOpenError;return e&&e.name==="DatabaseClosed"}hasFailed(){return this._state.dbOpenError!==null}dynamicallyOpened(){return this._state.autoSchema}get tables(){return Y(this._allTables).map(e=>this._allTables[e])}transaction(){const e=Wo.apply(this,arguments);return this._transaction.apply(this,e)}_transaction(e,t,s){let i=R.trans;i&&i.db===this&&e.indexOf("!")===-1||(i=null);const r=e.indexOf("?")!==-1;let a,l;e=e.replace("!","").replace("?","");try{if(l=t.map(u=>{var c=u instanceof this.Table?u.name:u;if(typeof c!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return c}),e=="r"||e===ks)a=ks;else{if(e!="rw"&&e!=bs)throw new D.InvalidArgument("Invalid transaction mode: "+e);a=bs}if(i){if(i.mode===ks&&a===bs){if(!r)throw new D.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");i=null}i&&l.forEach(u=>{if(i&&i.storeNames.indexOf(u)===-1){if(!r)throw new D.SubTransaction("Table "+u+" not included in parent transaction.");i=null}}),r&&i&&!i.active&&(i=null)}}catch(u){return i?i._promise(null,(c,d)=>{d(u)}):Q(u)}const o=Aa.bind(null,this,a,l,i,s);return i?i._promise(a,o,"lock"):R.trans?Ot(R.transless,()=>this._whenReady(o)):this._whenReady(o)}table(e){if(!ke(this._allTables,e))throw new D.InvalidTable(`Table ${e} does not exist`);return this._allTables[e]}}const Go=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable";class Yo{constructor(e){this._subscribe=e}subscribe(e,t,s){return this._subscribe(e&&typeof e!="function"?e:{next:e,error:t,complete:s})}[Go](){return this}}function Ra(n,e){return Y(e).forEach(t=>{Xn(n[t]||(n[t]=new $e),e[t])}),n}function Zo(n){let e,t=!1;const s=new Yo(i=>{const r=ki(n);let a=!1,l={},o={};const u={get closed(){return a},unsubscribe:()=>{a=!0,Qe.storagemutated.unsubscribe(g)}};i.start&&i.start(u);let c=!1,d=!1;function h(){return Y(o).some(y=>l[y]&&jo(l[y],o[y]))}const g=y=>{Ra(l,y),h()&&m()},m=()=>{if(c||a)return;l={};const y={},w=function(b){r&&Lt();const k=()=>Ze(n,{subscr:b,trans:null}),S=R.trans?Ot(R.transless,k):k();return r&&S.then(Ve,Ve),S}(y);d||(Qe(on,g),d=!0),c=!0,Promise.resolve(w).then(b=>{t=!0,e=b,c=!1,a||(h()?m():(l={},o=y,i.next&&i.next(b)))},b=>{c=!1,t=!1,i.error&&i.error(b),u.unsubscribe()})};return m(),u});return s.hasValue=()=>t,s.getValue=()=>e,s}let oi;try{oi={indexedDB:W.indexedDB||W.mozIndexedDB||W.webkitIndexedDB||W.msIndexedDB,IDBKeyRange:W.IDBKeyRange||W.webkitIDBKeyRange}}catch{oi={indexedDB:null,IDBKeyRange:null}}const nt=ot;function Hn(n){let e=Ne;try{Ne=!0,Qe.storagemutated.fire(n)}finally{Ne=e}}At(nt,{...$n,delete:n=>new nt(n,{addons:[]}).delete(),exists:n=>new nt(n,{addons:[]}).open().then(e=>(e.close(),!0)).catch("NoSuchDatabaseError",()=>!1),getDatabaseNames(n){try{return function({indexedDB:e,IDBKeyRange:t}){return Ci(e)?Promise.resolve(e.databases()).then(s=>s.map(i=>i.name).filter(i=>i!==ns)):Ei(e,t).toCollection().primaryKeys()}(nt.dependencies).then(n)}catch{return Q(new D.MissingAPI)}},defineClass:()=>function(n){pe(this,n)},ignoreTransaction:n=>R.trans?Ot(R.transless,n):n(),vip:ii,async:function(n){return function(){try{var e=ri(n.apply(this,arguments));return e&&typeof e.then=="function"?e:_.resolve(e)}catch(t){return Q(t)}}},spawn:function(n,e,t){try{var s=ri(n.apply(t,e||[]));return s&&typeof s.then=="function"?s:_.resolve(s)}catch(i){return Q(i)}},currentTransaction:{get:()=>R.trans||null},waitFor:function(n,e){const t=_.resolve(typeof n=="function"?nt.ignoreTransaction(n):n).timeout(e||6e4);return R.trans?R.trans.waitFor(t):t},Promise:_,debug:{get:()=>Ae,set:n=>{la(n,n==="dexie"?()=>!0:xa)}},derive:Ct,extend:pe,props:At,override:na,Events:Jt,on:Qe,liveQuery:Zo,extendObservabilitySet:Ra,getByKeyPath:Fe,setByKeyPath:Se,delByKeyPath:function(n,e){typeof e=="string"?Se(n,e,void 0):"length"in e&&[].map.call(e,function(t){Se(n,t,void 0)})},shallowClone:ra,deepClone:un,getObjectDiff:Ii,cmp:he,asap:sa,minKey:Zs,addons:[],connections:Qt,errnames:vi,dependencies:oi,semVer:hr,version:hr.split(".").map(n=>parseInt(n)).reduce((n,e,t)=>n+e/Math.pow(10,2*t))}),nt.maxKey=ln(nt.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(Qe(on,n=>{if(!Ne){let e;ts?(e=document.createEvent("CustomEvent"),e.initCustomEvent(Ye,!0,!0,n)):e=new CustomEvent(Ye,{detail:n}),Ne=!0,dispatchEvent(e),Ne=!1}}),addEventListener(Ye,({detail:n})=>{Ne||Hn(n)}));let Ne=!1;if(typeof BroadcastChannel<"u"){const n=new BroadcastChannel(Ye);typeof n.unref=="function"&&n.unref(),Qe(on,e=>{Ne||n.postMessage(e)}),n.onmessage=e=>{e.data&&Hn(e.data)}}else if(typeof self<"u"&&typeof navigator<"u"){Qe(on,e=>{try{Ne||(typeof localStorage<"u"&&localStorage.setItem(Ye,JSON.stringify({trig:Math.random(),changedParts:e})),typeof self.clients=="object"&&[...self.clients.matchAll({includeUncontrolled:!0})].forEach(t=>t.postMessage({type:Ye,changedParts:e})))}catch{}}),typeof addEventListener<"u"&&addEventListener("storage",e=>{if(e.key===Ye){const t=JSON.parse(e.newValue);t&&Hn(t.changedParts)}});const n=self.document&&navigator.serviceWorker;n&&n.addEventListener("message",function({data:e}){e&&e.type===Ye&&Hn(e.changedParts)})}_.rejectionMapper=function(n,e){if(!n||n instanceof It||n instanceof TypeError||n instanceof SyntaxError||!n.name||!or[n.name])return n;var t=new or[n.name](e||n.message,n);return"stack"in n&&Be(t,"stack",{get:function(){return this.inner.stack}}),t},la(Ae,xa);class Xo extends ot{constructor(){super("SpirtzVoiceDB");p(this,"documents");p(this,"settings");p(this,"audioCache");p(this,"audioChunks");p(this,"plans");p(this,"timelines");p(this,"segmentCache");p(this,"annotations");p(this,"voicePackages");p(this,"voiceAssets");this.version(1).stores({documents:"id, title, lastReadAt",settings:"id",audioCache:"id, lastAccessMs, chunkHash",plans:"planId, docId",timelines:"planId",voicePackages:"voiceId, lang",voiceAssets:"id, voiceId"}),this.version(2).stores({audioChunks:"id"}),this.version(3).stores({}).upgrade(t=>t.table("audioChunks").clear()),this.version(4).stores({documents:"id, title, lastReadAt, language"}),this.version(5).stores({documents:"id, title, lastReadAt, language, lastUpdated"}).upgrade(t=>t.table("documents").toCollection().modify(s=>{s.lastUpdated||(s.lastUpdated=s.lastReadAt||Date.now())})),this.version(6).stores({segmentCache:"id, docId, paraId"}),this.version(7).stores({annotations:"id, docId, startOffset"}),this.version(8).stores({annotations:"id, docId, startOffset, paraId"}),this.version(9).stores({documents:"id, title, lastReadAt, language, lastUpdated",settings:"id",audioCache:"id, lastAccessMs, chunkHash",audioChunks:"id",plans:"planId, docId",timelines:"planId",voicePackages:"voiceId, lang",voiceAssets:"id, voiceId",segmentCache:"id, docId, paraId",annotations:"id, docId, startOffset, paraId"})}}const $=new Xo;class Qo{async saveChunk(e,t,s){await $.audioChunks.put({id:e,data:t,duration:s})}async getChunk(e){return await $.audioChunks.get(e)}async hasChunk(e){return await $.audioChunks.where("id").equals(e).count()>0}async deleteChunk(e){await $.audioChunks.delete(e)}async deleteChunks(e){e.length!==0&&await $.audioChunks.bulkDelete(e)}async getDuration(e){return(await $.audioChunks.get(e))?.duration}}const St=new Qo;class Jo{async installVoice(e,t){await $.transaction("rw",$.voicePackages,$.voiceAssets,async()=>{await $.voicePackages.put(e);for(const[s,i]of t.entries()){const r=`${e.voiceId}/${s}`;await $.voiceAssets.put({id:r,voiceId:e.voiceId,data:i})}})}async listVoices(){return await $.voicePackages.toArray()}async getVoice(e){return await $.voicePackages.get(e)}async getVoiceAsset(e,t){const s=`${e}/${t}`;return(await $.voiceAssets.get(s))?.data}async isVoiceInstalled(e){return!!await this.getVoice(e)}async uninstallVoice(e){await $.transaction("rw",$.voicePackages,$.voiceAssets,async()=>{await $.voicePackages.delete(e),await $.voiceAssets.where("voiceId").equals(e).delete()})}}const Ge=new Jo,ze="https://huggingface.co/rhasspy/piper-voices/resolve/v1.0.0/",br=[{id:"en_US-amy-medium.onnx",name:"Amy (Medium)",lang:"en-US",modelUrl:"/piper/en_US-amy-medium.onnx",configUrl:"/piper/en_US-amy-medium.onnx.json",sizeBytes:63201294,isBuiltIn:!0},{id:"es_ES-sharvard-medium.onnx",name:"Alvaro (Medium)",lang:"es-ES",modelUrl:ze+"es/es_ES/sharvard/medium/es_ES-sharvard-medium.onnx",configUrl:ze+"es/es_ES/sharvard/medium/es_ES-sharvard-medium.onnx.json",sizeBytes:64149097},{id:"fr_FR-siwis-medium.onnx",name:"Siwis (Medium)",lang:"fr-FR",modelUrl:ze+"fr/fr_FR/siwis/medium/fr_FR-siwis-medium.onnx",configUrl:ze+"fr/fr_FR/siwis/medium/fr_FR-siwis-medium.onnx.json",sizeBytes:6516e4},{id:"de_DE-thorsten-medium.onnx",name:"Thorsten (Medium)",lang:"de-DE",modelUrl:ze+"de/de_DE/thorsten/medium/de_DE-thorsten-medium.onnx",configUrl:ze+"de/de_DE/thorsten/medium/de_DE-thorsten-medium.onnx.json",sizeBytes:65548e3},{id:"ru_RU-dmitri-medium.onnx",name:"Dmitri (Medium)",lang:"ru-RU",modelUrl:ze+"ru/ru_RU/dmitri/medium/ru_RU-dmitri-medium.onnx",configUrl:ze+"ru/ru_RU/dmitri/medium/ru_RU-dmitri-medium.onnx.json",sizeBytes:63e6}];class el{constructor(){p(this,"ctx");p(this,"sources",[]);p(this,"masterGain");p(this,"playbackRate",1);p(this,"playbackQueue",[]);p(this,"startTime",0);p(this,"offsetTime",0);p(this,"isPlaying",!1);p(this,"lastOpId",0);p(this,"silenceNode",null);const e=window.AudioContext||window.webkitAudioContext;this.ctx=new e,this.masterGain=this.ctx.createGain(),this.masterGain.connect(this.ctx.destination),this.masterGain.gain.value=1,this.suspended()}suspended(){this.ctx.state==="running"&&this.ctx.suspend()}async resumeContext(){this.ctx.state==="suspended"&&await this.ctx.resume(),this.ensureKeepAlive()}ensureKeepAlive(){if(!this.silenceNode)try{const e=this.ctx.createBuffer(1,1,22050),t=this.ctx.createBufferSource();t.buffer=e,t.loop=!0,t.connect(this.ctx.destination),t.start(),this.silenceNode=t}catch(e){console.warn("Failed to start keep-alive silence",e)}}setVolume(e){const t=Math.max(0,Math.min(1,e));this.masterGain.gain.value=t}clear(){this.stopAll(),this.playbackQueue=[]}setPlaybackRate(e){if(e<=0)return;let t=0;this.isPlaying&&(t=this.getCurrentTime()),this.playbackRate=e,this.isPlaying&&(this.startTime=this.ctx.currentTime-t/e,this.play(t))}scheduleChunk(e,t,s){if(this.playbackQueue.some(r=>r.id===e))return;const i={id:e,buffer:t,startTimeSec:s};this.playbackQueue.push(i),this.isPlaying&&this.scheduleItem(i,this.offsetTime)}hasChunk(e){return this.playbackQueue.some(t=>t.id===e)}scheduleItem(e,t){const s=this.ctx.currentTime,i=this.startTime+e.startTimeSec/this.playbackRate;if(e.startTimeSec+e.buffer.duration<=t)return;const a=this.ctx.createBufferSource();if(a.buffer=e.buffer,a.playbackRate.value=this.playbackRate,a.connect(this.masterGain),i>=s)a.start(i);else{const o=(s-i)*this.playbackRate;o<e.buffer.duration&&(o<.08?a.start(s,0):a.start(s,o))}this.sources.push(a),a.onended=()=>{this.sources=this.sources.filter(l=>l!==a)}}pruneBefore(e){this.playbackQueue=this.playbackQueue.filter(t=>t.startTimeSec+t.buffer.duration>e)}async play(e=0,t){if(t!==void 0){if(t<this.lastOpId)return;this.lastOpId=t}await this.resumeContext(),!(t!==void 0&&t<this.lastOpId)&&(this.stopAll(),this.startTime=this.ctx.currentTime-e/this.playbackRate,this.offsetTime=e,this.isPlaying=!0,this.scheduleQueue(e))}scheduleQueue(e){for(const t of this.playbackQueue)this.scheduleItem(t,e)}async pause(e){if(e!==void 0){if(e<this.lastOpId)return;this.lastOpId=e}this.isPlaying&&(this.offsetTime=this.getCurrentTime(),!(e!==void 0&&e<this.lastOpId)&&(this.stopAll(),this.isPlaying=!1))}seek(e){this.offsetTime=e}stop(){this.stopAll(),this.isPlaying=!1,this.offsetTime=0}stopAll(){this.sources.forEach(e=>{try{e.stop()}catch{}try{e.disconnect()}catch{}}),this.sources=[]}getCurrentTime(){if(!this.isPlaying)return this.offsetTime;const t=(this.ctx.currentTime-this.startTime)*this.playbackRate,s=this.ctx.outputLatency||0,r=((this.ctx.baseLatency||0)+(s>0?s:.025))*this.playbackRate;return Math.max(0,t-r)}getAudioContext(){return this.ctx}}class li{static buildTimeline(e,t,s){const i=[];let r=0;for(const l of e.chunks){const o=t.get(l.chunkHash);if(!o){console.warn(`Missing audio for chunk ${l.chunkHash}`);continue}const u=o.durationSec,c=s.slice(l.startTokenIndex,l.endTokenIndex);if(e.strategy==="TOKEN"){const d=c[0];if(!d)continue;const h={tokenId:d.tokenId,tokenIndex:d.index,tStartSec:r,tEndSec:r+u};i.push(h),r+=u}else{const h=c.filter(m=>m.type==="word").length;if(h===0)continue;const g=u/h;for(const m of c)if(m.type==="word"){const y={tokenId:m.tokenId,tokenIndex:m.index,tStartSec:r,tEndSec:r+g};i.push(y),r+=g}}}return{planId:e.planId,entries:i,durationSec:r}}static getCurrentTokenIndex(e,t){if(e.entries.length===0)return-1;let s=0,i=e.entries.length-1;for(;s<=i;){const r=Math.floor((s+i)/2),a=e.entries[r];if(t>=a.tStartSec&&t<a.tEndSec)return a.tokenIndex;t<a.tStartSec?i=r-1:s=r+1}return t<e.entries[0].tStartSec?e.entries[0].tokenIndex:t>=e.durationSec?e.entries[e.entries.length-1].tokenIndex:e.entries[i]?.tokenIndex??-1}static getTimeForToken(e,t){return e.entries.find(i=>i.tokenIndex===t)?.tStartSec??0}static validateTimeline(e,t){if(e.entries.length===0)return!1;for(let s=1;s<e.entries.length;s++){const i=e.entries[s-1];if(e.entries[s].tStartSec<i.tEndSec-.001)return console.warn("Timeline has overlapping entries"),!1}return!0}}class tl{constructor(){p(this,"currentTimeline",null)}setTimeline(e){this.currentTimeline=e}getCurrentTokenIndex(e){return this.currentTimeline?li.getCurrentTokenIndex(this.currentTimeline,e):-1}getTokenTiming(e){if(this.currentTimeline)return this.currentTimeline.entries.find(t=>t.tokenIndex===e)}getDuration(){return this.currentTimeline?.durationSec??0}}class nl{constructor(){p(this,"scheduler");p(this,"cursor");p(this,"timeline",null);p(this,"timelineComplete",!0);p(this,"onTimeUpdate");p(this,"onTokenChanged");p(this,"onStateChanged");p(this,"onBufferingRequest");p(this,"updateInterval",null);p(this,"lastTokenIndex",-1);p(this,"isPlaying",!1);p(this,"lastBufferingTime",-1);p(this,"opCounter",0);this.scheduler=new el,this.cursor=new tl}setTimeline(e){this.timeline=e,this.cursor.setTimeline(e)}setTimelineComplete(e){this.timelineComplete=e}getDuration(){return this.timeline?.durationSec??0}async play(e=-1){if(!this.timeline){console.warn("No timeline set");return}let t=this.scheduler.getCurrentTime();e>=0&&(t=li.getTimeForToken(this.timeline,e)),t>=this.timeline.durationSec&&(t=0);const s=++this.opCounter;this.setIsPlaying(!0);try{if(await this.scheduler.play(t,s),this.opCounter!==s)return;this.startLoop(),this.onBufferingRequest?.(t)}catch(i){throw this.opCounter===s&&this.setIsPlaying(!1),i}}async pause(){const e=++this.opCounter;this.setIsPlaying(!1),this.stopLoop();try{await this.scheduler.pause(e)}catch(t){throw this.opCounter===e&&this.setIsPlaying(!0),t}}getState(){return this.isPlaying?"PLAYING":this.timeline?"PAUSED":"IDLE"}seek(e){if(!this.timeline)return;let s=this.scheduler.getCurrentTime()+e;if(!this.timelineComplete&&s>this.timeline.durationSec)return;if(s=Math.max(0,Math.min(s,this.timeline.durationSec)),this.isPlaying){const r=++this.opCounter;this.scheduler.play(s,r).catch(console.error),this.onBufferingRequest?.(s)}else{this.scheduler.seek(s),this.onTimeUpdate?.(s);const r=this.cursor.getCurrentTokenIndex(s);r!==this.lastTokenIndex&&(this.lastTokenIndex=r,this.onTokenChanged?.(r)),this.onBufferingRequest?.(s)}}seekByToken(e){if(!this.timeline)return;if(!this.timelineComplete){const i=this.timeline.entries[this.timeline.entries.length-1];if(!i||e>i.tokenIndex)return}const t=li.getTimeForToken(this.timeline,e);this.isPlaying?this.play(e):(this.scheduler.seek(t),this.lastTokenIndex=e,this.onTokenChanged?.(e),this.onTimeUpdate?.(t),this.onBufferingRequest?.(t))}skipWord(e,t){if(!this.timeline)return;let i=this.getCurrentTokenIndex()+e;for(;i>=0&&i<t.length&&t[i].type!=="word";)i+=e;i>=0&&i<t.length&&this.seekByToken(i)}skipSentence(e,t){if(!this.timeline)return;const s=this.getCurrentTokenIndex(),i=t[s];if(!i)return;const a=i.sentenceId+e,l=t.find(o=>o.sentenceId===a);l&&this.seekByToken(l.index)}skipParagraph(e,t){if(!this.timeline)return;let i=this.getCurrentTokenIndex()+e,r=!1;for(;i>=0&&i<t.length;){const a=t[i];if(a.type==="newline")r=!0;else if(r&&a.type==="word")break;i+=e}i>=0&&i<t.length?this.seekByToken(i):e===-1&&this.seekByToken(0)}getScheduler(){return this.scheduler}getCurrentTokenIndex(){const e=this.scheduler.getCurrentTime();return this.cursor.getCurrentTokenIndex(e)}startLoop(){this.stopLoop(),this.updateInterval=window.setInterval(()=>{this.tick()},16)}stopLoop(){this.updateInterval&&(window.clearInterval(this.updateInterval),this.updateInterval=null)}setIsPlaying(e){this.isPlaying!==e&&(this.isPlaying=e,this.onStateChanged?.(e))}tick(){const e=this.scheduler.getCurrentTime();this.onTimeUpdate?.(e);const t=this.cursor.getCurrentTokenIndex(e);t!==this.lastTokenIndex&&(this.lastTokenIndex=t,this.onTokenChanged?.(t)),Math.abs(e-this.lastBufferingTime)>1&&(this.lastBufferingTime=e,this.onBufferingRequest?.(e)),this.timelineComplete&&this.timeline&&e>=this.timeline.durationSec&&this.pause()}}async function vr(n,e,t){const s=`${n}|${e}|${t}`,r=new TextEncoder().encode(s),a=await crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(a)).map(u=>u.toString(16).padStart(2,"0")).join("")}const ne=[];for(let n=0;n<256;++n)ne.push((n+256).toString(16).slice(1));function sl(n,e=0){return(ne[n[e+0]]+ne[n[e+1]]+ne[n[e+2]]+ne[n[e+3]]+"-"+ne[n[e+4]]+ne[n[e+5]]+"-"+ne[n[e+6]]+ne[n[e+7]]+"-"+ne[n[e+8]]+ne[n[e+9]]+"-"+ne[n[e+10]]+ne[n[e+11]]+ne[n[e+12]]+ne[n[e+13]]+ne[n[e+14]]+ne[n[e+15]]).toLowerCase()}let Ts;const il=new Uint8Array(16);function rl(){if(!Ts){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Ts=crypto.getRandomValues.bind(crypto)}return Ts(il)}const al=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),wr={randomUUID:al};function ol(n,e,t){n=n||{};const s=n.random??n.rng?.()??rl();if(s.length<16)throw new Error("Random bytes length must be >= 16");return s[6]=s[6]&15|64,s[8]=s[8]&63|128,sl(s)}function Pt(n,e,t){return wr.randomUUID&&!n?wr.randomUUID():ol(n)}class ll{static async generatePlan(e,t,s){const{strategy:i,voiceId:r,speedWpm:a,pauseRules:l}=s,o=i==="TOKEN"?1:s.chunkSize,u=await this.generateChunks(t,i,o,r,a);return{planId:Pt(),docId:e,voiceId:r,speedWpm:a,strategy:i,chunkSize:o,pauseRules:l,tokenizerVersion:"1",chunks:u}}static async generateChunks(e,t,s,i,r){const a=[];if(t==="TOKEN")for(let l=0;l<e.length;l++){const o=e[l],u=o.normText;if(!u||u.trim().length===0)continue;const c=await vr(u,i,r),d={chunkId:c,startTokenIndex:l,endTokenIndex:l+1,chunkText:u,tokenIds:[o.tokenId],chunkHash:c};a.push(d)}else for(let l=0;l<e.length;l+=s){const o=e.slice(l,l+s),u=o.map(h=>h.normText).filter(h=>h&&h.trim().length>0).join(" ");if(!u||u.trim().length===0)continue;const c=await vr(u,i,r),d={chunkId:c,startTokenIndex:l,endTokenIndex:Math.min(l+s,e.length),chunkText:u,tokenIds:o.map(h=>h.tokenId),chunkHash:c};a.push(d)}return a}static arePlansCompatible(e,t){return e.voiceId===t.voiceId&&e.speedWpm===t.speedWpm&&e.strategy===t.strategy&&e.chunkSize===t.chunkSize}}const cl={commaPauseMs:120,semicolonPauseMs:200,sentenceEndPauseMs:450,longWordBonusMs:35};function ul(n,e,t={}){if(!n)return 0;const s={...cl,...t},r=6e4/Math.max(1,e),a=n.split(/\s+/).filter(Boolean),l=a.length,o=(n.match(/,/g)||[]).length,u=(n.match(/;/g)||[]).length,c=(n.match(/[.!?]/g)||[]).length,d=a.reduce((y,w)=>w.replace(/^[^\p{L}\p{N}]+|[^\p{L}\p{N}]+$/gu,"").length>=9?y+1:y,0),h=r*l,g=o*s.commaPauseMs+u*s.semicolonPauseMs+c*s.sentenceEndPauseMs,m=d*s.longWordBonusMs;return h+g+m}class hl{constructor(){p(this,"scheduler");p(this,"controller");p(this,"worker");p(this,"currentPlan",null);p(this,"currentTimeline",null);p(this,"currentTokens",[]);p(this,"useWebGPU",!1);p(this,"gpuPreference");p(this,"pendingChunks",new Map);p(this,"pendingVoiceLoads",new Map);p(this,"bufferedChunks",new Set);p(this,"loadedVoiceId",null);p(this,"loadedVoiceHasAssets",!1);p(this,"pendingVoiceAssets",new Map);p(this,"chunkTimeline",[]);p(this,"pendingDurations",new Map);p(this,"nextChunkIndex",0);p(this,"chunkCumulativeTime",0);p(this,"timelineComplete",!0);p(this,"synthesisSessionId",0);p(this,"currentChunkHashSet",new Set);p(this,"currentChunkByHash",new Map);p(this,"metadataCtx");p(this,"isSynthesisCancelled",!1);p(this,"pendingVoiceList",null);this.controller=new nl,this.scheduler=this.controller.getScheduler();const e=this.scheduler.getAudioContext();this.metadataCtx=new OfflineAudioContext(1,1,e.sampleRate),this.worker=new Worker(new URL("/spirtzVioice/beta/assets/tts-worker-DO6dMZJC.js",import.meta.url),{type:"module"}),this.worker.onmessage=this.handleWorkerMessage.bind(this),this.worker.postMessage({type:"INIT",payload:{originUrl:window.location.origin}}),this.controller.onBufferingRequest=t=>{this.bufferWindow(t).catch(console.warn)}}getController(){return this.controller}destroy(){this.cancelSynthesis(),this.pendingChunks.clear(),this.pendingVoiceLoads.clear(),this.pendingVoiceAssets.clear(),this.scheduler.clear(),this.worker.terminate()}setVolume(e){this.scheduler.setVolume(e)}cancelSynthesis(){this.isSynthesisCancelled=!0}async loadDocument(e,t,s,i=0,r){this.currentTokens=t,this.useWebGPU=s.useWebGPU??!1,this.gpuPreference=s.gpuPreference,this.bufferedChunks.clear(),this.isSynthesisCancelled=!1,this.pendingDurations.clear(),this.nextChunkIndex=0,this.chunkCumulativeTime=0,this.timelineComplete=!1,this.controller.setTimelineComplete(!1),this.synthesisSessionId++;const a=this.synthesisSessionId;this.currentTimeline=null,this.chunkTimeline=[],this.currentChunkHashSet.clear(),this.currentChunkByHash.clear(),this.scheduler.clear(),console.log(`Loading voice ${s.voiceId}...`),await this.loadVoice(s.voiceId),console.log("Generating plan...");const l=await ll.generatePlan(e,t,s);this.currentPlan=l,this.currentChunkHashSet=new Set(l.chunks.map(h=>h.chunkHash)),this.currentChunkByHash=new Map(l.chunks.map(h=>[h.chunkHash,h])),s.playbackRate&&this.scheduler.setPlaybackRate(s.playbackRate),console.log("Synthesizing initial audio...");const o=this.getInitialChunkTargetIndex(l,i),c=Math.min(l.chunks.length,Math.max(2,o+1));if(await this.synthesizeInitialChunks(l,c,r,a),await this.appendAvailableTimeline(a),this.synthesizeRemainingChunks(l,c,r,a),this.isSynthesisCancelled){console.log("Synthesis cancelled"),r?.(0,"Cancelled");return}if(!this.currentPlan)return;let d=0;if(i>0){const h=this.currentTimeline?.entries?.find(g=>g.tokenIndex===i);h&&(d=h.tStartSec)}console.log(`Buffering initial window from ${d}s...`),await this.bufferWindow(d),i>0&&this.controller.seekByToken(i)}async bufferWindow(e){if(!this.currentTimeline||!this.currentPlan||this.chunkTimeline.length===0)return;this.scheduler.pruneBefore(e-10);const s=e+30,i=[];for(const a of this.chunkTimeline){if(a.endSec<e)continue;if(a.startSec>s)break;const l=`${a.chunkHash}-${a.startSec}`;if(!this.bufferedChunks.has(l)){if(this.scheduler.hasChunk(l)){this.bufferedChunks.add(l);continue}this.bufferedChunks.add(l),i.push(a)}}const r=3;for(let a=0;a<i.length;a+=r){const l=i.slice(a,a+r);await Promise.all(l.map(async o=>{const u=`${o.chunkHash}-${o.startSec}`;try{await this.scheduleChunkFromStore(o.chunkHash,o.startSec,u)}catch(c){console.warn("Buffer failed for",o.chunkHash,c),this.bufferedChunks.delete(u)}}))}for(const a of this.chunkTimeline)if(a.endSec<e-20&&this.bufferedChunks.delete(`${a.chunkHash}-${a.startSec}`),a.startSec>e)break}async scheduleChunkFromStore(e,t,s){const i=await St.getChunk(e);if(!i){console.warn(`[JIT] Chunk ${e} not in DB!`);const r=this.currentChunkByHash.get(e);r&&this.currentPlan&&this.synthesizeChunk(r,this.currentPlan,this.synthesisSessionId).catch(console.warn);return}try{const r=await i.data.arrayBuffer(),l=await this.scheduler.getAudioContext().decodeAudioData(r);this.scheduler.scheduleChunk(s,l,t)}catch(r){console.warn(`Failed to decode chunk ${e}`,r)}}async loadVoice(e){const t=await Ge.isVoiceInstalled(e);let s;if(console.log(`[AudioEngine] loadVoice: ${e}, installed=${t}`),t){const i=await Ge.getVoiceAsset(e,"model.onnx"),r=await Ge.getVoiceAsset(e,"config.json");console.log(`[AudioEngine] Assets found: model=${!!i}, config=${!!r}`),i&&r&&(s={model:i,config:r})}if(!(this.loadedVoiceId===e&&this.loadedVoiceHasAssets===!!s&&!this.pendingVoiceLoads.has(e)))return this.pendingVoiceLoads.has(e)?new Promise((i,r)=>{const a=this.pendingVoiceLoads.get(e);if(!a){i();return}this.pendingVoiceLoads.set(e,{resolve:()=>{a.resolve(),i()},reject:l=>{a.reject(l),r(l)}})}):(this.pendingVoiceAssets.set(e,!!s),new Promise((i,r)=>{this.pendingVoiceLoads.set(e,{resolve:i,reject:r}),this.worker.postMessage({type:"LOAD_VOICE",payload:{voiceId:e,assets:s}})}))}async installVoice(e,t){const s=br.find(c=>c.id===e);if(!s)throw new Error(`Voice ${e} not found in registry`);if(await Ge.isVoiceInstalled(e))return;t?.(10);const[i,r]=await Promise.all([fetch(s.modelUrl),fetch(s.configUrl)]);if(!i.ok||!r.ok)throw new Error("Failed to download voice assets");const[a,l]=await Promise.all([i.arrayBuffer(),r.json()]);t?.(80);const o={voiceId:s.id,name:s.name,lang:s.lang,version:"1.0.0",sizeBytes:s.sizeBytes,assets:["model.onnx","config.json"]},u=new Map;u.set("model.onnx",a),u.set("config.json",new Blob([JSON.stringify(l)],{type:"application/json"})),await Ge.installVoice(o,u),t?.(100)}getInitialChunkTargetIndex(e,t){if(t<=0)return 0;const s=e.chunks.findIndex(i=>t>=i.startTokenIndex&&t<i.endTokenIndex);return s>=0?s:0}async synthesizeInitialChunks(e,t,s,i){const r=Math.min(t,e.chunks.length);if(r!==0){s?.(0,`Preparing audio 0/${r}...`);for(let a=0;a<r;a++){if(this.isSynthesisCancelled||i!==this.synthesisSessionId)return;const l=e.chunks[a],o=await this.getChunkDuration(l.chunkHash);if(o!==void 0){this.pendingDurations.set(l.chunkHash,o),s?.(Math.round((a+1)/r*100),`Preparing audio ${a+1}/${r}...`);continue}await this.synthesizeChunk(l,e,i),s?.(Math.round((a+1)/r*100),`Preparing audio ${a+1}/${r}...`)}}}async synthesizeRemainingChunks(e,t,s,i){if(i!==this.synthesisSessionId)return;const r=[];for(let c=t;c<e.chunks.length;c++){const d=e.chunks[c];await St.hasChunk(d.chunkHash)||r.push(d)}const a=r.length;if(a===0){await this.appendAvailableTimeline(i);return}s?.(0,`Synthesizing 0/${a} chunks...`);const l=3;let o=0;const u=async c=>{this.isSynthesisCancelled||i!==this.synthesisSessionId||(await this.synthesizeChunk(c,e,i),o++,s?.(Math.round(o/a*100),`Synthesizing chunk ${o}/${a}...`))};for(let c=0;c<a&&!(this.isSynthesisCancelled||i!==this.synthesisSessionId);c+=l){const d=r.slice(c,c+l);await Promise.all(d.map(h=>u(h)))}await this.appendAvailableTimeline(i)}async getChunkDuration(e){const t=this.pendingDurations.get(e);if(t!==void 0)return t;const s=await St.getDuration(e);return s!==void 0&&this.pendingDurations.set(e,s),s}async appendAvailableTimeline(e){if(e!==this.synthesisSessionId||!this.currentPlan)return;this.currentTimeline||(this.currentTimeline={planId:this.currentPlan.planId,entries:[],durationSec:0});let t=this.currentTimeline.durationSec;for(;this.nextChunkIndex<this.currentPlan.chunks.length;){const i=this.currentPlan.chunks[this.nextChunkIndex],r=await this.getChunkDuration(i.chunkHash);if(r===void 0)break;const a=ul(i.chunkText,this.currentPlan.speedWpm)/1e3,l=Math.max(r,a),o=this.chunkCumulativeTime,u=o+l,c=this.currentTokens.slice(i.startTokenIndex,i.endTokenIndex);if(this.currentPlan.strategy==="TOKEN"){const d=c[0];d&&(this.currentTimeline.entries.push({tokenId:d.tokenId,tokenIndex:d.index,tStartSec:t,tEndSec:t+l}),t+=l)}else{const d=c.reduce((h,g)=>g.type==="word"?h+Math.max(1,(g.normText||g.text||"").length):g.type==="punct"?h+3:g.type==="newline"?h+6:h+1,0);if(d>0)for(const h of c){const m=(h.type==="word"?Math.max(1,(h.normText||h.text||"").length):h.type==="punct"?3:h.type==="newline"?6:1)/d*l;this.currentTimeline.entries.push({tokenId:h.tokenId,tokenIndex:h.index,tStartSec:t,tEndSec:t+m}),t+=m}else t+=l}this.chunkTimeline.push({chunkHash:i.chunkHash,startSec:o,endSec:u}),this.chunkCumulativeTime=u,this.nextChunkIndex++}this.currentTimeline.durationSec=t,this.controller.setTimeline(this.currentTimeline);const s=this.nextChunkIndex>=this.currentPlan.chunks.length;s!==this.timelineComplete&&(this.timelineComplete=s,this.controller.setTimelineComplete(s))}async synthesizeChunk(e,t,s){if(!this.isSynthesisCancelled&&!this.pendingChunks.has(e.chunkHash)&&!await St.hasChunk(e.chunkHash))return new Promise((i,r)=>{this.pendingChunks.set(e.chunkHash,{resolve:async a=>{this.isSynthesisCancelled;try{const o=(await this.metadataCtx.decodeAudioData(a.audioData.slice(0))).duration,u=new Blob([a.audioData],{type:"audio/wav"});await St.saveChunk(e.chunkHash,u,o),s===this.synthesisSessionId&&this.currentChunkHashSet.has(e.chunkHash)&&(this.pendingDurations.set(e.chunkHash,o),await this.appendAvailableTimeline(s)),i()}catch(l){console.error("Save/Decode error",l),r(l)}},reject:a=>{console.error("Chunk synthesis rejected",a),r(a)},sessionId:s}),this.worker.postMessage({type:"SYNTHESIZE_CHUNK",payload:{chunkText:e.chunkText,chunkHash:e.chunkHash,voiceId:t.voiceId,speedWpm:t.speedWpm,useWebGPU:this.useWebGPU,gpuPreference:this.gpuPreference}})})}handleWorkerMessage(e){const{type:t,payload:s,error:i}=e.data;switch(t){case"CHUNK_COMPLETE":{const r=this.pendingChunks.get(s.chunkHash);r&&(r.resolve(s),this.pendingChunks.delete(s.chunkHash));break}case"CHUNK_ERROR":{if(s&&s.chunkHash){const r=this.pendingChunks.get(s.chunkHash);r&&(r.reject(new Error(i||"Unknown Chunk Error")),this.pendingChunks.delete(s.chunkHash))}else console.error("Global Chunk Error (no hash)",i);break}case"VOICE_LOADED":{const r=this.pendingVoiceLoads.get(s.voiceId);r&&(r.resolve(),this.pendingVoiceLoads.delete(s.voiceId)),this.loadedVoiceId=s.voiceId,this.loadedVoiceHasAssets=this.pendingVoiceAssets.get(s.voiceId)||!1,this.pendingVoiceAssets.delete(s.voiceId);break}case"VOICE_ERROR":{if(s&&s.voiceId){const r=this.pendingVoiceLoads.get(s.voiceId);r&&(r.reject(new Error(i)),this.pendingVoiceLoads.delete(s.voiceId)),this.pendingVoiceAssets.delete(s.voiceId)}break}case"VOICES_LIST":{this.pendingVoiceList&&(this.pendingVoiceList.resolve(s),this.pendingVoiceList=null);break}}}async getAvailableVoices(){const e=await Ge.listVoices(),t=new Set(e.map(s=>s.voiceId));return br.map(s=>({id:s.id,name:s.name,lang:s.lang,isInstalled:s.isBuiltIn||t.has(s.id)}))}async updateSettings(e,t,s=!1){if(!this.currentPlan||!this.currentTokens.length)return;const i=this.controller.getState()==="PLAYING",r=this.controller.getCurrentTokenIndex();console.log(`Updating settings: WPM ${e.speedWpm}, Voice ${e.voiceId}`);const a=this.currentPlan.voiceId===e.voiceId,l=this.currentPlan.speedWpm===e.speedWpm,o=this.currentPlan.strategy===e.strategy,u=this.currentPlan.chunkSize===e.chunkSize;if(e.playbackRate!==void 0&&this.scheduler.setPlaybackRate(e.playbackRate),!(!s&&a&&l&&o&&u)){if(s&&await this.clearCurrentPlanAudioCache(),i)try{await this.controller.pause()}catch(c){console.warn("[AudioEngine] Failed to pause before resynthesis",c)}console.log("[AudioEngine] Settings changed, triggering resynthesis..."),this.scheduler.setPlaybackRate(1),await this.loadDocument(this.currentPlan.docId,this.currentTokens,e,r,t),i?this.controller.play(r).catch(console.error):this.controller.seekByToken(r)}}async clearCurrentPlanAudioCache(){if(!this.currentPlan)return;const e=this.currentPlan.chunks.map(t=>t.chunkHash);await St.deleteChunks(e),this.pendingDurations.clear(),this.chunkTimeline=[],this.bufferedChunks.clear()}}async function xr(){if((await Ge.listVoices()).length>1){console.log("Voices already seeded.");return}const e=[{voiceId:"mock-robot",name:"Robot Voice (Mock)",lang:"en-US",version:"1.0",sizeBytes:1024,assets:[]},{voiceId:"mock-alien",name:"Alien Voice (Mock)",lang:"en-US",version:"1.0",sizeBytes:1024,assets:[]},{voiceId:"mock-deep",name:"Deep Voice (Mock)",lang:"en-US",version:"1.0",sizeBytes:1024,assets:[]}];for(const t of e)await Ge.installVoice(t,new Map),console.log(`Seeded voice: ${t.name}`)}class dl{async createDocument(e,t,s,i="text",r,a){const l={id:Pt(),title:e,originalText:t,contentType:i,ttsText:s||t,totalTokens:r,language:a,createdAt:Date.now(),lastReadAt:Date.now(),lastUpdated:Date.now(),progressTokenIndex:0,progressOffset:0,progressChunkIndex:0,progressParaId:0,progressScrollTop:0,voiceId:"default",speedWpm:200};return await $.documents.add(l),l}async getAllDocuments(){return await $.documents.orderBy("lastReadAt").reverse().toArray()}async getDocument(e){return await $.documents.get(e)}async updateProgress(e,t,s,i){await this.updateReadingState(e,{progressTokenIndex:t,speedWpm:s,mode:i})}async updateReadingState(e,t){const s={progressTokenIndex:t.progressTokenIndex,lastReadAt:Date.now(),lastUpdated:Date.now()};t.progressOffset!==void 0&&(s.progressOffset=t.progressOffset),t.progressChunkIndex!==void 0&&(s.progressChunkIndex=t.progressChunkIndex),t.progressParaId!==void 0&&(s.progressParaId=t.progressParaId),t.progressScrollTop!==void 0&&(s.progressScrollTop=t.progressScrollTop),t.speedWpm!==void 0&&(s.speedWpm=t.speedWpm),t.mode!==void 0&&(s.mode=t.mode),await $.documents.update(e,s)}async updateSettings(e,t,s){await $.documents.update(e,{voiceId:t,speedWpm:s,lastReadAt:Date.now()})}async updateLanguage(e,t){await $.documents.update(e,{language:t,lastUpdated:Date.now()})}async bulkDeleteDocuments(e){e.length!==0&&await $.transaction("rw",$.documents,$.plans,$.timelines,async()=>{const s=(await $.plans.where("docId").anyOf(e).toArray()).map(i=>i.planId);await $.plans.where("docId").anyOf(e).delete(),await $.timelines.bulkDelete(s),await $.documents.bulkDelete(e)})}}const X=new dl;class Wn{static tokenize(e){if(!e||e.trim().length===0)return[];const t=[];let s=0,i=0,r=0;const a={word:/[\p{L}\p{N}''\u2019]+/u,punct:/[.,!?;:ââ\-"""''()[\]{}]/u,space:/ +/u,newline:/\n+/u};for(;r<e.length;){let l=!1;for(const[o,u]of Object.entries(a)){const c=new RegExp(`^${u.source}`,"u"),d=e.slice(r).match(c);if(d){const h=d[0],g=o,m={tokenId:Pt(),index:s++,text:h,normText:this.normalizeForTTS(h,g),type:g,sentenceId:i,startOffset:r,endOffset:r+h.length};t.push(m),g==="punct"&&/[.!?]/.test(h)&&i++,g==="newline"&&h.length>1&&i++,r+=h.length,l=!0;break}}l||r++}return t}static normalizeForTTS(e,t){switch(t){case"word":return e.toLowerCase();case"punct":return/[.,!?;:]/.test(e)?e:"";case"space":return" ";case"newline":return" ";default:return e}}static getWords(e){return e.filter(t=>t.type==="word")}static getTokensBySentence(e,t){return e.filter(s=>s.sentenceId===t)}static getSentenceCount(e){return e.length===0?0:Math.max(...e.map(t=>t.sentenceId))+1}}const pl=`# Spirtz Voice

**Spirtz Voice** is an offline-first web application designed to provide a high-performance reading experience by synchronizing text with synthesized speech (TTS). It combines **RSVP (Rapid Serial Visual Presentation)** technology with exact audio alignment to help users read faster and retain information better.

## Key Features
*   **Exact Synchronization**: The visual text (words or chunks) is perfectly aligned with the audio output, highlighting exactly what is being spoken in real-time.
*   **RSVP Reading**: Uses the "Rapid Serial Visual Presentation" method (flashing words one by one) to minimize eye movement and increase reading speed.
*   **Offline-First**: Built as a Progressive Web App (PWA). It works entirely offline using client-side technologies.
*   **High-Quality Local TTS**: Utilizes **Piper WASM** for high-quality, neural network-based text-to-speech that runs directly in the browser (no server required), with a fallback to the Web Speech API.
*   **Library Management**: Users can import texts, which are stored locally using **Dexie.js** (IndexedDB wrapper).

## Technical Stack
*   **Frameworkless**: Built with **Vanilla TypeScript** and **Vite** for maximum performance and zero framework overhead (no React, Vue, etc.).
*   **Architecture**:
    *   **Event-Driven**: Custom event bus manages state and communication between components.
    *   **Audio Clock is King**: The \`AudioContext.currentTime\` is the single source of truth; the UI updates reactively to the audio playback position, ensuring drift-free sync.
*   **Storage**: **Dexie.js** handles persistent storage for books, settings, and reading progress.
*   **Web Workers**: Heavy computations (like TTS audio generation) are offloaded to Web Workers to keep the main UI thread buttery smooth.

## Core Capabilities
*   **Cross-Platform**: Designed to work on mobile and desktop via standard web browsers.
*   **Share Target**: Can receive shared text/URLs from other apps (on Android/mobile) to immediately start reading.
*   **Customizable**: Supports different reading strategies (Token-based vs. Chunk-based) and view modes.

In short, it is a **fast, private, and powerful tool for speed-reading with your ears and eyes simultaneously.**
`;async function Sr(){const n=await X.getAllDocuments(),e=[{title:"Welcome to Spirtz Voice",body:pl,language:"en-US"},{title:"Welcome to Spirtz Voice (Deutsch)",body:`# Willkommen bei Spirtz Voice

**Spirtz Voice** ist eine Offline-First-Leseanwendung, die Text und Sprachsynthese (TTS) prÃ¤zise synchronisiert. Sie kombiniert **RSVP (Rapid Serial Visual Presentation)** mit exakter Audioausrichtung, damit du schneller lesen und mehr behalten kannst.

## Highlights
* **Exakte Synchronisation**: Visueller Text wird exakt mit der gesprochenen Sprache ausgerichtet.
* **RSVP-Lesen**: WÃ¶rter oder Phrasen werden einzeln angezeigt, um Augenbewegungen zu reduzieren.
* **Offline-First**: Funktioniert vollstÃ¤ndig offline als Progressive Web App.
* **Lokale TTS**: Hochwertige Sprachsynthese im Browser (kein Server erforderlich).
* **Bibliothek**: Texte werden lokal gespeichert und sind jederzeit verfÃ¼gbar.

## Kurz gesagt
Ein schnelles, privates und leistungsfÃ¤higes Tool, das Lesen mit Augen und Ohren verbindet.
`,language:"de-DE"},{title:"Welcome to Spirtz Voice (Ð ÑÑÑÐºÐ¸Ð¹)",body:`# ÐÐ¾Ð±ÑÐ¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°ÑÑ Ð² Spirtz Voice

**Spirtz Voice** â ÑÑÐ¾ Ð¾ÑÐ»Ð°Ð¹Ð½âÐ¿ÐµÑÐ²Ð¾Ðµ Ð¿ÑÐ¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ ÑÑÐµÐ½Ð¸Ñ, ÐºÐ¾ÑÐ¾ÑÐ¾Ðµ ÑÐ¾ÑÐ½Ð¾ ÑÐ¸Ð½ÑÑÐ¾Ð½Ð¸Ð·Ð¸ÑÑÐµÑ ÑÐµÐºÑÑ Ð¸ ÑÐ¸Ð½ÑÐµÐ·Ð¸ÑÐ¾Ð²Ð°Ð½Ð½ÑÑ ÑÐµÑÑ (TTS). ÐÐ½Ð¾ ÑÐ¾ÑÐµÑÐ°ÐµÑ **RSVP (Rapid Serial Visual Presentation)** Ñ ÑÐ¾ÑÐ½Ð¾Ð¹ Ð°ÑÐ´Ð¸Ð¾âÑÐ°Ð·Ð¼ÐµÑÐºÐ¾Ð¹, ÑÑÐ¾Ð±Ñ Ð²Ñ ÑÐ¸ÑÐ°Ð»Ð¸ Ð±ÑÑÑÑÐµÐµ Ð¸ Ð»ÑÑÑÐµ Ð·Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð»Ð¸.

## ÐÐ»Ð°Ð²Ð½Ð¾Ðµ
* **Ð¢Ð¾ÑÐ½Ð°Ñ ÑÐ¸Ð½ÑÑÐ¾Ð½Ð¸Ð·Ð°ÑÐ¸Ñ**: Ð²Ð¸Ð·ÑÐ°Ð»ÑÐ½ÑÐ¹ ÑÐµÐºÑÑ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÐµÑ Ñ ÑÐµÐ¼, ÑÑÐ¾ Ð¿ÑÐ¾Ð¸Ð·Ð½Ð¾ÑÐ¸ÑÑÑ.
* **RSVPâÑÑÐµÐ½Ð¸Ðµ**: ÑÐ»Ð¾Ð²Ð° Ð¸Ð»Ð¸ ÑÑÐ°Ð·Ñ Ð¿Ð¾ÐºÐ°Ð·ÑÐ²Ð°ÑÑÑÑ Ð¿Ð¾ Ð¾Ð´Ð½Ð¾Ð¼Ñ, ÑÐ¼ÐµÐ½ÑÑÐ°Ñ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ñ Ð³Ð»Ð°Ð·.
* **OfflineâFirst**: ÑÐ°Ð±Ð¾ÑÐ°ÐµÑ Ð¿Ð¾Ð»Ð½Ð¾ÑÑÑÑ Ð¾ÑÐ»Ð°Ð¹Ð½ ÐºÐ°Ðº PWA.
* **ÐÐ¾ÐºÐ°Ð»ÑÐ½ÑÐ¹ TTS**: Ð²ÑÑÐ¾ÐºÐ¾Ðµ ÐºÐ°ÑÐµÑÑÐ²Ð¾ ÑÐ¸Ð½ÑÐµÐ·Ð° ÑÐµÑÐ¸ Ð¿ÑÑÐ¼Ð¾ Ð² Ð±ÑÐ°ÑÐ·ÐµÑÐµ.
* **ÐÐ¸Ð±Ð»Ð¸Ð¾ÑÐµÐºÐ°**: ÑÐµÐºÑÑÑ ÑÑÐ°Ð½ÑÑÑÑ Ð»Ð¾ÐºÐ°Ð»ÑÐ½Ð¾ Ð¸ Ð²ÑÐµÐ³Ð´Ð° Ð´Ð¾ÑÑÑÐ¿Ð½Ñ.

## ÐÑÐ°ÑÐºÐ¾
ÐÑÑÑÑÑÐ¹, Ð¿ÑÐ¸Ð²Ð°ÑÐ½ÑÐ¹ Ð¸ Ð¼Ð¾ÑÐ½ÑÐ¹ Ð¸Ð½ÑÑÑÑÐ¼ÐµÐ½Ñ Ð´Ð»Ñ ÑÑÐµÐ½Ð¸Ñ Ð³Ð»Ð°Ð·Ð°Ð¼Ð¸ Ð¸ ÑÑÐ°Ð¼Ð¸ Ð¾Ð´Ð½Ð¾Ð²ÑÐµÐ¼ÐµÐ½Ð½Ð¾.
`,language:"ru-RU"}],t=e.filter(i=>!n.some(r=>r.title===i.title)),s=e.map(i=>({seed:i,doc:n.find(r=>r.title===i.title)})).filter(i=>i.doc);for(const i of s){const r=i.doc;r.language!==i.seed.language&&await X.updateLanguage(r.id,i.seed.language)}if(t.length){console.log("Seeding welcome documents...");for(const i of t){const r=Wn.tokenize(i.body);await X.createDocument(i.title,i.body,i.body,"markdown",r.length,i.language)}console.log("Welcome documents seeded.")}}const Es="user_settings",Cs={voiceId:"default",speedWpm:250,strategy:"CHUNK",chunkSize:8,lookaheadSec:20,mode:"RSVP",pauseRules:{punctPauseMs:400,paragraphPauseMs:600},tokenizerVersion:"1",playbackRate:1,textSize:1,theme:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"default",readerFontFamily:"literata",readerLineHeight:1.6,orpEnabled:!0,orpIntensity:1,darkMode:void 0,language:"en-US",skipSettings:{seekSec:10,wordCount:1,sentenceCount:1,paragraphCount:1,mediaSkipBackUnit:"paragraph",mediaSkipFwdUnit:"paragraph"}};class fl{async loadSettings(){const e=await $.settings.get(Es);if(!e){const s={id:Es,...Cs};return await $.settings.add(s),Cs}const t={...Cs,...e};return!t.theme&&t.darkMode&&(t.theme="dark"),t}async saveSettings(e){const t=await this.loadSettings(),s={id:Es,...t,...e};await $.settings.put(s)}}const le=new fl,se=n=>`<span class="material-symbols-outlined" aria-hidden="true">${n}</span>`,ce={play:se("play_arrow"),pause:se("pause"),skipWordBack:se("chevron_left"),skipWordFwd:se("chevron_right"),skipSentBack:se("fast_rewind"),skipSentFwd:se("fast_forward"),skipParaBack:se("skip_previous"),skipParaFwd:se("skip_next"),skipChunkBack:se("first_page"),highlight:se("star"),note:se("note_add"),copy:se("content_copy"),seekBack:se("replay_10"),seekFwd:se("forward_10")},Tr=[180,240,300,360],Ue={min:200,max:1400};class gl{constructor(e,t,s=1,i=250,r=1){p(this,"container");p(this,"onPlayPause");p(this,"onSeek");p(this,"onSkip");p(this,"onHighlight");p(this,"onNote");p(this,"onCopySentence");p(this,"onViewChange");p(this,"onSpeedChange");p(this,"onWpmChange");p(this,"onVolumeChange");p(this,"playBtn");p(this,"progressBar");p(this,"speedInput");p(this,"wpmInput");p(this,"volumeInput");p(this,"speedDisplay");p(this,"wpmNumberInput");p(this,"timeDisplay");p(this,"wpmPresetButtons",[]);p(this,"drawerEl");p(this,"backdropEl");p(this,"lastIsPlaying",null);p(this,"lastProgress",null);p(this,"lastTimeCurrent",null);p(this,"lastTimeTotal",null);this.container=e,this.onPlayPause=t.onPlayPause,this.onSeek=t.onSeek,this.onSkip=t.onSkip,this.onHighlight=t.onHighlight,this.onNote=t.onNote,this.onCopySentence=t.onCopySentence,this.onViewChange=t.onViewChange,this.onSpeedChange=t.onSpeedChange,this.onWpmChange=t.onWpmChange,this.onVolumeChange=t.onVolumeChange,this.render(s,i,r),this.bindEvents(),this.setWpm(i)}render(e,t,s){this.container.innerHTML=`
            <!-- Progress bar at top of controls area -->
            <div class="progress-bar-container" id="progress-container">
                <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
            </div>

            <!-- Compact transport bar (always visible) -->
            <div class="controls-transport">
                <div class="time-display" id="time-display">0:00 / 0:00</div>
                <div class="transport-nav">
                    <button class="btn btn-secondary btn-icon btn-sm" id="skip-sent-back" title="Prev Sentence" aria-label="Previous sentence">${ce.skipSentBack}</button>
                    <button class="btn btn-secondary btn-icon btn-sm" id="seek-back" title="Rewind 10s" aria-label="Rewind 10 seconds">${ce.seekBack}</button>
                </div>

                <button class="btn btn-primary btn-icon btn-lg" id="play-pause" title="Play/Pause" aria-label="Play or pause">${ce.play}</button>

                <div class="transport-nav">
                    <button class="btn btn-secondary btn-icon btn-sm" id="seek-fwd" title="Forward 10s" aria-label="Forward 10 seconds">${ce.seekFwd}</button>
                    <button class="btn btn-secondary btn-icon btn-sm" id="skip-sent-fwd" title="Next Sentence" aria-label="Next sentence">${ce.skipSentFwd}</button>
                </div>

            </div>

            <!-- Drawer Handle -->
            <div class="drawer-handle" id="drawer-handle">
                <div class="drawer-handle-inner">
                    ${se("expand_less")}
                    <span class="drawer-handle-label">CONTROLS</span>
                </div>
            </div>

            <!-- Drawer Backdrop -->
            <div class="drawer-backdrop" id="drawer-backdrop"></div>

            <!-- Drawer Panel -->
            <div class="drawer-panel" id="drawer-panel">
                <!-- Drawer header with close handle -->
                <div class="drawer-panel-handle" id="drawer-close">
                    <div class="drawer-handle-inner">
                        ${se("keyboard_arrow_down")}
                        <span class="drawer-handle-label">CONTROLS</span>
                    </div>
                </div>

                <div class="drawer-content">
                    <!-- SPEED Section -->
                    <section class="drawer-section">
                        <div class="drawer-section-header">
                            <label class="drawer-section-title">SPEED</label>
                            <span class="drawer-section-meta" id="speed-val-display">${e.toFixed(1)}x</span>
                        </div>
                        <div class="drawer-section-body">
                            <input type="range" id="speed-input" min="0.5" max="2.0" step="0.1" value="${e}" aria-label="Playback rate">
                            <div class="range-labels">
                                <span>0.5x</span>
                                <span>Rate</span>
                                <span>2.0x</span>
                            </div>
                        </div>
                    </section>

                    <!-- WPM Section -->
                    <section class="drawer-section">
                        <div class="drawer-section-header">
                            <label class="drawer-section-title">WPM</label>
                            <span class="drawer-section-meta"><input type="number" id="wpm-input-number" min="${Ue.min}" max="${Ue.max}" step="10" value="${t}" class="wpm-number-input" aria-label="Words per minute"></span>
                        </div>
                        <div class="drawer-section-body">
                            <input type="range" id="wpm-input" min="${Ue.min}" max="${Ue.max}" step="10" value="${t}" aria-label="Words per minute">
                            <div class="range-labels">
                                <span>${Ue.min}</span>
                                <span>Words/Min</span>
                                <span>${Ue.max}</span>
                            </div>
                            <div class="wpm-presets" id="wpm-presets">
                                ${Tr.map(i=>`<button class="btn btn-secondary btn-sm wpm-preset" data-wpm="${i}">[${i}]</button>`).join("")}
                                <button class="btn btn-secondary btn-sm wpm-preset" data-wpm="custom">[Custom]</button>
                            </div>
                        </div>
                    </section>

                    <!-- MODE Section -->
                    <section class="drawer-section">
                        <div class="drawer-section-header">
                            <label class="drawer-section-title">MODE</label>
                            <span class="drawer-section-meta">ENGINE</span>
                        </div>
                        <div class="drawer-radio-group" id="view-switch-group" aria-label="View mode">
                            <label class="drawer-radio-option">
                                <input type="radio" name="view-mode" value="RSVP" class="sr-only" data-view="RSVP">
                                <span class="drawer-radio-label">[RSVP]</span>
                            </label>
                            <label class="drawer-radio-option">
                                <input type="radio" name="view-mode" value="FOCUS" class="sr-only" data-view="FOCUS">
                                <span class="drawer-radio-label">[FOCUS]</span>
                            </label>
                            <label class="drawer-radio-option">
                                <input type="radio" name="view-mode" value="PARAGRAPH" class="sr-only" data-view="PARAGRAPH">
                                <span class="drawer-radio-label">[PARA]</span>
                            </label>
                        </div>
                    </section>

                    <!-- VOLUME Section -->
                    <section class="drawer-section">
                        <div class="drawer-section-header">
                            <label class="drawer-section-title">VOLUME</label>
                            <span class="drawer-section-meta">${se("volume_up")}</span>
                        </div>
                        <div class="drawer-section-body">
                            <input type="range" id="volume-input" min="0" max="1" step="0.05" value="${s}" aria-label="Volume">
                        </div>
                    </section>

                    <!-- NAVIGATION Section -->
                    <section class="drawer-section">
                        <div class="drawer-section-header">
                            <label class="drawer-section-title">NAVIGATION</label>
                            <span class="drawer-section-meta">SKIP</span>
                        </div>
                        <div class="drawer-nav-grid">
                            <button class="btn btn-secondary btn-icon" id="skip-chunk-back" title="Prev Chunk" aria-label="Previous chunk">${ce.skipChunkBack}</button>
                            <button class="btn btn-secondary btn-icon" id="skip-para-back" title="Prev Â§" aria-label="Previous paragraph">${ce.skipParaBack}</button>
                            <button class="btn btn-secondary btn-icon" id="skip-word-back" title="Prev Word" aria-label="Previous word">${ce.skipWordBack}</button>
                            <button class="btn btn-secondary btn-icon" id="skip-word-fwd" title="Next Word" aria-label="Next word">${ce.skipWordFwd}</button>
                            <button class="btn btn-secondary btn-icon" id="skip-para-fwd" title="Next Â§" aria-label="Next paragraph">${ce.skipParaFwd}</button>
                        </div>
                    </section>

                    <!-- TOOLS Section -->
                    <section class="drawer-section">
                        <div class="drawer-section-header">
                            <label class="drawer-section-title">TOOLS</label>
                            <span class="drawer-section-meta">ACTIONS</span>
                        </div>
                        <div class="drawer-nav-grid">
                            <button class="btn btn-secondary btn-icon" id="highlight-buffer" title="Highlight" aria-label="Highlight buffer">${ce.highlight}</button>
                            <button class="btn btn-secondary btn-icon" id="note-sentence" title="Note" aria-label="Add note">${ce.note}</button>
                            <button class="btn btn-secondary btn-icon" id="copy-sentence" title="Copy" aria-label="Copy sentence">${ce.copy}</button>
                        </div>
                    </section>
                </div>
            </div>
        `,this.playBtn=this.container.querySelector("#play-pause"),this.speedInput=this.container.querySelector("#speed-input"),this.wpmInput=this.container.querySelector("#wpm-input"),this.wpmNumberInput=this.container.querySelector("#wpm-input-number"),this.volumeInput=this.container.querySelector("#volume-input"),this.progressBar=this.container.querySelector("#progress-fill"),this.timeDisplay=this.container.querySelector("#time-display"),this.speedDisplay=this.container.querySelector("#speed-val-display"),this.wpmPresetButtons=Array.from(this.container.querySelectorAll(".wpm-preset")),this.drawerEl=this.container.querySelector("#drawer-panel"),this.backdropEl=this.container.querySelector("#drawer-backdrop")}bindEvents(){this.playBtn.addEventListener("click",()=>{this.onPlayPause()}),this.container.querySelector("#drawer-handle")?.addEventListener("click",()=>this.toggleDrawer(!0)),this.container.querySelector("#drawer-close")?.addEventListener("click",()=>this.toggleDrawer(!1)),this.backdropEl.addEventListener("click",()=>this.toggleDrawer(!1)),this.container.querySelector("#seek-back")?.addEventListener("click",()=>this.onSeek(-10)),this.container.querySelector("#seek-fwd")?.addEventListener("click",()=>this.onSeek(10)),this.container.querySelector("#skip-word-back")?.addEventListener("click",()=>this.onSkip("word",-1)),this.container.querySelector("#skip-word-fwd")?.addEventListener("click",()=>this.onSkip("word",1)),this.container.querySelector("#skip-sent-back")?.addEventListener("click",()=>this.onSkip("sentence",-1)),this.container.querySelector("#skip-sent-fwd")?.addEventListener("click",()=>this.onSkip("sentence",1)),this.container.querySelector("#skip-chunk-back")?.addEventListener("click",()=>this.onSkip("chunk",-1)),this.container.querySelector("#skip-para-back")?.addEventListener("click",()=>this.onSkip("paragraph",-1)),this.container.querySelector("#skip-para-fwd")?.addEventListener("click",()=>this.onSkip("paragraph",1)),this.container.querySelector("#highlight-buffer")?.addEventListener("click",()=>this.onHighlight()),this.container.querySelector("#note-sentence")?.addEventListener("click",()=>this.onNote()),this.container.querySelector("#copy-sentence")?.addEventListener("click",()=>this.onCopySentence()),this.container.querySelectorAll('#view-switch-group input[type="radio"]').forEach(e=>{e.addEventListener("change",()=>{const s=e.value;this.onViewChange(s)})}),this.speedInput.addEventListener("input",e=>{const t=parseFloat(e.target.value);this.speedDisplay.textContent=`[${t.toFixed(1)}x]`,this.onSpeedChange(t)}),this.wpmInput.addEventListener("change",e=>{const t=parseInt(e.target.value,10);this.updateWpmInputs(t,!1),this.onWpmChange(t)}),this.wpmInput.addEventListener("input",e=>{const t=parseInt(e.target.value,10);this.updateWpmInputs(t,!1)}),this.wpmNumberInput.addEventListener("input",e=>{const t=parseInt(e.target.value,10);Number.isNaN(t)||this.updateWpmInputs(t,!1)}),this.wpmNumberInput.addEventListener("change",e=>{const t=parseInt(e.target.value,10);if(Number.isNaN(t))return;const s=this.clampWpm(t);this.updateWpmInputs(s,!1),this.onWpmChange(s)}),this.wpmPresetButtons.forEach(e=>{e.addEventListener("click",t=>{const i=t.currentTarget.dataset.wpm||"";if(i==="custom"){this.wpmNumberInput.focus(),this.setPresetActive(null);return}const r=parseInt(i,10);if(Number.isNaN(r))return;const a=this.clampWpm(r);this.updateWpmInputs(a,!0),this.onWpmChange(a)})}),this.volumeInput.addEventListener("input",e=>{const t=parseFloat(e.target.value);this.onVolumeChange(t)})}toggleDrawer(e){this.drawerEl.classList.toggle("open",e),this.backdropEl.classList.toggle("open",e),document.body.classList.toggle("drawer-open",e)}setPlaying(e){this.lastIsPlaying!==e&&(this.lastIsPlaying=e,this.playBtn.innerHTML=e?ce.pause:ce.play,this.playBtn.title=e?"Pause":"Play",this.playBtn.classList.toggle("btn-primary",!e),this.playBtn.classList.toggle("btn-secondary",e))}setProgress(e){Math.abs((this.lastProgress||0)-e)<.1||(this.lastProgress=e,this.progressBar.style.width=`${Math.max(0,Math.min(100,e))}%`)}setTime(e,t){this.lastTimeCurrent===e&&this.lastTimeTotal===t||(this.lastTimeCurrent=e,this.lastTimeTotal=t,this.timeDisplay.textContent=`${e} / ${t}`)}setPlaybackRate(e){this.speedInput&&(this.speedInput.value=e.toString()),this.speedDisplay&&(this.speedDisplay.textContent=`[${e.toFixed(1)}x]`)}setWpm(e){this.updateWpmInputs(e,!1)}updateSpeed(e,t){this.setPlaybackRate(e),this.setWpm(t)}setActiveView(e){this.container.querySelectorAll('#view-switch-group input[type="radio"]').forEach(t=>{const s=t;s.checked=s.value===e})}setWpmRange(e,t){this.wpmInput.min=e.toString(),this.wpmInput.max=t.toString(),this.wpmNumberInput.min=e.toString(),this.wpmNumberInput.max=t.toString();const s=parseInt(this.wpmNumberInput.value,10),i=this.clampWpm(Number.isNaN(s)?e:s);return this.updateWpmInputs(i,!1),i}updateWpmInputs(e,t){const s=this.clampWpm(e);this.wpmInput.value=s.toString(),this.wpmNumberInput.value=s.toString(),this.setPresetActive(t?s:this.getPresetMatch(s))}clampWpm(e){const t=parseInt(this.wpmInput.min,10),s=parseInt(this.wpmInput.max,10),i=Number.isNaN(t)?Ue.min:t,r=Number.isNaN(s)?Ue.max:s;return Math.min(r,Math.max(i,e))}setPresetActive(e){const t=this.getPresetMatch(e??null);this.wpmPresetButtons.forEach(s=>{const i=s.dataset.wpm||"",a=t===null?i==="custom":i===t.toString();s.classList.toggle("active",a)})}getPresetMatch(e){return e===null?null:Tr.includes(e)?e:null}}const ml="0.2.0-beta.0",yl='<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L10.59 13.4 4.29 19.71 2.88 18.3 9.17 12 2.88 5.71 4.29 4.29 10.59 10.6l6.3-6.3z"/></svg>';class kl{constructor(e,t,s){p(this,"container");p(this,"callbacks");p(this,"voices",[]);p(this,"currentSettings");p(this,"isInstalling",!1);this.container=e,this.callbacks=t,this.currentSettings=s}setVoices(e){this.voices=e,this.container.innerHTML&&this.mount()}mount(){const e=Array.from(new Set(this.voices.map(h=>h.lang))).sort(),t=h=>({"en-US":"English (US)","es-ES":"Spanish (ES)","fr-FR":"French (FR)","de-DE":"German (DE)","ru-RU":"Russian (RU)"})[h]||h,s=e.map(h=>`<option value="${h}" ${h===this.currentSettings.language?"selected":""}>${t(h)}</option>`).join(""),r=this.voices.filter(h=>h.lang===this.currentSettings.language).map(h=>`<option value="${h.id}" ${h.id===this.currentSettings.voiceId?"selected":""}>${h.name}${h.isInstalled?"":" (Download)"}</option>`).join(""),a=this.currentSettings.theme||"default",l=this.currentSettings.readerFontFamily||"literata",o=this.currentSettings.readerLineHeight||1.6,u=this.currentSettings.orpIntensity??1,c=this.voices.find(h=>h.id===this.currentSettings.voiceId),d=c&&!c.isInstalled;this.container.innerHTML=`
            <div class="settings-modal-overlay">
                <div class="settings-modal">
                    <header class="settings-header">
                        <h2>Settings</h2>
                        <button class="btn btn-secondary btn-icon" id="close-settings" title="Close" aria-label="Close">
                            ${yl}
                        </button>
                    </header>

                    <div class="settings-content">
                        <section class="settings-group">
                            <h3>Language</h3>
                            <select id="lang-select" class="input">
                                ${s}
                            </select>
                        </section>

                        <section class="settings-group">
                            <h3>Voice</h3>
                            <div style="display: flex; gap: 0.5rem; flex-direction: column;">
                                <select id="voice-select" class="input">
                                    ${r}
                                </select>
                                ${d?`
                                    <button class="btn btn-primary" id="install-voice" ${this.isInstalling?"disabled":""}>
                                        ${this.isInstalling?"Downloading...":"Download Voice"}
                                    </button>
                                    <p class="info-text">This voice must be downloaded before it can be used.</p>
                                `:""}
                            </div>
                        </section>

                        <section class="settings-group">
                            <h3>Reading Speed</h3>
                            <div class="range-control">
                                <input type="range" min="100" max="1400" step="10" id="speed-range" value="${this.currentSettings.speedWpm}">
                                <span id="speed-value">${this.currentSettings.speedWpm} WPM</span>
                            </div>
                        </section>

                        <section class="settings-group">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <h3>Strategy</h3>
                                <span class="info-badge" title="Determines how the text is divided for synthesis and highlighting.">i</span>
                            </div>
                            <div class="radio-group" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <label>
                                    <input type="radio" name="strategy" value="TOKEN" ${this.currentSettings.strategy==="TOKEN"?"checked":""}>
                                    Word by Word
                                </label>
                                <label>
                                    <input type="radio" name="strategy" value="CHUNK" ${this.currentSettings.strategy==="CHUNK"?"checked":""}>
                                    Chunked (Natural)
                                </label>
                            </div>
                            <p class="info-text">
                                <strong>Word by Word:</strong> Highlights each word as it's spoken. Best for focus.<br>
                                <strong>Chunked:</strong> Groups words into phrases. Better for natural speech rhythm.
                            </p>
                        </section>

                        <section class="settings-group">
                            <h3>Display</h3>
                            <div class="range-control" style="margin-bottom: 0.75rem;">
                                <label for="theme-select" style="font-size: 0.9rem; color: var(--color-text-secondary);">Theme</label>
                                <select id="theme-select" class="input">
                                    <option value="default" ${a==="default"?"selected":""}>Default</option>
                                    <option value="calm" ${a==="calm"?"selected":""}>Calm</option>
                                    <option value="dark" ${a==="dark"?"selected":""}>Dark</option>
                                </select>
                            </div>
                            <div class="range-control" style="margin-bottom: 0.75rem;">
                                <label for="font-family-select" style="font-size: 0.9rem; color: var(--color-text-secondary);">Font</label>
                                <select id="font-family-select" class="input">
                                    <option value="literata" ${l==="literata"?"selected":""}>Literata</option>
                                    <option value="source-serif" ${l==="source-serif"?"selected":""}>Source Serif 4</option>
                                    <option value="atkinson" ${l==="atkinson"?"selected":""}>Atkinson Hyperlegible</option>
                                </select>
                            </div>
                            <div class="range-control" style="margin-bottom: 0.75rem;">
                                <label for="line-height-range" style="font-size: 0.9rem; color: var(--color-text-secondary);">Line Height</label>
                                <input type="range" min="1.2" max="2.2" step="0.05" id="line-height-range" value="${o}">
                                <span id="line-height-value">${o.toFixed(2)}</span>
                            </div>
                            <div class="range-control">
                                <label for="text-size-range" style="font-size: 0.9rem; color: var(--color-text-secondary);">Text Size</label>
                                <input type="range" min="0.5" max="2.0" step="0.1" id="text-size-range" value="${this.currentSettings.textSize||1}">
                                <span id="text-size-value">${this.currentSettings.textSize||1}x</span>
                            </div>
                        </section>

                        <section class="settings-group">
                            <h3>ORP Highlight</h3>
                            <div style="margin-bottom: 0.75rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="orp-toggle" ${this.currentSettings.orpEnabled!==!1?"checked":""}>
                                    Enable ORP
                                </label>
                            </div>
                            <div class="range-control">
                                <label for="orp-intensity" style="font-size: 0.9rem; color: var(--color-text-secondary);">Intensity</label>
                                <input type="range" min="0" max="1" step="0.05" id="orp-intensity" value="${u}">
                                <span id="orp-intensity-value">${u.toFixed(2)}</span>
                            </div>
                        </section>

                        <section class="settings-group">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <h3>Skip Intervals</h3>
                                <span class="info-badge" title="Configure how much text is skipped when using previous/next controls.">i</span>
                            </div>
                            <div class="range-control">
                                <label style="font-size: 0.8rem; color: var(--color-text-secondary);">Seek (Seconds)</label>
                                <input type="range" min="5" max="60" step="5" id="skip-seek" value="${this.currentSettings.skipSettings?.seekSec||10}">
                                <span id="skip-seek-value">${this.currentSettings.skipSettings?.seekSec||10}s</span>
                            </div>
                            <div class="range-control">
                                <label style="font-size: 0.8rem; color: var(--color-text-secondary);">Words</label>
                                <input type="range" min="1" max="20" step="1" id="skip-words" value="${this.currentSettings.skipSettings?.wordCount||1}">
                                <span id="skip-words-value">${this.currentSettings.skipSettings?.wordCount||1}</span>
                            </div>
                            <div class="range-control">
                                <label style="font-size: 0.8rem; color: var(--color-text-secondary);">Sentences</label>
                                <input type="range" min="1" max="10" step="1" id="skip-sentences" value="${this.currentSettings.skipSettings?.sentenceCount||1}">
                                <span id="skip-sentences-value">${this.currentSettings.skipSettings?.sentenceCount||1}</span>
                            </div>
                            <div class="range-control">
                                <label style="font-size: 0.8rem; color: var(--color-text-secondary);">Paragraphs</label>
                                <input type="range" min="1" max="5" step="1" id="skip-paragraphs" value="${this.currentSettings.skipSettings?.paragraphCount||1}">
                                <span id="skip-paragraphs-value">${this.currentSettings.skipSettings?.paragraphCount||1}</span>
                            </div>

                            <div style="margin-top: 1rem;">
                                <label style="font-size: 0.8rem; color: var(--color-text-secondary); display: block; margin-bottom: 0.5rem;">Headset Previous Action</label>
                                <select id="media-skip-back-unit" class="input" style="width: 100%;">
                                    <option value="word" ${this.currentSettings.skipSettings?.mediaSkipBackUnit==="word"?"selected":""}>Skip Word Back</option>
                                    <option value="sentence" ${this.currentSettings.skipSettings?.mediaSkipBackUnit==="sentence"?"selected":""}>Skip Sentence Back</option>
                                    <option value="paragraph" ${!this.currentSettings.skipSettings?.mediaSkipBackUnit||this.currentSettings.skipSettings?.mediaSkipBackUnit==="paragraph"?"selected":""}>Skip Paragraph Back</option>
                                    <option value="seek" ${this.currentSettings.skipSettings?.mediaSkipBackUnit==="seek"?"selected":""}>Seek Time Back</option>
                                </select>
                            </div>
                            <div style="margin-top: 0.5rem;">
                                <label style="font-size: 0.8rem; color: var(--color-text-secondary); display: block; margin-bottom: 0.5rem;">Headset Next Action</label>
                                <select id="media-skip-fwd-unit" class="input" style="width: 100%;">
                                    <option value="word" ${this.currentSettings.skipSettings?.mediaSkipFwdUnit==="word"?"selected":""}>Skip Word Forward</option>
                                    <option value="sentence" ${this.currentSettings.skipSettings?.mediaSkipFwdUnit==="sentence"?"selected":""}>Skip Sentence Forward</option>
                                    <option value="paragraph" ${!this.currentSettings.skipSettings?.mediaSkipFwdUnit||this.currentSettings.skipSettings?.mediaSkipFwdUnit==="paragraph"?"selected":""}>Skip Paragraph Forward</option>
                                    <option value="seek" ${this.currentSettings.skipSettings?.mediaSkipFwdUnit==="seek"?"selected":""}>Seek Time Forward</option>
                                </select>
                            </div>
                        </section>



                        <div class="settings-footer">
                            Version ${ml}
                        </div>
                    </div>
                </div>
            </div>
        `,this.bindEvents()}bindEvents(){this.container.querySelector("#close-settings")?.addEventListener("click",()=>this.callbacks.onClose()),this.container.querySelector("#lang-select")?.addEventListener("change",v=>{const O=v.currentTarget.value;this.currentSettings.language=O,this.callbacks.onLanguageChange(O);const E=this.voices.find(B=>B.lang===O);E&&(this.currentSettings.voiceId=E.id,this.callbacks.onVoiceChange(E.id)),this.mount()}),this.container.querySelector("#voice-select")?.addEventListener("change",v=>{const O=v.target.value;this.callbacks.onVoiceChange(O),this.mount()}),this.container.querySelector("#install-voice")?.addEventListener("click",async()=>{this.isInstalling=!0,this.mount();try{await this.callbacks.onInstallVoice(this.currentSettings.voiceId)}finally{this.isInstalling=!1,this.mount()}});const i=this.container.querySelector("#speed-range"),r=this.container.querySelector("#speed-value");i?.addEventListener("input",()=>{const v=parseInt(i.value);r&&(r.textContent=`${v} WPM`),this.callbacks.onSpeedChange(v)}),this.container.querySelectorAll('input[name="strategy"]').forEach(v=>{v.addEventListener("change",O=>{const E=O.target.value;this.callbacks.onStrategyChange(E)})});const l=this.container.querySelector("#theme-select");l?.addEventListener("change",()=>{const v=l.value;this.currentSettings.theme=v,this.callbacks.onThemeChange(v)});const o=this.container.querySelector("#font-family-select");o?.addEventListener("change",()=>{const v=o.value;this.currentSettings.readerFontFamily=v,this.callbacks.onFontFamilyChange(v)});const u=this.container.querySelector("#line-height-range"),c=this.container.querySelector("#line-height-value");u?.addEventListener("input",()=>{const v=parseFloat(u.value);this.currentSettings.readerLineHeight=v,c&&(c.textContent=v.toFixed(2)),this.callbacks.onLineHeightChange(v)});const d=this.container.querySelector("#orp-toggle");d?.addEventListener("change",()=>{this.currentSettings.orpEnabled=d.checked,this.callbacks.onOrpToggle(d.checked)});const h=this.container.querySelector("#orp-intensity"),g=this.container.querySelector("#orp-intensity-value");h?.addEventListener("input",()=>{const v=parseFloat(h.value);this.currentSettings.orpIntensity=v,g&&(g.textContent=v.toFixed(2)),this.callbacks.onOrpIntensityChange(v)});const m=this.container.querySelector("#text-size-range"),y=this.container.querySelector("#text-size-value");m?.addEventListener("input",()=>{const v=parseFloat(m.value);y&&(y.textContent=`${v}x`),this.callbacks.onTextSizeChange(v)});const w=this.container.querySelector("#skip-seek"),b=this.container.querySelector("#skip-words"),k=this.container.querySelector("#skip-sentences"),S=this.container.querySelector("#skip-paragraphs"),x=this.container.querySelector("#media-skip-back-unit"),C=this.container.querySelector("#media-skip-fwd-unit"),I=()=>{const v={seekSec:parseInt(w.value),wordCount:parseInt(b.value),sentenceCount:parseInt(k.value),paragraphCount:parseInt(S.value),mediaSkipBackUnit:x.value,mediaSkipFwdUnit:C.value};this.currentSettings.skipSettings=v,this.callbacks.onSkipSettingsChange(v),this.container.querySelector("#skip-seek-value").textContent=`${v.seekSec} s`,this.container.querySelector("#skip-words-value").textContent=`${v.wordCount} `,this.container.querySelector("#skip-sentences-value").textContent=`${v.sentenceCount} `,this.container.querySelector("#skip-paragraphs-value").textContent=`${v.paragraphCount} `};w?.addEventListener("input",I),b?.addEventListener("input",I),k?.addEventListener("input",I),S?.addEventListener("input",I),x?.addEventListener("change",I),C?.addEventListener("change",I)}unmount(){this.container.innerHTML=""}}function bl(n){const e=`(() => {
        const sel = getSelection();
        if (!sel || sel.rangeCount === 0 || sel.isCollapsed) {
            alert('Please select some text to clip to Spirtz Voice.');
            return;
        }
        const r = sel.getRangeAt(0).cloneRange();
        const div = document.createElement("div");
        div.appendChild(r.cloneContents());
        const esc = t => t.replace(/\\r/g, "").replace(/\\u00a0/g, " ").replace(/[ \\t]+\\n/g, "\\n").replace(/[ \\t]{2,}/g, " ").replace(/\\n{3,}/g, "\\n\\n");
        const md = (n, ctx = { li: false }) => {
            if (!n) return "";
            if (n.nodeType === 3) return n.nodeValue;
            if (n.nodeType !== 1) return "";
            const t = n.tagName.toLowerCase();
            const kids = () => Array.from(n.childNodes).map(c => md(c, ctx)).join("");
            const txt = () => esc(kids());
            const block = s => s.trim().replace(/\\n{3,}/g, "\\n\\n");
            if (t === "br") return "\\n";
            if (t === "p") return "\\n\\n" + block(txt()) + "\\n\\n";
            if (t === "div") return "\\n\\n" + block(txt()) + "\\n\\n";
            if (/^h[1-6]$/.test(t)) return "\\n\\n" + ("#".repeat(+t[1]) + " " + block(txt()).trim()) + "\\n\\n";
            if (t === "strong" || t === "b") return "**" + txt() + "**";
            if (t === "em" || t === "i") return "*" + txt() + "*";
            if (t === "u") return "__" + txt() + "__";
            if (t === "s" || t === "del" || t === "strike") return "~~" + txt() + "~~";
            if (t === "code" && n.parentElement && n.parentElement.tagName.toLowerCase() === "pre") return n.textContent.replace(/\\n$/, "");
            if (t === "code") return "\`" + n.textContent.replace(/\`/g, "\\\`") + "\`";
            if (t === "pre") { const c = n.querySelector("code"); const body = (c ? c.textContent : n.textContent).replace(/\\n$/, ""); return "\\n\\n\`\`\`\\n" + body + "\\n\`\`\`\\n\\n"; }
            if (t === "a") { const href = n.getAttribute("href") || ""; const label = block(txt()).trim() || href; return href ? \`[\${label}](\${href})\` : label; }
            if (t === "img") { const alt = n.getAttribute("alt") || ""; const src = n.getAttribute("src") || ""; return src ? \`![\${alt}](\${src})\` : ""; }
            if (t === "blockquote") { const inner = block(txt()).trim().split("\\n").map(l => "> " + l).join("\\n"); return "\\n\\n" + inner + "\\n\\n"; }
            if (t === "ul" || t === "ol") { const isOl = t === "ol"; let i = 1; const out = Array.from(n.children).filter(ch => ch.tagName && ch.tagName.toLowerCase() === "li").map(li => { const body = block(Array.from(li.childNodes).map(c => md(c, { li: true })).join("")).trim().replace(/\\n/g, "\\n    "); const prefix = isOl ? \`\${i++}. \` : "- "; return prefix + body; }).join("\\n"); return "\\n\\n" + out + "\\n\\n"; }
            if (t === "li") return block(txt()).trim();
            if (t === "hr") return "\\n\\n---\\n\\n";
            if (t === "table") { const rows = Array.from(n.querySelectorAll("tr")).map(tr => Array.from(tr.children).map(td => block(esc(td.textContent)).trim())); if (!rows.length) return ""; const head = rows[0]; const body = rows.slice(1); const line = a => "| " + a.map(x => x.replace(/\\|/g, "\\\\|")).join(" | ") + " |"; const sep = "| " + head.map(() => ":---").join(" | ") + " |"; return "\\n\\n" + [line(head), sep, ...body.map(line)].join("\\n") + "\\n\\n"; }
            return txt();
        };

        const out = md(div).replace(/[ \\t]+\\n/g, "\\n").replace(/\\n{3,}/g, "\\n\\n").trim();
        const title = document.title || "Selected Text";
        
        const targetUrl = new URL('${n}');
        targetUrl.searchParams.set('title', title);
        targetUrl.searchParams.set('text', out);
        targetUrl.searchParams.set('url', window.location.href);
        window.open(targetUrl.toString(), '_blank');
    })();`;return`javascript:${encodeURIComponent(e.replace(/\s+/g," ").trim())}`}const Tt=n=>`<span class="material-symbols-outlined" aria-hidden="true">${n}</span>`,st={library:Tt("list"),newDoc:Tt("add"),settings:Tt("settings"),install:Tt("download"),close:Tt("close"),info:Tt("info")};class vl{constructor(e,t){p(this,"container");p(this,"onClose");this.container=e,this.onClose=t}mount(){const e=window.location.origin+window.location.pathname,t=bl(e);this.container.innerHTML=`
            <div class="settings-modal-overlay">
                <div class="settings-modal">
                    <header class="settings-header">
                        <h2>Info & Help</h2>
                        <button class="btn btn-secondary btn-icon" id="close-info" title="Close" aria-label="Close">
                            ${st.close}
                        </button>
                    </header>

                    <div class="settings-content">
                        <section class="settings-group">
                            <h3>ð Welcome</h3>
                            <p class="info-text">
                                Spirtz Voice helps you read faster and listen to your documents at the same time. it's 100% offline and private.
                            </p>
                        </section>

                        <section class="settings-group">
                            <h3>ð Reading Modes</h3>
                            <div class="info-item">
                                <strong>Speed Reader (RSVP):</strong>
                                <p class="info-text">Shows one word at a time in the center. Stops your eyes from moving, letting you read much faster.</p>
                            </div>
                            <div class="info-item">
                                <strong>Paragraph View:</strong>
                                <p class="info-text">Traditional layout. Highlights words as they are spoken. Great for comprehension.</p>
                            </div>
                            <div class="info-item">
                                <strong>Focus View:</strong>
                                <p class="info-text">Distraction-free mode. Shuts out everything but the text.</p>
                            </div>
                        </section>

                        <section class="settings-group">
                            <h3>â¡ Speed & Settings</h3>
                            <div class="info-item">
                                <strong>WPM (Words Per Minute):</strong>
                                <p class="info-text">Controls how fast you read. Faster WPM = faster voice and faster flashing words. 250 WPM is a normal reading speed.</p>
                            </div>
                        </section>

                        <section class="settings-group">
                            <h3>â¨ï¸ Shortcuts</h3>
                            <div class="shortcut-list">
                                <div class="help-row"><span class="help-key">Space</span><span class="help-desc">Play / Pause</span></div>
                                <div class="help-row"><span class="help-key">Left / Right</span><span class="help-desc">Prev / Next Chunk</span></div>
                                <div class="help-row"><span class="help-key">Shift + Left / Right</span><span class="help-desc">Prev / Next Sentence</span></div>
                                <div class="help-row"><span class="help-key">+ / -</span><span class="help-desc">Increase / Decrease Speed</span></div>
                                <div class="help-row"><span class="help-key">Esc</span><span class="help-desc">Paging / Exit Focus</span></div>
                                <div class="help-row"><span class="help-key">?</span><span class="help-desc">Keyboard Help</span></div>
                            </div>
                        </section>

                        <section class="settings-group">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <h3>âï¸ Web Clipper</h3>
                                <span class="info-badge" title="Bookmarket to clip text from other websites to Spirtz Voice.">i</span>
                            </div>
                            <p class="info-text" style="margin-bottom: 1rem;">
                                Drag this button to your bookmarks bar to clip text from any website:
                            </p>
                            <div style="text-align: center; margin-bottom: 1rem;">
                                <a href="${t}" class="btn btn-primary" style="text-decoration: none; cursor: grab;" onclick="return false;">
                                    Clip to Spirtz
                                </a>
                            </div>
                            <p class="info-text" style="font-size: 0.8rem; color: var(--color-text-secondary);">
                                <strong>How to use:</strong> Select text on any webpage and click the "Clip to Spirtz" bookmark to transfer it here.
                            </p>
                        </section>
                    </div>
                </div>
            </div>
        `,this.container.querySelector(".settings-modal-overlay")?.addEventListener("click",s=>{s.target===s.currentTarget&&this.unmount()}),this.container.querySelector("#close-info")?.addEventListener("click",()=>{this.unmount()})}unmount(){this.container.innerHTML="",this.onClose()}}const wl="modulepreload",xl=function(n){return"/spirtzVioice/beta/"+n},Er={},Gt=function(e,t,s){let i=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),l=a?.nonce||a?.getAttribute("nonce");i=Promise.allSettled(t.map(o=>{if(o=xl(o),o in Er)return;Er[o]=!0;const u=o.endsWith(".css"),c=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${o}"]${c}`))return;const d=document.createElement("link");if(d.rel=u?"stylesheet":wl,u||(d.as="script"),d.crossOrigin="",d.href=o,l&&d.setAttribute("nonce",l),document.head.appendChild(d),u)return new Promise((h,g)=>{d.addEventListener("load",h),d.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${o}`)))})}))}function r(a){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=a,window.dispatchEvent(l),!l.defaultPrevented)throw a}return i.then(a=>{for(const l of a||[])l.status==="rejected"&&r(l.reason);return e().catch(r)})};class Sl{constructor(e,t){p(this,"container");p(this,"onSubmit");this.container=e,this.onSubmit=t}mount(){this.container.innerHTML=`
            <div class="text-input-container">
                <h2>New Document</h2>
                <div class="file-upload-zone" id="drop-zone" style="border: 2px dashed #ccc; padding: 20px; text-align: center; margin-bottom: 20px; border-radius: 8px; cursor: pointer;">
                    <p>Drag & drop files here or <strong>click to upload</strong></p>
                    <input type="file" id="file-input" accept=".txt,.md,.html" multiple style="display: none;">
                    <small style="color: #666;">Supports .txt, .md, .html (Multiple allowed)</small>
                </div>
                <div id="file-list-preview" style="display: none; margin-bottom: 20px; background: var(--color-bg-secondary); padding: 10px; border-radius: 8px;">
                    <h4 style="margin-bottom: 5px;">Selected Files:</h4>
                    <ul id="selected-files-list" style="max-height: 150px; overflow-y: auto; font-size: 0.9rem; padding-left: 20px;"></ul>
                </div>
                <div id="manual-entry-form">
                    <input type="text" id="doc-title" class="input" placeholder="Document Title" style="margin-bottom: 10px;">
                    <textarea id="doc-text" class="input" rows="10" placeholder="Paste text here..."></textarea>
                </div>
                <div class="actions" style="margin-top: 20px; display: flex; justify-content: flex-end;">
                    <button class="btn" id="start-reading">Start Reading</button>
                    <button class="btn" id="bulk-import" style="display: none;">Import All Files</button>
                </div>
            </div>
        `;const e=this.container.querySelector("#drop-zone"),t=this.container.querySelector("#file-input"),s=this.container.querySelector("#doc-title"),i=this.container.querySelector("#doc-text"),r=this.container.querySelector("#bulk-import"),a=this.container.querySelector("#start-reading");e?.addEventListener("click",()=>t.click()),e?.addEventListener("dragover",l=>{l.preventDefault(),e.style.borderColor="var(--color-primary)",e.style.backgroundColor="rgba(59, 130, 246, 0.1)"}),e?.addEventListener("dragleave",()=>{e.style.borderColor="#ccc",e.style.backgroundColor="transparent"}),e?.addEventListener("drop",async l=>{l.preventDefault(),e.style.borderColor="#ccc",e.style.backgroundColor="transparent";const o=l.dataTransfer?.files;o&&o.length>0&&await this.handleFiles(o)}),t?.addEventListener("change",async l=>{const o=l.target.files;o&&o.length>0&&await this.handleFiles(o)}),a?.addEventListener("click",async()=>{const l=s.value,o=i.value;if(l&&o){const u=i._originalContent||o,c=i._ttsContent||o,d=i._contentType||"text";let h=i._language;if(!h){const{detectLanguage:g}=await Gt(async()=>{const{detectLanguage:m}=await import("./languageUtils-CxMkndAP.js");return{detectLanguage:m}},[]);h=g(c)}this.onSubmit([{title:l,originalText:u,ttsText:c,contentType:d,language:h}])}}),r?.addEventListener("click",()=>{const l=this._pendingFiles;l&&l.length>0&&this.onSubmit(l)})}async handleFiles(e){if(e.length===1){await this.handleSingleFile(e[0]);return}const t=this.container.querySelector("#manual-entry-form"),s=this.container.querySelector("#file-list-preview"),i=this.container.querySelector("#selected-files-list"),r=this.container.querySelector("#bulk-import"),a=this.container.querySelector("#start-reading");t&&(t.style.display="none"),s&&(s.style.display="block"),r&&(r.style.display="block"),a&&(a.style.display="none"),i&&(i.innerHTML="");const l=[];for(const o of Array.from(e)){const u=document.createElement("li");u.textContent=`Loading ${o.name}...`,i&&i.appendChild(u);try{const c=await this.processFile(o);l.push(c),u.textContent=`â ${o.name}`}catch(c){u.textContent=`â ${o.name} (Error)`,console.error(c)}}this._pendingFiles=l,r&&(r.textContent=`Import ${l.length} Files`)}async handleSingleFile(e){const t=this.container.querySelector("#doc-title"),s=this.container.querySelector("#doc-text"),i=this.container.querySelector("#manual-entry-form"),r=this.container.querySelector("#file-list-preview"),a=this.container.querySelector("#bulk-import"),l=this.container.querySelector("#start-reading");i&&(i.style.display="block"),r&&(r.style.display="none"),a&&(a.style.display="none"),l&&(l.style.display="block");try{const o=await this.processFile(e);t&&(t.value=o.title),s&&(s.value=o.originalText,s._originalContent=o.originalText,s._ttsContent=o.ttsText,s._contentType=o.contentType,s._language=o.language)}catch(o){console.error("Error reading file:",o),alert("Failed to read file.")}}async processFile(e){const t=await e.text();let s,i="text";if(e.name.endsWith(".html")){const{extractTextFromHtml:l}=await Gt(async()=>{const{extractTextFromHtml:o}=await import("./htmlUtils-BTR5zQYA.js");return{extractTextFromHtml:o}},[]);s=l(t),i="html"}else if(e.name.endsWith(".md")){const{stripMarkdown:l}=await Gt(async()=>{const{stripMarkdown:o}=await import("./markdownUtils-C7TC5Qiw.js");return{stripMarkdown:o}},[]);s=l(t),i="markdown"}else s=t,i="text";const{detectLanguage:r}=await Gt(async()=>{const{detectLanguage:l}=await import("./languageUtils-CxMkndAP.js");return{detectLanguage:l}},[]),a=r(s);return{title:e.name.replace(/\.[^/.]+$/,""),originalText:t,ttsText:s,contentType:i,language:a}}unmount(){this.container.innerHTML=""}}const Is={play:'<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>',trash:'<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M6 7h12l-1 14H7L6 7zm3-3h6l1 2H8l1-2z"/></svg>'};class Tl{constructor(e,t){p(this,"container");p(this,"callbacks");p(this,"selectedIds",new Set);p(this,"documents",[]);p(this,"filterText","");p(this,"sortBy","recent");this.container=e,this.callbacks=t}async mount(){this.documents=await X.getAllDocuments(),this.selectedIds.clear(),this.render()}render(){if(this.documents.length===0){this.container.innerHTML=`
                <div class="document-list-container">
                    <div class="library-header">
                        <div class="library-title">
                            <span class="library-eyebrow">Library</span>
                            <h2>Your Library</h2>
                        </div>
                    </div>
                    <div class="empty-state" style="text-align: center; padding: 60px 20px; color: #666;">
                        <p style="font-size: 1.2rem; margin-bottom: 20px;">No documents yet</p>
                        <button class="btn" id="btn-new-from-empty">Create Your First Document</button>
                    </div>
                </div>
            `,this.container.querySelector("#btn-new-from-empty")?.addEventListener("click",()=>{this.callbacks.onNewDocument()});return}const e=this.documents.filter(r=>r.title.toLowerCase().includes(this.filterText.toLowerCase())).sort((r,a)=>{if(this.sortBy==="title")return r.title.localeCompare(a.title);if(this.sortBy==="progress"){const l=r.progressTokenIndex/(r.originalText.length||1);return a.progressTokenIndex/(a.originalText.length||1)-l}else return a.lastReadAt-r.lastReadAt}),t=e.map(r=>this.renderDocumentItem(r)).join(""),s=e.length>0&&e.every(r=>this.selectedIds.has(r.id)),i=this.selectedIds.size>0;this.container.innerHTML=`
            <div class="document-list-container">
                <div class="library-header">
                    <div class="library-title">
                        <span class="library-eyebrow">Library</span>
                        <h2>Your Library</h2>
                    </div>
                    <div class="library-controls">
                        <div class="search-box">
                            <input type="text" id="doc-search" class="input" placeholder="Search documents..." value="${this.escapeHtml(this.filterText)}">
                        </div>
                        <div class="sort-controls">
                            <select id="doc-sort" class="input">
                                <option value="recent" ${this.sortBy==="recent"?"selected":""}>Recent</option>
                                <option value="title" ${this.sortBy==="title"?"selected":""}>Title (A-Z)</option>
                                <option value="progress" ${this.sortBy==="progress"?"selected":""}>Progress</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="bulk-actions-bar ${i?"visible":""}">
                    <label class="select-all-label">
                        <input type="checkbox" id="select-all" ${s?"checked":""}>
                        <span>Select All ${this.filterText?"(Filtered)":""}</span>
                    </label>
                    <button class="btn btn-danger btn-sm btn-icon" id="btn-delete-selected" data-count="${this.selectedIds.size}" title="Delete Selected (${this.selectedIds.size})" aria-label="Delete Selected (${this.selectedIds.size})" ${i?"":"disabled"}>
                        ${Is.trash}
                    </button>
                </div>

                <div class="document-list-scroll-area">
                    <div class="document-list">
                        ${t}
                        ${e.length===0?'<div class="no-results">No documents match your search</div>':""}
                    </div>
                </div>
            </div>
        `,this.container.querySelector("#doc-search")?.addEventListener("input",r=>{this.filterText=r.target.value,this.render();const a=this.container.querySelector("#doc-search");a.focus(),a.setSelectionRange(a.value.length,a.value.length)}),this.container.querySelector("#doc-sort")?.addEventListener("change",r=>{this.sortBy=r.target.value,this.render()}),this.container.querySelector("#select-all")?.addEventListener("change",r=>{r.target.checked?e.forEach(l=>this.selectedIds.add(l.id)):e.forEach(l=>this.selectedIds.delete(l.id)),this.render()}),this.container.querySelector("#btn-delete-selected")?.addEventListener("click",()=>{this.confirmBulkDelete()}),this.documents.forEach(r=>{const a=this.container.querySelector(`.document-item[data-id="${r.id}"]`),l=this.container.querySelector(`#resume-${r.id}`),o=this.container.querySelector(`#delete-${r.id}`),u=this.container.querySelector(`#select-${r.id}`);a?.addEventListener("click",c=>{const d=c.target;d.closest("button")||d.closest('input[type="checkbox"]')||this.callbacks.onResume(r.id)}),l?.addEventListener("click",()=>this.callbacks.onResume(r.id)),o?.addEventListener("click",()=>this.confirmDelete(r)),u?.addEventListener("change",()=>{u.checked?this.selectedIds.add(r.id):this.selectedIds.delete(r.id),this.render()})})}renderDocumentItem(e){const t=this.formatRelativeTime(e.lastReadAt),s=e.totalTokens||e.originalText.split(/\s+/).length,i=e.progressTokenIndex>0?Math.min(100,Math.round(e.progressTokenIndex/s*100)):0,r=this.selectedIds.has(e.id),a=e.language||"",l=this.getLanguageFlag(a),o=this.getLanguageLabel(a);return`
            <div class="document-item ${r?"selected":""}" data-id="${e.id}">
                <div class="document-selection">
                    <input type="checkbox" id="select-${e.id}" ${r?"checked":""}>
                </div>
                <div class="document-info">
                    <h3 class="document-title">
                        <span class="language-flag" title="${o}">${l}</span>
                        ${this.escapeHtml(e.title)}
                    </h3>
                    <div class="document-meta">
                        <span>${s.toLocaleString()} tokens</span>
                        <span>ÎÃÃ³</span>
                        <span>Last read ${t}</span>
                        ${i>0?`<span>ÎÃÃ³</span><span>${i}% complete</span>`:""}
                    </div>
                    ${i>0?`
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${i}%"></div>
                        </div>
                    `:""}
                </div>
                <div class="document-actions">
                    <button class="btn btn-primary btn-sm btn-icon" id="resume-${e.id}" title="${i>0?"Resume":"Start"}" aria-label="${i>0?"Resume":"Start"}">
                        ${Is.play}
                    </button>
                    <button class="btn btn-danger btn-sm btn-icon" id="delete-${e.id}" title="Delete" aria-label="Delete">
                        ${Is.trash}
                    </button>
                </div>
            </div>
        `}getLanguageFlag(e){switch(e.split("-")[0].toLowerCase()){case"en":return"â¡ÆÃ§ââ¡ÆÃ§â";case"de":return"â¡ÆÃ§ââ¡ÆÃ§Â¬";case"ru":return"â¡ÆÃ§ââ¡ÆÃ§â";case"es":return"â¡ÆÃ§Â¬â¡ÆÃ§â";case"fr":return"â¡ÆÃ§Â½â¡ÆÃ§â";default:return"â¡ÆÃ®Ã"}}getLanguageLabel(e){if(!e)return"Language not set";switch(e.split("-")[0].toLowerCase()){case"en":return"English";case"de":return"German";case"ru":return"Russian";case"es":return"Spanish";case"fr":return"French";default:return e}}confirmDelete(e){confirm(`Delete "${e.title}"? This cannot be undone.`)&&(X.bulkDeleteDocuments([e.id]).then(()=>{this.mount()}),this.callbacks.onDelete(e.id))}confirmBulkDelete(){const e=this.selectedIds.size;if(confirm(`Delete ${e} selected document${e>1?"s":""}? This cannot be undone.`)){const t=Array.from(this.selectedIds);X.bulkDeleteDocuments(t).then(()=>{this.mount()}),t.forEach(s=>this.callbacks.onDelete(s))}}formatRelativeTime(e){const s=Date.now()-e,i=Math.floor(s/6e4),r=Math.floor(s/36e5),a=Math.floor(s/864e5);return i<1?"just now":i<60?`${i}m ago`:r<24?`${r}h ago`:a<7?`${a}d ago`:new Date(e).toLocaleDateString()}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}unmount(){this.container.innerHTML=""}}function El(n){if(n.length===0)return 0;const e=[];for(let i=0;i<n.length;i++){const r=n[i];Cl(r)&&e.push(i)}if(e.length===0)return 0;const t=e.length;let s;return t<=2?s=0:t<=5?s=1:t<=9?s=2:s=3,e[Ai(s,e.length)]}function ci(n){const e=Ai(El(n),n.length);return{word:n,orpIndex:e,orpChar:n.charAt(e)}}function ui(n,e){if(n.length===0)return["","",""];const t=Ai(e,n.length),s=n.slice(0,t),i=n.charAt(t),r=n.slice(t+1);return[s,i,r]}function Ai(n,e){return e<=0||n<0?0:n>=e?e-1:n}function Cl(n){return/\p{L}|\p{N}/u.test(n)}class Il{constructor(){p(this,"container",null);p(this,"wordContainer",null);p(this,"prefixEl",null);p(this,"orpEl",null);p(this,"suffixEl",null);p(this,"currentTokenIndex",-1)}mount(e){this.container=e,this.container.innerHTML=`
            <div class="rsvp-container">
                <div class="rsvp-word-layout" id="rsvp-word-layout">
                    <div class="rsvp-prefix"></div>
                    <div class="rsvp-orp"></div>
                    <div class="rsvp-suffix"></div>
                </div>
                <div class="rsvp-guides">
                    <div class="rsvp-guide-top"></div>
                    <div class="rsvp-guide-bottom"></div>
                </div>
            </div>
        `,this.wordContainer=this.container.querySelector("#rsvp-word-layout"),this.prefixEl=this.container.querySelector(".rsvp-prefix"),this.orpEl=this.container.querySelector(".rsvp-orp"),this.suffixEl=this.container.querySelector(".rsvp-suffix")}unmount(){this.container&&(this.container.innerHTML="",this.container=null,this.wordContainer=null,this.prefixEl=null,this.orpEl=null,this.suffixEl=null,this.currentTokenIndex=-1)}update(e,t){if(!this.wordContainer||!this.prefixEl||!this.orpEl||!this.suffixEl||!t||t.length===0||this.currentTokenIndex===e)return;this.currentTokenIndex=e;const s=t[e];if(s){const i=s.text,r=ci(i),[a,l,o]=ui(i,r.orpIndex);this.prefixEl.textContent=a,this.orpEl.textContent=l,this.suffixEl.textContent=o,s.type==="punct"?this.wordContainer.classList.add("rsvp-punct"):this.wordContainer.classList.remove("rsvp-punct")}}setTheme(e){}}class _l{constructor(){p(this,"element");p(this,"textElement");p(this,"progressFill");this.element=document.createElement("div"),this.element.className="loading-overlay",this.element.innerHTML=`
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <div class="loading-text">Processing...</div>
                <div class="loading-progress-bar">
                    <div class="loading-progress-fill"></div>
                </div>
            </div>
        `,this.textElement=this.element.querySelector(".loading-text"),this.progressFill=this.element.querySelector(".loading-progress-fill"),document.body.appendChild(this.element)}show(e="Processing...",t){this.textElement.textContent=e,this.setProgress(0),this.element.classList.add("visible");const s=this.element.querySelector("#loading-cancel-btn");if(s&&s.remove(),t){const i=document.createElement("button");i.id="loading-cancel-btn",i.className="btn btn-secondary",i.textContent="Cancel",i.style.marginTop="20px",i.onclick=()=>{t(),this.hide()};const r=this.element.querySelector(".loading-content");r&&r.appendChild(i)}}hide(){this.element.classList.remove("visible")}setProgress(e){this.progressFill.style.width=`${Math.max(0,Math.min(100,e))}%`}setText(e){this.textElement.textContent=e}}/*! @license DOMPurify 3.3.1 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.3.1/LICENSE */const{entries:La,setPrototypeOf:Cr,isFrozen:Al,getPrototypeOf:Pl,getOwnPropertyDescriptor:Rl}=Object;let{freeze:fe,seal:be,create:hi}=Object,{apply:di,construct:pi}=typeof Reflect<"u"&&Reflect;fe||(fe=function(e){return e});be||(be=function(e){return e});di||(di=function(e,t){for(var s=arguments.length,i=new Array(s>2?s-2:0),r=2;r<s;r++)i[r-2]=arguments[r];return e.apply(t,i)});pi||(pi=function(e){for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];return new e(...s)});const _n=ge(Array.prototype.forEach),Ll=ge(Array.prototype.lastIndexOf),Ir=ge(Array.prototype.pop),Bt=ge(Array.prototype.push),Ol=ge(Array.prototype.splice),zn=ge(String.prototype.toLowerCase),_s=ge(String.prototype.toString),As=ge(String.prototype.match),Ft=ge(String.prototype.replace),Dl=ge(String.prototype.indexOf),$l=ge(String.prototype.trim),ve=ge(Object.prototype.hasOwnProperty),ue=ge(RegExp.prototype.test),Vt=Ml(TypeError);function ge(n){return function(e){e instanceof RegExp&&(e.lastIndex=0);for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];return di(n,e,s)}}function Ml(n){return function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return pi(n,t)}}function M(n,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:zn;Cr&&Cr(n,null);let s=e.length;for(;s--;){let i=e[s];if(typeof i=="string"){const r=t(i);r!==i&&(Al(e)||(e[s]=r),i=r)}n[i]=!0}return n}function Nl(n){for(let e=0;e<n.length;e++)ve(n,e)||(n[e]=null);return n}function Ie(n){const e=hi(null);for(const[t,s]of La(n))ve(n,t)&&(Array.isArray(s)?e[t]=Nl(s):s&&typeof s=="object"&&s.constructor===Object?e[t]=Ie(s):e[t]=s);return e}function Ht(n,e){for(;n!==null;){const s=Rl(n,e);if(s){if(s.get)return ge(s.get);if(typeof s.value=="function")return ge(s.value)}n=Pl(n)}function t(){return null}return t}const _r=fe(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),Ps=fe(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),Rs=fe(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),Bl=fe(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),Ls=fe(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),Fl=fe(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),Ar=fe(["#text"]),Pr=fe(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),Os=fe(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),Rr=fe(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),An=fe(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),Vl=be(/\{\{[\w\W]*|[\w\W]*\}\}/gm),Hl=be(/<%[\w\W]*|[\w\W]*%>/gm),Wl=be(/\$\{[\w\W]*/gm),zl=be(/^data-[\-\w.\u00B7-\uFFFF]+$/),Ul=be(/^aria-[\-\w]+$/),Oa=be(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),ql=be(/^(?:\w+script|data):/i),jl=be(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),Da=be(/^html$/i),Kl=be(/^[a-z][.\w]*(-[.\w]+)+$/i);var Lr=Object.freeze({__proto__:null,ARIA_ATTR:Ul,ATTR_WHITESPACE:jl,CUSTOM_ELEMENT:Kl,DATA_ATTR:zl,DOCTYPE_NAME:Da,ERB_EXPR:Hl,IS_ALLOWED_URI:Oa,IS_SCRIPT_OR_DATA:ql,MUSTACHE_EXPR:Vl,TMPLIT_EXPR:Wl});const Wt={element:1,text:3,progressingInstruction:7,comment:8,document:9},Gl=function(){return typeof window>"u"?null:window},Yl=function(e,t){if(typeof e!="object"||typeof e.createPolicy!="function")return null;let s=null;const i="data-tt-policy-suffix";t&&t.hasAttribute(i)&&(s=t.getAttribute(i));const r="dompurify"+(s?"#"+s:"");try{return e.createPolicy(r,{createHTML(a){return a},createScriptURL(a){return a}})}catch{return console.warn("TrustedTypes policy "+r+" could not be created."),null}},Or=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function $a(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Gl();const e=P=>$a(P);if(e.version="3.3.1",e.removed=[],!n||!n.document||n.document.nodeType!==Wt.document||!n.Element)return e.isSupported=!1,e;let{document:t}=n;const s=t,i=s.currentScript,{DocumentFragment:r,HTMLTemplateElement:a,Node:l,Element:o,NodeFilter:u,NamedNodeMap:c=n.NamedNodeMap||n.MozNamedAttrMap,HTMLFormElement:d,DOMParser:h,trustedTypes:g}=n,m=o.prototype,y=Ht(m,"cloneNode"),w=Ht(m,"remove"),b=Ht(m,"nextSibling"),k=Ht(m,"childNodes"),S=Ht(m,"parentNode");if(typeof a=="function"){const P=t.createElement("template");P.content&&P.content.ownerDocument&&(t=P.content.ownerDocument)}let x,C="";const{implementation:I,createNodeIterator:v,createDocumentFragment:O,getElementsByTagName:E}=t,{importNode:B}=s;let L=Or();e.isSupported=typeof La=="function"&&typeof S=="function"&&I&&I.createHTMLDocument!==void 0;const{MUSTACHE_EXPR:j,ERB_EXPR:z,TMPLIT_EXPR:H,DATA_ATTR:He,ARIA_ATTR:We,IS_SCRIPT_OR_DATA:ie,ATTR_WHITESPACE:Te,CUSTOM_ELEMENT:Je}=Lr;let{IS_ALLOWED_URI:pt}=Lr,J=null;const Fi=M({},[..._r,...Ps,...Rs,...Ls,...Ar]);let ee=null;const Vi=M({},[...Pr,...Os,...Rr,...An]);let K=Object.seal(hi(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),Dt=null,rs=null;const ft=Object.seal(hi(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}}));let Hi=!0,as=!0,Wi=!1,zi=!0,gt=!1,fn=!0,et=!1,os=!1,ls=!1,mt=!1,gn=!1,mn=!1,Ui=!0,qi=!1;const Ya="user-content-";let cs=!0,$t=!1,yt={},Ee=null;const us=M({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]);let ji=null;const Ki=M({},["audio","video","img","source","image","track"]);let hs=null;const Gi=M({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),yn="http://www.w3.org/1998/Math/MathML",kn="http://www.w3.org/2000/svg",Pe="http://www.w3.org/1999/xhtml";let kt=Pe,ds=!1,ps=null;const Za=M({},[yn,kn,Pe],_s);let bn=M({},["mi","mo","mn","ms","mtext"]),vn=M({},["annotation-xml"]);const Xa=M({},["title","style","font","a","script"]);let Mt=null;const Qa=["application/xhtml+xml","text/html"],Ja="text/html";let Z=null,bt=null;const eo=t.createElement("form"),Yi=function(f){return f instanceof RegExp||f instanceof Function},fs=function(){let f=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(bt&&bt===f)){if((!f||typeof f!="object")&&(f={}),f=Ie(f),Mt=Qa.indexOf(f.PARSER_MEDIA_TYPE)===-1?Ja:f.PARSER_MEDIA_TYPE,Z=Mt==="application/xhtml+xml"?_s:zn,J=ve(f,"ALLOWED_TAGS")?M({},f.ALLOWED_TAGS,Z):Fi,ee=ve(f,"ALLOWED_ATTR")?M({},f.ALLOWED_ATTR,Z):Vi,ps=ve(f,"ALLOWED_NAMESPACES")?M({},f.ALLOWED_NAMESPACES,_s):Za,hs=ve(f,"ADD_URI_SAFE_ATTR")?M(Ie(Gi),f.ADD_URI_SAFE_ATTR,Z):Gi,ji=ve(f,"ADD_DATA_URI_TAGS")?M(Ie(Ki),f.ADD_DATA_URI_TAGS,Z):Ki,Ee=ve(f,"FORBID_CONTENTS")?M({},f.FORBID_CONTENTS,Z):us,Dt=ve(f,"FORBID_TAGS")?M({},f.FORBID_TAGS,Z):Ie({}),rs=ve(f,"FORBID_ATTR")?M({},f.FORBID_ATTR,Z):Ie({}),yt=ve(f,"USE_PROFILES")?f.USE_PROFILES:!1,Hi=f.ALLOW_ARIA_ATTR!==!1,as=f.ALLOW_DATA_ATTR!==!1,Wi=f.ALLOW_UNKNOWN_PROTOCOLS||!1,zi=f.ALLOW_SELF_CLOSE_IN_ATTR!==!1,gt=f.SAFE_FOR_TEMPLATES||!1,fn=f.SAFE_FOR_XML!==!1,et=f.WHOLE_DOCUMENT||!1,mt=f.RETURN_DOM||!1,gn=f.RETURN_DOM_FRAGMENT||!1,mn=f.RETURN_TRUSTED_TYPE||!1,ls=f.FORCE_BODY||!1,Ui=f.SANITIZE_DOM!==!1,qi=f.SANITIZE_NAMED_PROPS||!1,cs=f.KEEP_CONTENT!==!1,$t=f.IN_PLACE||!1,pt=f.ALLOWED_URI_REGEXP||Oa,kt=f.NAMESPACE||Pe,bn=f.MATHML_TEXT_INTEGRATION_POINTS||bn,vn=f.HTML_INTEGRATION_POINTS||vn,K=f.CUSTOM_ELEMENT_HANDLING||{},f.CUSTOM_ELEMENT_HANDLING&&Yi(f.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(K.tagNameCheck=f.CUSTOM_ELEMENT_HANDLING.tagNameCheck),f.CUSTOM_ELEMENT_HANDLING&&Yi(f.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(K.attributeNameCheck=f.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),f.CUSTOM_ELEMENT_HANDLING&&typeof f.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(K.allowCustomizedBuiltInElements=f.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),gt&&(as=!1),gn&&(mt=!0),yt&&(J=M({},Ar),ee=[],yt.html===!0&&(M(J,_r),M(ee,Pr)),yt.svg===!0&&(M(J,Ps),M(ee,Os),M(ee,An)),yt.svgFilters===!0&&(M(J,Rs),M(ee,Os),M(ee,An)),yt.mathMl===!0&&(M(J,Ls),M(ee,Rr),M(ee,An))),f.ADD_TAGS&&(typeof f.ADD_TAGS=="function"?ft.tagCheck=f.ADD_TAGS:(J===Fi&&(J=Ie(J)),M(J,f.ADD_TAGS,Z))),f.ADD_ATTR&&(typeof f.ADD_ATTR=="function"?ft.attributeCheck=f.ADD_ATTR:(ee===Vi&&(ee=Ie(ee)),M(ee,f.ADD_ATTR,Z))),f.ADD_URI_SAFE_ATTR&&M(hs,f.ADD_URI_SAFE_ATTR,Z),f.FORBID_CONTENTS&&(Ee===us&&(Ee=Ie(Ee)),M(Ee,f.FORBID_CONTENTS,Z)),f.ADD_FORBID_CONTENTS&&(Ee===us&&(Ee=Ie(Ee)),M(Ee,f.ADD_FORBID_CONTENTS,Z)),cs&&(J["#text"]=!0),et&&M(J,["html","head","body"]),J.table&&(M(J,["tbody"]),delete Dt.tbody),f.TRUSTED_TYPES_POLICY){if(typeof f.TRUSTED_TYPES_POLICY.createHTML!="function")throw Vt('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof f.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw Vt('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');x=f.TRUSTED_TYPES_POLICY,C=x.createHTML("")}else x===void 0&&(x=Yl(g,i)),x!==null&&typeof C=="string"&&(C=x.createHTML(""));fe&&fe(f),bt=f}},Zi=M({},[...Ps,...Rs,...Bl]),Xi=M({},[...Ls,...Fl]),to=function(f){let T=S(f);(!T||!T.tagName)&&(T={namespaceURI:kt,tagName:"template"});const A=zn(f.tagName),U=zn(T.tagName);return ps[f.namespaceURI]?f.namespaceURI===kn?T.namespaceURI===Pe?A==="svg":T.namespaceURI===yn?A==="svg"&&(U==="annotation-xml"||bn[U]):!!Zi[A]:f.namespaceURI===yn?T.namespaceURI===Pe?A==="math":T.namespaceURI===kn?A==="math"&&vn[U]:!!Xi[A]:f.namespaceURI===Pe?T.namespaceURI===kn&&!vn[U]||T.namespaceURI===yn&&!bn[U]?!1:!Xi[A]&&(Xa[A]||!Zi[A]):!!(Mt==="application/xhtml+xml"&&ps[f.namespaceURI]):!1},Ce=function(f){Bt(e.removed,{element:f});try{S(f).removeChild(f)}catch{w(f)}},tt=function(f,T){try{Bt(e.removed,{attribute:T.getAttributeNode(f),from:T})}catch{Bt(e.removed,{attribute:null,from:T})}if(T.removeAttribute(f),f==="is")if(mt||gn)try{Ce(T)}catch{}else try{T.setAttribute(f,"")}catch{}},Qi=function(f){let T=null,A=null;if(ls)f="<remove></remove>"+f;else{const G=As(f,/^[\r\n\t ]+/);A=G&&G[0]}Mt==="application/xhtml+xml"&&kt===Pe&&(f='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+f+"</body></html>");const U=x?x.createHTML(f):f;if(kt===Pe)try{T=new h().parseFromString(U,Mt)}catch{}if(!T||!T.documentElement){T=I.createDocument(kt,"template",null);try{T.documentElement.innerHTML=ds?C:U}catch{}}const re=T.body||T.documentElement;return f&&A&&re.insertBefore(t.createTextNode(A),re.childNodes[0]||null),kt===Pe?E.call(T,et?"html":"body")[0]:et?T.documentElement:re},Ji=function(f){return v.call(f.ownerDocument||f,f,u.SHOW_ELEMENT|u.SHOW_COMMENT|u.SHOW_TEXT|u.SHOW_PROCESSING_INSTRUCTION|u.SHOW_CDATA_SECTION,null)},gs=function(f){return f instanceof d&&(typeof f.nodeName!="string"||typeof f.textContent!="string"||typeof f.removeChild!="function"||!(f.attributes instanceof c)||typeof f.removeAttribute!="function"||typeof f.setAttribute!="function"||typeof f.namespaceURI!="string"||typeof f.insertBefore!="function"||typeof f.hasChildNodes!="function")},er=function(f){return typeof l=="function"&&f instanceof l};function Re(P,f,T){_n(P,A=>{A.call(e,f,T,bt)})}const tr=function(f){let T=null;if(Re(L.beforeSanitizeElements,f,null),gs(f))return Ce(f),!0;const A=Z(f.nodeName);if(Re(L.uponSanitizeElement,f,{tagName:A,allowedTags:J}),fn&&f.hasChildNodes()&&!er(f.firstElementChild)&&ue(/<[/\w!]/g,f.innerHTML)&&ue(/<[/\w!]/g,f.textContent)||f.nodeType===Wt.progressingInstruction||fn&&f.nodeType===Wt.comment&&ue(/<[/\w]/g,f.data))return Ce(f),!0;if(!(ft.tagCheck instanceof Function&&ft.tagCheck(A))&&(!J[A]||Dt[A])){if(!Dt[A]&&sr(A)&&(K.tagNameCheck instanceof RegExp&&ue(K.tagNameCheck,A)||K.tagNameCheck instanceof Function&&K.tagNameCheck(A)))return!1;if(cs&&!Ee[A]){const U=S(f)||f.parentNode,re=k(f)||f.childNodes;if(re&&U){const G=re.length;for(let me=G-1;me>=0;--me){const Le=y(re[me],!0);Le.__removalCount=(f.__removalCount||0)+1,U.insertBefore(Le,b(f))}}}return Ce(f),!0}return f instanceof o&&!to(f)||(A==="noscript"||A==="noembed"||A==="noframes")&&ue(/<\/no(script|embed|frames)/i,f.innerHTML)?(Ce(f),!0):(gt&&f.nodeType===Wt.text&&(T=f.textContent,_n([j,z,H],U=>{T=Ft(T,U," ")}),f.textContent!==T&&(Bt(e.removed,{element:f.cloneNode()}),f.textContent=T)),Re(L.afterSanitizeElements,f,null),!1)},nr=function(f,T,A){if(Ui&&(T==="id"||T==="name")&&(A in t||A in eo))return!1;if(!(as&&!rs[T]&&ue(He,T))){if(!(Hi&&ue(We,T))){if(!(ft.attributeCheck instanceof Function&&ft.attributeCheck(T,f))){if(!ee[T]||rs[T]){if(!(sr(f)&&(K.tagNameCheck instanceof RegExp&&ue(K.tagNameCheck,f)||K.tagNameCheck instanceof Function&&K.tagNameCheck(f))&&(K.attributeNameCheck instanceof RegExp&&ue(K.attributeNameCheck,T)||K.attributeNameCheck instanceof Function&&K.attributeNameCheck(T,f))||T==="is"&&K.allowCustomizedBuiltInElements&&(K.tagNameCheck instanceof RegExp&&ue(K.tagNameCheck,A)||K.tagNameCheck instanceof Function&&K.tagNameCheck(A))))return!1}else if(!hs[T]){if(!ue(pt,Ft(A,Te,""))){if(!((T==="src"||T==="xlink:href"||T==="href")&&f!=="script"&&Dl(A,"data:")===0&&ji[f])){if(!(Wi&&!ue(ie,Ft(A,Te,"")))){if(A)return!1}}}}}}}return!0},sr=function(f){return f!=="annotation-xml"&&As(f,Je)},ir=function(f){Re(L.beforeSanitizeAttributes,f,null);const{attributes:T}=f;if(!T||gs(f))return;const A={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:ee,forceKeepAttr:void 0};let U=T.length;for(;U--;){const re=T[U],{name:G,namespaceURI:me,value:Le}=re,vt=Z(G),ms=Le;let te=G==="value"?ms:$l(ms);if(A.attrName=vt,A.attrValue=te,A.keepAttr=!0,A.forceKeepAttr=void 0,Re(L.uponSanitizeAttribute,f,A),te=A.attrValue,qi&&(vt==="id"||vt==="name")&&(tt(G,f),te=Ya+te),fn&&ue(/((--!?|])>)|<\/(style|title|textarea)/i,te)){tt(G,f);continue}if(vt==="attributename"&&As(te,"href")){tt(G,f);continue}if(A.forceKeepAttr)continue;if(!A.keepAttr){tt(G,f);continue}if(!zi&&ue(/\/>/i,te)){tt(G,f);continue}gt&&_n([j,z,H],ar=>{te=Ft(te,ar," ")});const rr=Z(f.nodeName);if(!nr(rr,vt,te)){tt(G,f);continue}if(x&&typeof g=="object"&&typeof g.getAttributeType=="function"&&!me)switch(g.getAttributeType(rr,vt)){case"TrustedHTML":{te=x.createHTML(te);break}case"TrustedScriptURL":{te=x.createScriptURL(te);break}}if(te!==ms)try{me?f.setAttributeNS(me,G,te):f.setAttribute(G,te),gs(f)?Ce(f):Ir(e.removed)}catch{tt(G,f)}}Re(L.afterSanitizeAttributes,f,null)},no=function P(f){let T=null;const A=Ji(f);for(Re(L.beforeSanitizeShadowDOM,f,null);T=A.nextNode();)Re(L.uponSanitizeShadowNode,T,null),tr(T),ir(T),T.content instanceof r&&P(T.content);Re(L.afterSanitizeShadowDOM,f,null)};return e.sanitize=function(P){let f=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},T=null,A=null,U=null,re=null;if(ds=!P,ds&&(P="<!-->"),typeof P!="string"&&!er(P))if(typeof P.toString=="function"){if(P=P.toString(),typeof P!="string")throw Vt("dirty is not a string, aborting")}else throw Vt("toString is not a function");if(!e.isSupported)return P;if(os||fs(f),e.removed=[],typeof P=="string"&&($t=!1),$t){if(P.nodeName){const Le=Z(P.nodeName);if(!J[Le]||Dt[Le])throw Vt("root node is forbidden and cannot be sanitized in-place")}}else if(P instanceof l)T=Qi("<!---->"),A=T.ownerDocument.importNode(P,!0),A.nodeType===Wt.element&&A.nodeName==="BODY"||A.nodeName==="HTML"?T=A:T.appendChild(A);else{if(!mt&&!gt&&!et&&P.indexOf("<")===-1)return x&&mn?x.createHTML(P):P;if(T=Qi(P),!T)return mt?null:mn?C:""}T&&ls&&Ce(T.firstChild);const G=Ji($t?P:T);for(;U=G.nextNode();)tr(U),ir(U),U.content instanceof r&&no(U.content);if($t)return P;if(mt){if(gn)for(re=O.call(T.ownerDocument);T.firstChild;)re.appendChild(T.firstChild);else re=T;return(ee.shadowroot||ee.shadowrootmode)&&(re=B.call(s,re,!0)),re}let me=et?T.outerHTML:T.innerHTML;return et&&J["!doctype"]&&T.ownerDocument&&T.ownerDocument.doctype&&T.ownerDocument.doctype.name&&ue(Da,T.ownerDocument.doctype.name)&&(me="<!DOCTYPE "+T.ownerDocument.doctype.name+`>
`+me),gt&&_n([j,z,H],Le=>{me=Ft(me,Le," ")}),x&&mn?x.createHTML(me):me},e.setConfig=function(){let P=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};fs(P),os=!0},e.clearConfig=function(){bt=null,os=!1},e.isValidAttribute=function(P,f,T){bt||fs({});const A=Z(P),U=Z(f);return nr(A,U,T)},e.addHook=function(P,f){typeof f=="function"&&Bt(L[P],f)},e.removeHook=function(P,f){if(f!==void 0){const T=Ll(L[P],f);return T===-1?void 0:Ol(L[P],T,1)[0]}return Ir(L[P])},e.removeHooks=function(P){L[P]=[]},e.removeAllHooks=function(){L=Or()},e}var Dr=$a();function Pi(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}var dt=Pi();function Ma(n){dt=n}var tn={exec:()=>null};function N(n,e=""){let t=typeof n=="string"?n:n.source,s={replace:(i,r)=>{let a=typeof r=="string"?r:r.source;return a=a.replace(de.caret,"$1"),t=t.replace(i,a),s},getRegex:()=>new RegExp(t,e)};return s}var Zl=(()=>{try{return!!new RegExp("(?<=1)(?<!1)")}catch{return!1}})(),de={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] +\S/,listReplaceTask:/^\[[ xX]\] +/,listTaskCheckbox:/\[[ xX]\]/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/ig,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:n=>new RegExp(`^( {0,3}${n})((?:[	 ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ 	][^\\n]*)?(?:\\n|$))`),hrRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}#`),htmlBeginRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}<(?:[a-z].*>|!--)`,"i")},Xl=/^(?:[ \t]*(?:\n|$))+/,Ql=/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,Jl=/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,pn=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,ec=/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,Ri=/(?:[*+-]|\d{1,9}[.)])/,Na=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,Ba=N(Na).replace(/bull/g,Ri).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),tc=N(Na).replace(/bull/g,Ri).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),Li=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,nc=/^[^\n]+/,Oi=/(?!\s*\])(?:\\[\s\S]|[^\[\]\\])+/,sc=N(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",Oi).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),ic=N(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,Ri).getRegex(),ss="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",Di=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,rc=N("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$))","i").replace("comment",Di).replace("tag",ss).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),Fa=N(Li).replace("hr",pn).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",ss).getRegex(),ac=N(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",Fa).getRegex(),$i={blockquote:ac,code:Ql,def:sc,fences:Jl,heading:ec,hr:pn,html:rc,lheading:Ba,list:ic,newline:Xl,paragraph:Fa,table:tn,text:nc},$r=N("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",pn).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}	)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",ss).getRegex(),oc={...$i,lheading:tc,table:$r,paragraph:N(Li).replace("hr",pn).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",$r).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",ss).getRegex()},lc={...$i,html:N(`^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:"[^"]*"|'[^']*'|\\s[^'"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))`).replace("comment",Di).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:tn,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:N(Li).replace("hr",pn).replace("heading",` *#{1,6} *[^
]`).replace("lheading",Ba).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},cc=/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,uc=/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,Va=/^( {2,}|\\)\n(?!\s*$)/,hc=/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,is=/[\p{P}\p{S}]/u,Mi=/[\s\p{P}\p{S}]/u,Ha=/[^\s\p{P}\p{S}]/u,dc=N(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,Mi).getRegex(),Wa=/(?!~)[\p{P}\p{S}]/u,pc=/(?!~)[\s\p{P}\p{S}]/u,fc=/(?:[^\s\p{P}\p{S}]|~)/u,gc=N(/link|precode-code|html/,"g").replace("link",/\[(?:[^\[\]`]|(?<a>`+)[^`]+\k<a>(?!`))*?\]\((?:\\[\s\S]|[^\\\(\)]|\((?:\\[\s\S]|[^\\\(\)])*\))*\)/).replace("precode-",Zl?"(?<!`)()":"(^^|[^`])").replace("code",/(?<b>`+)[^`]+\k<b>(?!`)/).replace("html",/<(?! )[^<>]*?>/).getRegex(),za=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,mc=N(za,"u").replace(/punct/g,is).getRegex(),yc=N(za,"u").replace(/punct/g,Wa).getRegex(),Ua="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",kc=N(Ua,"gu").replace(/notPunctSpace/g,Ha).replace(/punctSpace/g,Mi).replace(/punct/g,is).getRegex(),bc=N(Ua,"gu").replace(/notPunctSpace/g,fc).replace(/punctSpace/g,pc).replace(/punct/g,Wa).getRegex(),vc=N("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,Ha).replace(/punctSpace/g,Mi).replace(/punct/g,is).getRegex(),wc=N(/\\(punct)/,"gu").replace(/punct/g,is).getRegex(),xc=N(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),Sc=N(Di).replace("(?:-->|$)","-->").getRegex(),Tc=N("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",Sc).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),Qn=/(?:\[(?:\\[\s\S]|[^\[\]\\])*\]|\\[\s\S]|`+[^`]*?`+(?!`)|[^\[\]\\`])*?/,Ec=N(/^!?\[(label)\]\(\s*(href)(?:(?:[ \t]*(?:\n[ \t]*)?)(title))?\s*\)/).replace("label",Qn).replace("href",/<(?:\\.|[^\n<>\\])+>|[^ \t\n\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),qa=N(/^!?\[(label)\]\[(ref)\]/).replace("label",Qn).replace("ref",Oi).getRegex(),ja=N(/^!?\[(ref)\](?:\[\])?/).replace("ref",Oi).getRegex(),Cc=N("reflink|nolink(?!\\()","g").replace("reflink",qa).replace("nolink",ja).getRegex(),Mr=/[hH][tT][tT][pP][sS]?|[fF][tT][pP]/,Ni={_backpedal:tn,anyPunctuation:wc,autolink:xc,blockSkip:gc,br:Va,code:uc,del:tn,emStrongLDelim:mc,emStrongRDelimAst:kc,emStrongRDelimUnd:vc,escape:cc,link:Ec,nolink:ja,punctuation:dc,reflink:qa,reflinkSearch:Cc,tag:Tc,text:hc,url:tn},Ic={...Ni,link:N(/^!?\[(label)\]\((.*?)\)/).replace("label",Qn).getRegex(),reflink:N(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",Qn).getRegex()},fi={...Ni,emStrongRDelimAst:bc,emStrongLDelim:yc,url:N(/^((?:protocol):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/).replace("protocol",Mr).replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\[\s\S]|[^\\])*?(?:\\[\s\S]|[^\s~\\]))\1(?=[^~]|$)/,text:N(/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|protocol:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/).replace("protocol",Mr).getRegex()},_c={...fi,br:N(Va).replace("{2,}","*").getRegex(),text:N(fi.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},Pn={normal:$i,gfm:oc,pedantic:lc},zt={normal:Ni,gfm:fi,breaks:_c,pedantic:Ic},Ac={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Nr=n=>Ac[n];function De(n,e){if(e){if(de.escapeTest.test(n))return n.replace(de.escapeReplace,Nr)}else if(de.escapeTestNoEncode.test(n))return n.replace(de.escapeReplaceNoEncode,Nr);return n}function Br(n){try{n=encodeURI(n).replace(de.percentDecode,"%")}catch{return null}return n}function Fr(n,e){let t=n.replace(de.findPipe,(r,a,l)=>{let o=!1,u=a;for(;--u>=0&&l[u]==="\\";)o=!o;return o?"|":" |"}),s=t.split(de.splitPipe),i=0;if(s[0].trim()||s.shift(),s.length>0&&!s.at(-1)?.trim()&&s.pop(),e)if(s.length>e)s.splice(e);else for(;s.length<e;)s.push("");for(;i<s.length;i++)s[i]=s[i].trim().replace(de.slashPipe,"|");return s}function Ut(n,e,t){let s=n.length;if(s===0)return"";let i=0;for(;i<s&&n.charAt(s-i-1)===e;)i++;return n.slice(0,s-i)}function Pc(n,e){if(n.indexOf(e[1])===-1)return-1;let t=0;for(let s=0;s<n.length;s++)if(n[s]==="\\")s++;else if(n[s]===e[0])t++;else if(n[s]===e[1]&&(t--,t<0))return s;return t>0?-2:-1}function Vr(n,e,t,s,i){let r=e.href,a=e.title||null,l=n[1].replace(i.other.outputLinkReplace,"$1");s.state.inLink=!0;let o={type:n[0].charAt(0)==="!"?"image":"link",raw:t,href:r,title:a,text:l,tokens:s.inlineTokens(l)};return s.state.inLink=!1,o}function Rc(n,e,t){let s=n.match(t.other.indentCodeCompensation);if(s===null)return e;let i=s[1];return e.split(`
`).map(r=>{let a=r.match(t.other.beginningSpace);if(a===null)return r;let[l]=a;return l.length>=i.length?r.slice(i.length):r}).join(`
`)}var Jn=class{constructor(n){p(this,"options");p(this,"rules");p(this,"lexer");this.options=n||dt}space(n){let e=this.rules.block.newline.exec(n);if(e&&e[0].length>0)return{type:"space",raw:e[0]}}code(n){let e=this.rules.block.code.exec(n);if(e){let t=e[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:e[0],codeBlockStyle:"indented",text:this.options.pedantic?t:Ut(t,`
`)}}}fences(n){let e=this.rules.block.fences.exec(n);if(e){let t=e[0],s=Rc(t,e[3]||"",this.rules);return{type:"code",raw:t,lang:e[2]?e[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):e[2],text:s}}}heading(n){let e=this.rules.block.heading.exec(n);if(e){let t=e[2].trim();if(this.rules.other.endingHash.test(t)){let s=Ut(t,"#");(this.options.pedantic||!s||this.rules.other.endingSpaceChar.test(s))&&(t=s.trim())}return{type:"heading",raw:e[0],depth:e[1].length,text:t,tokens:this.lexer.inline(t)}}}hr(n){let e=this.rules.block.hr.exec(n);if(e)return{type:"hr",raw:Ut(e[0],`
`)}}blockquote(n){let e=this.rules.block.blockquote.exec(n);if(e){let t=Ut(e[0],`
`).split(`
`),s="",i="",r=[];for(;t.length>0;){let a=!1,l=[],o;for(o=0;o<t.length;o++)if(this.rules.other.blockquoteStart.test(t[o]))l.push(t[o]),a=!0;else if(!a)l.push(t[o]);else break;t=t.slice(o);let u=l.join(`
`),c=u.replace(this.rules.other.blockquoteSetextReplace,`
    $1`).replace(this.rules.other.blockquoteSetextReplace2,"");s=s?`${s}
${u}`:u,i=i?`${i}
${c}`:c;let d=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(c,r,!0),this.lexer.state.top=d,t.length===0)break;let h=r.at(-1);if(h?.type==="code")break;if(h?.type==="blockquote"){let g=h,m=g.raw+`
`+t.join(`
`),y=this.blockquote(m);r[r.length-1]=y,s=s.substring(0,s.length-g.raw.length)+y.raw,i=i.substring(0,i.length-g.text.length)+y.text;break}else if(h?.type==="list"){let g=h,m=g.raw+`
`+t.join(`
`),y=this.list(m);r[r.length-1]=y,s=s.substring(0,s.length-h.raw.length)+y.raw,i=i.substring(0,i.length-g.raw.length)+y.raw,t=m.substring(r.at(-1).raw.length).split(`
`);continue}}return{type:"blockquote",raw:s,tokens:r,text:i}}}list(n){let e=this.rules.block.list.exec(n);if(e){let t=e[1].trim(),s=t.length>1,i={type:"list",raw:"",ordered:s,start:s?+t.slice(0,-1):"",loose:!1,items:[]};t=s?`\\d{1,9}\\${t.slice(-1)}`:`\\${t}`,this.options.pedantic&&(t=s?t:"[*+-]");let r=this.rules.other.listItemRegex(t),a=!1;for(;n;){let o=!1,u="",c="";if(!(e=r.exec(n))||this.rules.block.hr.test(n))break;u=e[0],n=n.substring(u.length);let d=e[2].split(`
`,1)[0].replace(this.rules.other.listReplaceTabs,y=>" ".repeat(3*y.length)),h=n.split(`
`,1)[0],g=!d.trim(),m=0;if(this.options.pedantic?(m=2,c=d.trimStart()):g?m=e[1].length+1:(m=e[2].search(this.rules.other.nonSpaceChar),m=m>4?1:m,c=d.slice(m),m+=e[1].length),g&&this.rules.other.blankLine.test(h)&&(u+=h+`
`,n=n.substring(h.length+1),o=!0),!o){let y=this.rules.other.nextBulletRegex(m),w=this.rules.other.hrRegex(m),b=this.rules.other.fencesBeginRegex(m),k=this.rules.other.headingBeginRegex(m),S=this.rules.other.htmlBeginRegex(m);for(;n;){let x=n.split(`
`,1)[0],C;if(h=x,this.options.pedantic?(h=h.replace(this.rules.other.listReplaceNesting,"  "),C=h):C=h.replace(this.rules.other.tabCharGlobal,"    "),b.test(h)||k.test(h)||S.test(h)||y.test(h)||w.test(h))break;if(C.search(this.rules.other.nonSpaceChar)>=m||!h.trim())c+=`
`+C.slice(m);else{if(g||d.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4||b.test(d)||k.test(d)||w.test(d))break;c+=`
`+h}!g&&!h.trim()&&(g=!0),u+=x+`
`,n=n.substring(x.length+1),d=C.slice(m)}}i.loose||(a?i.loose=!0:this.rules.other.doubleBlankLine.test(u)&&(a=!0)),i.items.push({type:"list_item",raw:u,task:!!this.options.gfm&&this.rules.other.listIsTask.test(c),loose:!1,text:c,tokens:[]}),i.raw+=u}let l=i.items.at(-1);if(l)l.raw=l.raw.trimEnd(),l.text=l.text.trimEnd();else return;i.raw=i.raw.trimEnd();for(let o of i.items){if(this.lexer.state.top=!1,o.tokens=this.lexer.blockTokens(o.text,[]),o.task){if(o.text=o.text.replace(this.rules.other.listReplaceTask,""),o.tokens[0]?.type==="text"||o.tokens[0]?.type==="paragraph"){o.tokens[0].raw=o.tokens[0].raw.replace(this.rules.other.listReplaceTask,""),o.tokens[0].text=o.tokens[0].text.replace(this.rules.other.listReplaceTask,"");for(let c=this.lexer.inlineQueue.length-1;c>=0;c--)if(this.rules.other.listIsTask.test(this.lexer.inlineQueue[c].src)){this.lexer.inlineQueue[c].src=this.lexer.inlineQueue[c].src.replace(this.rules.other.listReplaceTask,"");break}}let u=this.rules.other.listTaskCheckbox.exec(o.raw);if(u){let c={type:"checkbox",raw:u[0]+" ",checked:u[0]!=="[ ]"};o.checked=c.checked,i.loose?o.tokens[0]&&["paragraph","text"].includes(o.tokens[0].type)&&"tokens"in o.tokens[0]&&o.tokens[0].tokens?(o.tokens[0].raw=c.raw+o.tokens[0].raw,o.tokens[0].text=c.raw+o.tokens[0].text,o.tokens[0].tokens.unshift(c)):o.tokens.unshift({type:"paragraph",raw:c.raw,text:c.raw,tokens:[c]}):o.tokens.unshift(c)}}if(!i.loose){let u=o.tokens.filter(d=>d.type==="space"),c=u.length>0&&u.some(d=>this.rules.other.anyLine.test(d.raw));i.loose=c}}if(i.loose)for(let o of i.items){o.loose=!0;for(let u of o.tokens)u.type==="text"&&(u.type="paragraph")}return i}}html(n){let e=this.rules.block.html.exec(n);if(e)return{type:"html",block:!0,raw:e[0],pre:e[1]==="pre"||e[1]==="script"||e[1]==="style",text:e[0]}}def(n){let e=this.rules.block.def.exec(n);if(e){let t=e[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),s=e[2]?e[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",i=e[3]?e[3].substring(1,e[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):e[3];return{type:"def",tag:t,raw:e[0],href:s,title:i}}}table(n){let e=this.rules.block.table.exec(n);if(!e||!this.rules.other.tableDelimiter.test(e[2]))return;let t=Fr(e[1]),s=e[2].replace(this.rules.other.tableAlignChars,"").split("|"),i=e[3]?.trim()?e[3].replace(this.rules.other.tableRowBlankLine,"").split(`
`):[],r={type:"table",raw:e[0],header:[],align:[],rows:[]};if(t.length===s.length){for(let a of s)this.rules.other.tableAlignRight.test(a)?r.align.push("right"):this.rules.other.tableAlignCenter.test(a)?r.align.push("center"):this.rules.other.tableAlignLeft.test(a)?r.align.push("left"):r.align.push(null);for(let a=0;a<t.length;a++)r.header.push({text:t[a],tokens:this.lexer.inline(t[a]),header:!0,align:r.align[a]});for(let a of i)r.rows.push(Fr(a,r.header.length).map((l,o)=>({text:l,tokens:this.lexer.inline(l),header:!1,align:r.align[o]})));return r}}lheading(n){let e=this.rules.block.lheading.exec(n);if(e)return{type:"heading",raw:e[0],depth:e[2].charAt(0)==="="?1:2,text:e[1],tokens:this.lexer.inline(e[1])}}paragraph(n){let e=this.rules.block.paragraph.exec(n);if(e){let t=e[1].charAt(e[1].length-1)===`
`?e[1].slice(0,-1):e[1];return{type:"paragraph",raw:e[0],text:t,tokens:this.lexer.inline(t)}}}text(n){let e=this.rules.block.text.exec(n);if(e)return{type:"text",raw:e[0],text:e[0],tokens:this.lexer.inline(e[0])}}escape(n){let e=this.rules.inline.escape.exec(n);if(e)return{type:"escape",raw:e[0],text:e[1]}}tag(n){let e=this.rules.inline.tag.exec(n);if(e)return!this.lexer.state.inLink&&this.rules.other.startATag.test(e[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(e[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(e[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(e[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:e[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:e[0]}}link(n){let e=this.rules.inline.link.exec(n);if(e){let t=e[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(t)){if(!this.rules.other.endAngleBracket.test(t))return;let r=Ut(t.slice(0,-1),"\\");if((t.length-r.length)%2===0)return}else{let r=Pc(e[2],"()");if(r===-2)return;if(r>-1){let a=(e[0].indexOf("!")===0?5:4)+e[1].length+r;e[2]=e[2].substring(0,r),e[0]=e[0].substring(0,a).trim(),e[3]=""}}let s=e[2],i="";if(this.options.pedantic){let r=this.rules.other.pedanticHrefTitle.exec(s);r&&(s=r[1],i=r[3])}else i=e[3]?e[3].slice(1,-1):"";return s=s.trim(),this.rules.other.startAngleBracket.test(s)&&(this.options.pedantic&&!this.rules.other.endAngleBracket.test(t)?s=s.slice(1):s=s.slice(1,-1)),Vr(e,{href:s&&s.replace(this.rules.inline.anyPunctuation,"$1"),title:i&&i.replace(this.rules.inline.anyPunctuation,"$1")},e[0],this.lexer,this.rules)}}reflink(n,e){let t;if((t=this.rules.inline.reflink.exec(n))||(t=this.rules.inline.nolink.exec(n))){let s=(t[2]||t[1]).replace(this.rules.other.multipleSpaceGlobal," "),i=e[s.toLowerCase()];if(!i){let r=t[0].charAt(0);return{type:"text",raw:r,text:r}}return Vr(t,i,t[0],this.lexer,this.rules)}}emStrong(n,e,t=""){let s=this.rules.inline.emStrongLDelim.exec(n);if(!(!s||s[3]&&t.match(this.rules.other.unicodeAlphaNumeric))&&(!(s[1]||s[2])||!t||this.rules.inline.punctuation.exec(t))){let i=[...s[0]].length-1,r,a,l=i,o=0,u=s[0][0]==="*"?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(u.lastIndex=0,e=e.slice(-1*n.length+i);(s=u.exec(e))!=null;){if(r=s[1]||s[2]||s[3]||s[4]||s[5]||s[6],!r)continue;if(a=[...r].length,s[3]||s[4]){l+=a;continue}else if((s[5]||s[6])&&i%3&&!((i+a)%3)){o+=a;continue}if(l-=a,l>0)continue;a=Math.min(a,a+l+o);let c=[...s[0]][0].length,d=n.slice(0,i+s.index+c+a);if(Math.min(i,a)%2){let g=d.slice(1,-1);return{type:"em",raw:d,text:g,tokens:this.lexer.inlineTokens(g)}}let h=d.slice(2,-2);return{type:"strong",raw:d,text:h,tokens:this.lexer.inlineTokens(h)}}}}codespan(n){let e=this.rules.inline.code.exec(n);if(e){let t=e[2].replace(this.rules.other.newLineCharGlobal," "),s=this.rules.other.nonSpaceChar.test(t),i=this.rules.other.startingSpaceChar.test(t)&&this.rules.other.endingSpaceChar.test(t);return s&&i&&(t=t.substring(1,t.length-1)),{type:"codespan",raw:e[0],text:t}}}br(n){let e=this.rules.inline.br.exec(n);if(e)return{type:"br",raw:e[0]}}del(n){let e=this.rules.inline.del.exec(n);if(e)return{type:"del",raw:e[0],text:e[2],tokens:this.lexer.inlineTokens(e[2])}}autolink(n){let e=this.rules.inline.autolink.exec(n);if(e){let t,s;return e[2]==="@"?(t=e[1],s="mailto:"+t):(t=e[1],s=t),{type:"link",raw:e[0],text:t,href:s,tokens:[{type:"text",raw:t,text:t}]}}}url(n){let e;if(e=this.rules.inline.url.exec(n)){let t,s;if(e[2]==="@")t=e[0],s="mailto:"+t;else{let i;do i=e[0],e[0]=this.rules.inline._backpedal.exec(e[0])?.[0]??"";while(i!==e[0]);t=e[0],e[1]==="www."?s="http://"+e[0]:s=e[0]}return{type:"link",raw:e[0],text:t,href:s,tokens:[{type:"text",raw:t,text:t}]}}}inlineText(n){let e=this.rules.inline.text.exec(n);if(e){let t=this.lexer.state.inRawBlock;return{type:"text",raw:e[0],text:e[0],escaped:t}}}},we=class gi{constructor(e){p(this,"tokens");p(this,"options");p(this,"state");p(this,"inlineQueue");p(this,"tokenizer");this.tokens=[],this.tokens.links=Object.create(null),this.options=e||dt,this.options.tokenizer=this.options.tokenizer||new Jn,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};let t={other:de,block:Pn.normal,inline:zt.normal};this.options.pedantic?(t.block=Pn.pedantic,t.inline=zt.pedantic):this.options.gfm&&(t.block=Pn.gfm,this.options.breaks?t.inline=zt.breaks:t.inline=zt.gfm),this.tokenizer.rules=t}static get rules(){return{block:Pn,inline:zt}}static lex(e,t){return new gi(t).lex(e)}static lexInline(e,t){return new gi(t).inlineTokens(e)}lex(e){e=e.replace(de.carriageReturn,`
`),this.blockTokens(e,this.tokens);for(let t=0;t<this.inlineQueue.length;t++){let s=this.inlineQueue[t];this.inlineTokens(s.src,s.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(e,t=[],s=!1){for(this.options.pedantic&&(e=e.replace(de.tabCharGlobal,"    ").replace(de.spaceLine,""));e;){let i;if(this.options.extensions?.block?.some(a=>(i=a.call({lexer:this},e,t))?(e=e.substring(i.raw.length),t.push(i),!0):!1))continue;if(i=this.tokenizer.space(e)){e=e.substring(i.raw.length);let a=t.at(-1);i.raw.length===1&&a!==void 0?a.raw+=`
`:t.push(i);continue}if(i=this.tokenizer.code(e)){e=e.substring(i.raw.length);let a=t.at(-1);a?.type==="paragraph"||a?.type==="text"?(a.raw+=(a.raw.endsWith(`
`)?"":`
`)+i.raw,a.text+=`
`+i.text,this.inlineQueue.at(-1).src=a.text):t.push(i);continue}if(i=this.tokenizer.fences(e)){e=e.substring(i.raw.length),t.push(i);continue}if(i=this.tokenizer.heading(e)){e=e.substring(i.raw.length),t.push(i);continue}if(i=this.tokenizer.hr(e)){e=e.substring(i.raw.length),t.push(i);continue}if(i=this.tokenizer.blockquote(e)){e=e.substring(i.raw.length),t.push(i);continue}if(i=this.tokenizer.list(e)){e=e.substring(i.raw.length),t.push(i);continue}if(i=this.tokenizer.html(e)){e=e.substring(i.raw.length),t.push(i);continue}if(i=this.tokenizer.def(e)){e=e.substring(i.raw.length);let a=t.at(-1);a?.type==="paragraph"||a?.type==="text"?(a.raw+=(a.raw.endsWith(`
`)?"":`
`)+i.raw,a.text+=`
`+i.raw,this.inlineQueue.at(-1).src=a.text):this.tokens.links[i.tag]||(this.tokens.links[i.tag]={href:i.href,title:i.title},t.push(i));continue}if(i=this.tokenizer.table(e)){e=e.substring(i.raw.length),t.push(i);continue}if(i=this.tokenizer.lheading(e)){e=e.substring(i.raw.length),t.push(i);continue}let r=e;if(this.options.extensions?.startBlock){let a=1/0,l=e.slice(1),o;this.options.extensions.startBlock.forEach(u=>{o=u.call({lexer:this},l),typeof o=="number"&&o>=0&&(a=Math.min(a,o))}),a<1/0&&a>=0&&(r=e.substring(0,a+1))}if(this.state.top&&(i=this.tokenizer.paragraph(r))){let a=t.at(-1);s&&a?.type==="paragraph"?(a.raw+=(a.raw.endsWith(`
`)?"":`
`)+i.raw,a.text+=`
`+i.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=a.text):t.push(i),s=r.length!==e.length,e=e.substring(i.raw.length);continue}if(i=this.tokenizer.text(e)){e=e.substring(i.raw.length);let a=t.at(-1);a?.type==="text"?(a.raw+=(a.raw.endsWith(`
`)?"":`
`)+i.raw,a.text+=`
`+i.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=a.text):t.push(i);continue}if(e){let a="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(a);break}else throw new Error(a)}}return this.state.top=!0,t}inline(e,t=[]){return this.inlineQueue.push({src:e,tokens:t}),t}inlineTokens(e,t=[]){let s=e,i=null;if(this.tokens.links){let o=Object.keys(this.tokens.links);if(o.length>0)for(;(i=this.tokenizer.rules.inline.reflinkSearch.exec(s))!=null;)o.includes(i[0].slice(i[0].lastIndexOf("[")+1,-1))&&(s=s.slice(0,i.index)+"["+"a".repeat(i[0].length-2)+"]"+s.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;(i=this.tokenizer.rules.inline.anyPunctuation.exec(s))!=null;)s=s.slice(0,i.index)+"++"+s.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);let r;for(;(i=this.tokenizer.rules.inline.blockSkip.exec(s))!=null;)r=i[2]?i[2].length:0,s=s.slice(0,i.index+r)+"["+"a".repeat(i[0].length-r-2)+"]"+s.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);s=this.options.hooks?.emStrongMask?.call({lexer:this},s)??s;let a=!1,l="";for(;e;){a||(l=""),a=!1;let o;if(this.options.extensions?.inline?.some(c=>(o=c.call({lexer:this},e,t))?(e=e.substring(o.raw.length),t.push(o),!0):!1))continue;if(o=this.tokenizer.escape(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.tag(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.link(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.reflink(e,this.tokens.links)){e=e.substring(o.raw.length);let c=t.at(-1);o.type==="text"&&c?.type==="text"?(c.raw+=o.raw,c.text+=o.text):t.push(o);continue}if(o=this.tokenizer.emStrong(e,s,l)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.codespan(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.br(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.del(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.autolink(e)){e=e.substring(o.raw.length),t.push(o);continue}if(!this.state.inLink&&(o=this.tokenizer.url(e))){e=e.substring(o.raw.length),t.push(o);continue}let u=e;if(this.options.extensions?.startInline){let c=1/0,d=e.slice(1),h;this.options.extensions.startInline.forEach(g=>{h=g.call({lexer:this},d),typeof h=="number"&&h>=0&&(c=Math.min(c,h))}),c<1/0&&c>=0&&(u=e.substring(0,c+1))}if(o=this.tokenizer.inlineText(u)){e=e.substring(o.raw.length),o.raw.slice(-1)!=="_"&&(l=o.raw.slice(-1)),a=!0;let c=t.at(-1);c?.type==="text"?(c.raw+=o.raw,c.text+=o.text):t.push(o);continue}if(e){let c="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(c);break}else throw new Error(c)}}return t}},es=class{constructor(n){p(this,"options");p(this,"parser");this.options=n||dt}space(n){return""}code({text:n,lang:e,escaped:t}){let s=(e||"").match(de.notSpaceStart)?.[0],i=n.replace(de.endingNewline,"")+`
`;return s?'<pre><code class="language-'+De(s)+'">'+(t?i:De(i,!0))+`</code></pre>
`:"<pre><code>"+(t?i:De(i,!0))+`</code></pre>
`}blockquote({tokens:n}){return`<blockquote>
${this.parser.parse(n)}</blockquote>
`}html({text:n}){return n}def(n){return""}heading({tokens:n,depth:e}){return`<h${e}>${this.parser.parseInline(n)}</h${e}>
`}hr(n){return`<hr>
`}list(n){let e=n.ordered,t=n.start,s="";for(let a=0;a<n.items.length;a++){let l=n.items[a];s+=this.listitem(l)}let i=e?"ol":"ul",r=e&&t!==1?' start="'+t+'"':"";return"<"+i+r+`>
`+s+"</"+i+`>
`}listitem(n){return`<li>${this.parser.parse(n.tokens)}</li>
`}checkbox({checked:n}){return"<input "+(n?'checked="" ':"")+'disabled="" type="checkbox"> '}paragraph({tokens:n}){return`<p>${this.parser.parseInline(n)}</p>
`}table(n){let e="",t="";for(let i=0;i<n.header.length;i++)t+=this.tablecell(n.header[i]);e+=this.tablerow({text:t});let s="";for(let i=0;i<n.rows.length;i++){let r=n.rows[i];t="";for(let a=0;a<r.length;a++)t+=this.tablecell(r[a]);s+=this.tablerow({text:t})}return s&&(s=`<tbody>${s}</tbody>`),`<table>
<thead>
`+e+`</thead>
`+s+`</table>
`}tablerow({text:n}){return`<tr>
${n}</tr>
`}tablecell(n){let e=this.parser.parseInline(n.tokens),t=n.header?"th":"td";return(n.align?`<${t} align="${n.align}">`:`<${t}>`)+e+`</${t}>
`}strong({tokens:n}){return`<strong>${this.parser.parseInline(n)}</strong>`}em({tokens:n}){return`<em>${this.parser.parseInline(n)}</em>`}codespan({text:n}){return`<code>${De(n,!0)}</code>`}br(n){return"<br>"}del({tokens:n}){return`<del>${this.parser.parseInline(n)}</del>`}link({href:n,title:e,tokens:t}){let s=this.parser.parseInline(t),i=Br(n);if(i===null)return s;n=i;let r='<a href="'+n+'"';return e&&(r+=' title="'+De(e)+'"'),r+=">"+s+"</a>",r}image({href:n,title:e,text:t,tokens:s}){s&&(t=this.parser.parseInline(s,this.parser.textRenderer));let i=Br(n);if(i===null)return De(t);n=i;let r=`<img src="${n}" alt="${t}"`;return e&&(r+=` title="${De(e)}"`),r+=">",r}text(n){return"tokens"in n&&n.tokens?this.parser.parseInline(n.tokens):"escaped"in n&&n.escaped?n.text:De(n.text)}},Bi=class{strong({text:n}){return n}em({text:n}){return n}codespan({text:n}){return n}del({text:n}){return n}html({text:n}){return n}text({text:n}){return n}link({text:n}){return""+n}image({text:n}){return""+n}br(){return""}checkbox({raw:n}){return n}},xe=class mi{constructor(e){p(this,"options");p(this,"renderer");p(this,"textRenderer");this.options=e||dt,this.options.renderer=this.options.renderer||new es,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new Bi}static parse(e,t){return new mi(t).parse(e)}static parseInline(e,t){return new mi(t).parseInline(e)}parse(e){let t="";for(let s=0;s<e.length;s++){let i=e[s];if(this.options.extensions?.renderers?.[i.type]){let a=i,l=this.options.extensions.renderers[a.type].call({parser:this},a);if(l!==!1||!["space","hr","heading","code","table","blockquote","list","html","def","paragraph","text"].includes(a.type)){t+=l||"";continue}}let r=i;switch(r.type){case"space":{t+=this.renderer.space(r);break}case"hr":{t+=this.renderer.hr(r);break}case"heading":{t+=this.renderer.heading(r);break}case"code":{t+=this.renderer.code(r);break}case"table":{t+=this.renderer.table(r);break}case"blockquote":{t+=this.renderer.blockquote(r);break}case"list":{t+=this.renderer.list(r);break}case"checkbox":{t+=this.renderer.checkbox(r);break}case"html":{t+=this.renderer.html(r);break}case"def":{t+=this.renderer.def(r);break}case"paragraph":{t+=this.renderer.paragraph(r);break}case"text":{t+=this.renderer.text(r);break}default:{let a='Token with "'+r.type+'" type was not found.';if(this.options.silent)return console.error(a),"";throw new Error(a)}}}return t}parseInline(e,t=this.renderer){let s="";for(let i=0;i<e.length;i++){let r=e[i];if(this.options.extensions?.renderers?.[r.type]){let l=this.options.extensions.renderers[r.type].call({parser:this},r);if(l!==!1||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(r.type)){s+=l||"";continue}}let a=r;switch(a.type){case"escape":{s+=t.text(a);break}case"html":{s+=t.html(a);break}case"link":{s+=t.link(a);break}case"image":{s+=t.image(a);break}case"checkbox":{s+=t.checkbox(a);break}case"strong":{s+=t.strong(a);break}case"em":{s+=t.em(a);break}case"codespan":{s+=t.codespan(a);break}case"br":{s+=t.br(a);break}case"del":{s+=t.del(a);break}case"text":{s+=t.text(a);break}default:{let l='Token with "'+a.type+'" type was not found.';if(this.options.silent)return console.error(l),"";throw new Error(l)}}}return s}},Dn,Yt=(Dn=class{constructor(n){p(this,"options");p(this,"block");this.options=n||dt}preprocess(n){return n}postprocess(n){return n}processAllTokens(n){return n}emStrongMask(n){return n}provideLexer(){return this.block?we.lex:we.lexInline}provideParser(){return this.block?xe.parse:xe.parseInline}},p(Dn,"passThroughHooks",new Set(["preprocess","postprocess","processAllTokens","emStrongMask"])),p(Dn,"passThroughHooksRespectAsync",new Set(["preprocess","postprocess","processAllTokens"])),Dn),Lc=class{constructor(...n){p(this,"defaults",Pi());p(this,"options",this.setOptions);p(this,"parse",this.parseMarkdown(!0));p(this,"parseInline",this.parseMarkdown(!1));p(this,"Parser",xe);p(this,"Renderer",es);p(this,"TextRenderer",Bi);p(this,"Lexer",we);p(this,"Tokenizer",Jn);p(this,"Hooks",Yt);this.use(...n)}walkTokens(n,e){let t=[];for(let s of n)switch(t=t.concat(e.call(this,s)),s.type){case"table":{let i=s;for(let r of i.header)t=t.concat(this.walkTokens(r.tokens,e));for(let r of i.rows)for(let a of r)t=t.concat(this.walkTokens(a.tokens,e));break}case"list":{let i=s;t=t.concat(this.walkTokens(i.items,e));break}default:{let i=s;this.defaults.extensions?.childTokens?.[i.type]?this.defaults.extensions.childTokens[i.type].forEach(r=>{let a=i[r].flat(1/0);t=t.concat(this.walkTokens(a,e))}):i.tokens&&(t=t.concat(this.walkTokens(i.tokens,e)))}}return t}use(...n){let e=this.defaults.extensions||{renderers:{},childTokens:{}};return n.forEach(t=>{let s={...t};if(s.async=this.defaults.async||s.async||!1,t.extensions&&(t.extensions.forEach(i=>{if(!i.name)throw new Error("extension name required");if("renderer"in i){let r=e.renderers[i.name];r?e.renderers[i.name]=function(...a){let l=i.renderer.apply(this,a);return l===!1&&(l=r.apply(this,a)),l}:e.renderers[i.name]=i.renderer}if("tokenizer"in i){if(!i.level||i.level!=="block"&&i.level!=="inline")throw new Error("extension level must be 'block' or 'inline'");let r=e[i.level];r?r.unshift(i.tokenizer):e[i.level]=[i.tokenizer],i.start&&(i.level==="block"?e.startBlock?e.startBlock.push(i.start):e.startBlock=[i.start]:i.level==="inline"&&(e.startInline?e.startInline.push(i.start):e.startInline=[i.start]))}"childTokens"in i&&i.childTokens&&(e.childTokens[i.name]=i.childTokens)}),s.extensions=e),t.renderer){let i=this.defaults.renderer||new es(this.defaults);for(let r in t.renderer){if(!(r in i))throw new Error(`renderer '${r}' does not exist`);if(["options","parser"].includes(r))continue;let a=r,l=t.renderer[a],o=i[a];i[a]=(...u)=>{let c=l.apply(i,u);return c===!1&&(c=o.apply(i,u)),c||""}}s.renderer=i}if(t.tokenizer){let i=this.defaults.tokenizer||new Jn(this.defaults);for(let r in t.tokenizer){if(!(r in i))throw new Error(`tokenizer '${r}' does not exist`);if(["options","rules","lexer"].includes(r))continue;let a=r,l=t.tokenizer[a],o=i[a];i[a]=(...u)=>{let c=l.apply(i,u);return c===!1&&(c=o.apply(i,u)),c}}s.tokenizer=i}if(t.hooks){let i=this.defaults.hooks||new Yt;for(let r in t.hooks){if(!(r in i))throw new Error(`hook '${r}' does not exist`);if(["options","block"].includes(r))continue;let a=r,l=t.hooks[a],o=i[a];Yt.passThroughHooks.has(r)?i[a]=u=>{if(this.defaults.async&&Yt.passThroughHooksRespectAsync.has(r))return(async()=>{let d=await l.call(i,u);return o.call(i,d)})();let c=l.call(i,u);return o.call(i,c)}:i[a]=(...u)=>{if(this.defaults.async)return(async()=>{let d=await l.apply(i,u);return d===!1&&(d=await o.apply(i,u)),d})();let c=l.apply(i,u);return c===!1&&(c=o.apply(i,u)),c}}s.hooks=i}if(t.walkTokens){let i=this.defaults.walkTokens,r=t.walkTokens;s.walkTokens=function(a){let l=[];return l.push(r.call(this,a)),i&&(l=l.concat(i.call(this,a))),l}}this.defaults={...this.defaults,...s}}),this}setOptions(n){return this.defaults={...this.defaults,...n},this}lexer(n,e){return we.lex(n,e??this.defaults)}parser(n,e){return xe.parse(n,e??this.defaults)}parseMarkdown(n){return(e,t)=>{let s={...t},i={...this.defaults,...s},r=this.onError(!!i.silent,!!i.async);if(this.defaults.async===!0&&s.async===!1)return r(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(typeof e>"u"||e===null)return r(new Error("marked(): input parameter is undefined or null"));if(typeof e!="string")return r(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(e)+", string expected"));if(i.hooks&&(i.hooks.options=i,i.hooks.block=n),i.async)return(async()=>{let a=i.hooks?await i.hooks.preprocess(e):e,l=await(i.hooks?await i.hooks.provideLexer():n?we.lex:we.lexInline)(a,i),o=i.hooks?await i.hooks.processAllTokens(l):l;i.walkTokens&&await Promise.all(this.walkTokens(o,i.walkTokens));let u=await(i.hooks?await i.hooks.provideParser():n?xe.parse:xe.parseInline)(o,i);return i.hooks?await i.hooks.postprocess(u):u})().catch(r);try{i.hooks&&(e=i.hooks.preprocess(e));let a=(i.hooks?i.hooks.provideLexer():n?we.lex:we.lexInline)(e,i);i.hooks&&(a=i.hooks.processAllTokens(a)),i.walkTokens&&this.walkTokens(a,i.walkTokens);let l=(i.hooks?i.hooks.provideParser():n?xe.parse:xe.parseInline)(a,i);return i.hooks&&(l=i.hooks.postprocess(l)),l}catch(a){return r(a)}}}onError(n,e){return t=>{if(t.message+=`
Please report this to https://github.com/markedjs/marked.`,n){let s="<p>An error occurred:</p><pre>"+De(t.message+"",!0)+"</pre>";return e?Promise.resolve(s):s}if(e)return Promise.reject(t);throw t}}},ut=new Lc;function F(n,e){return ut.parse(n,e)}F.options=F.setOptions=function(n){return ut.setOptions(n),F.defaults=ut.defaults,Ma(F.defaults),F};F.getDefaults=Pi;F.defaults=dt;F.use=function(...n){return ut.use(...n),F.defaults=ut.defaults,Ma(F.defaults),F};F.walkTokens=function(n,e){return ut.walkTokens(n,e)};F.parseInline=ut.parseInline;F.Parser=xe;F.parser=xe.parse;F.Renderer=es;F.TextRenderer=Bi;F.Lexer=we;F.lexer=we.lex;F.Tokenizer=Jn;F.Hooks=Yt;F.parse=F;F.options;F.setOptions;F.use;F.walkTokens;F.parseInline;xe.parse;we.lex;class qe{constructor(){p(this,"container",null);p(this,"contentEl",null);p(this,"tokenEls",new Map);p(this,"activeTokenIndex",-1);p(this,"onScroll",null);p(this,"annotations",[]);p(this,"onAnnotationSelect",null);p(this,"notesPanelEl",null);p(this,"notesListEl",null);p(this,"notesToggleEl",null);p(this,"notesOpen",!0);p(this,"lastTokens",[]);p(this,"textNodeIndex",[]);p(this,"textNodeLength",0);p(this,"originalText","");p(this,"ttsText","");p(this,"contentType","text");p(this,"handleScroll",()=>{!this.contentEl||!this.onScroll||this.onScroll(this.contentEl.scrollTop)})}mount(e){this.container=e,this.container.innerHTML=`
            <div class="paragraph-layout">
                <div class="paragraph-container" id="paragraph-content">
                    <!-- Content injected here -->
                </div>
                <aside class="notes-panel" id="notes-panel">
                    <div class="notes-panel-header">
                        <h3>Notes</h3>
                        <button class="btn btn-secondary btn-sm" id="notes-toggle">Hide</button>
                    </div>
                    <div class="notes-panel-list" id="notes-panel-list"></div>
                </aside>
            </div>
        `,this.contentEl=this.container.querySelector("#paragraph-content"),this.notesPanelEl=this.container.querySelector("#notes-panel"),this.notesListEl=this.container.querySelector("#notes-panel-list"),this.notesToggleEl=this.container.querySelector("#notes-toggle"),this.notesToggleEl?.addEventListener("click",()=>{this.notesOpen=!this.notesOpen,this.updateNotesPanel()}),this.contentEl&&this.contentEl.addEventListener("scroll",this.handleScroll),this.updateNotesPanel()}unmount(){this.container&&(this.contentEl&&this.contentEl.removeEventListener("scroll",this.handleScroll),this.container.innerHTML="",this.container=null,this.contentEl=null,this.tokenEls.clear(),this.textNodeIndex=[])}setDocumentContext(e,t,s){this.originalText=e,this.ttsText=s,this.contentType=t,this.contentEl&&(this.contentEl.innerHTML=""),this.tokenEls.clear(),this.textNodeIndex=[],this.textNodeLength=0}renderText(e){if(!this.contentEl)return;if(this.contentEl.innerHTML="",this.tokenEls.clear(),this.textNodeIndex=[],this.textNodeLength=0,this.lastTokens=e,this.contentType==="html"){const s=Dr.sanitize(this.originalText);this.contentEl.innerHTML=this.stripExternalImages(s),this.applyAnnotationsToHtml(),this.buildTextNodeIndex();return}else if(this.contentType==="markdown"){const s=F.parse(this.originalText),i=Dr.sanitize(s);this.contentEl.innerHTML=this.stripExternalImages(i),this.applyAnnotationsToHtml(),this.buildTextNodeIndex();return}const t=document.createDocumentFragment();e.forEach((s,i)=>{const r=document.createElement("span");if(r.textContent=s.text,r.className="token",r.dataset.index=String(i),s.type==="newline"){t.appendChild(document.createElement("br")),t.appendChild(document.createElement("br"));return}this.tokenEls.set(i,r),t.appendChild(r)}),this.contentEl.appendChild(t),this.applyAnnotationsToText(e)}update(e,t){if(!this.contentEl)return;if(this.contentEl.children.length===0&&(this.contentType!=="text"&&this.originalText?this.renderText(t):t.length>0&&this.renderText(t)),this.contentType==="text"){if(this.activeTokenIndex!==-1){const r=this.tokenEls.get(this.activeTokenIndex);r&&r.classList.remove("active")}this.activeTokenIndex=e;const i=this.tokenEls.get(e);i&&(i.classList.add("active"),i.scrollIntoView({behavior:"smooth",block:"center"}))}else{const i=t[e];if(!i||(this.textNodeIndex.length||this.buildTextNodeIndex(),this.shouldUseTextIndex()&&this.scrollToTextOffset(i.startOffset)))return;this.scrollByOffsetRatio(i.startOffset)}}getScrollTop(){return this.contentEl?this.contentEl.scrollTop:0}setScrollTop(e){this.contentEl&&(this.contentEl.scrollTop=e)}setTheme(e){}setAnnotations(e,t){this.annotations=e,this.onAnnotationSelect=t,this.updateNotesPanel(),this.contentType==="text"?this.applyAnnotationsToText(this.lastTokens):(this.applyAnnotationsToHtml(),this.buildTextNodeIndex())}setScrollHandler(e){this.onScroll=e}stripExternalImages(e){const t=document.createElement("template");return t.innerHTML=e,t.content.querySelectorAll("img").forEach(i=>{const r=i.getAttribute("src")||"";r&&this.isExternalImageUrl(r)&&i.remove()}),t.innerHTML}isExternalImageUrl(e){try{const t=new URL(e,window.location.origin);return t.protocol!=="http:"&&t.protocol!=="https:"?!1:t.origin!==window.location.origin}catch{return!1}}applyAnnotationsToText(e){if(!(!this.contentEl||!e.length))for(const[t,s]of this.tokenEls){s.classList.remove("highlight-span","note-span");const i=e[t];if(i&&this.annotations.length)for(const r of this.annotations)i.startOffset<r.endOffset&&i.endOffset>r.startOffset&&s.classList.add(r.type==="note"?"note-span":"highlight-span")}}applyAnnotationsToHtml(){if(!this.contentEl||(this.unwrapHighlights(),!this.annotations.length))return;const e=[];let t=0;const s=document.createTreeWalker(this.contentEl,NodeFilter.SHOW_TEXT);let i=s.nextNode();for(;i;){const r=i.nodeValue||"";r.length>0&&(e.push({node:i,start:t,end:t+r.length}),t+=r.length),i=s.nextNode()}for(const r of e){const a=this.annotations.filter(d=>d.endOffset>r.start&&d.startOffset<r.end);if(!a.length)continue;const l=a.sort((d,h)=>d.startOffset-h.startOffset),o=r.node.nodeValue||"";let u=0;const c=document.createDocumentFragment();for(const d of l){const h=Math.max(0,d.startOffset-r.start),g=Math.min(o.length,d.endOffset-r.start);if(h>=g||h<u)continue;const m=o.slice(u,h);m&&c.appendChild(document.createTextNode(m));const y=document.createElement("span");y.className=d.type==="note"?"note-span":"highlight-span",y.textContent=o.slice(h,g),c.appendChild(y),u=g}u<o.length&&c.appendChild(document.createTextNode(o.slice(u))),r.node.parentNode?.replaceChild(c,r.node)}}buildTextNodeIndex(){if(!this.contentEl)return;this.textNodeIndex=[],this.textNodeLength=0;const e=document.createTreeWalker(this.contentEl,NodeFilter.SHOW_TEXT);let t=0,s=e.nextNode();for(;s;){const i=s.nodeValue||"";i.length>0&&(this.textNodeIndex.push({node:s,start:t,end:t+i.length}),t+=i.length),s=e.nextNode()}this.textNodeLength=t}findTextNodeEntryForOffset(e){if(!this.textNodeIndex.length)return null;let t=0,s=this.textNodeIndex.length-1;for(;t<=s;){const i=Math.floor((t+s)/2),r=this.textNodeIndex[i];if(e<r.start)s=i-1;else if(e>=r.end)t=i+1;else return r}return null}scrollToTextOffset(e){if(!this.contentEl)return!1;const t=this.findTextNodeEntryForOffset(e);if(!t)return!1;const s=Math.min(Math.max(0,e-t.start),t.end-t.start),i=document.createRange();try{i.setStart(t.node,s),i.setEnd(t.node,s)}catch{return!1}const r=i.getBoundingClientRect(),a=this.contentEl.getBoundingClientRect(),o=r.top-a.top+this.contentEl.scrollTop-this.contentEl.clientHeight/2;return this.contentEl.scrollTop=o,!0}shouldUseTextIndex(){return!this.textNodeLength||!this.ttsText.length?!1:Math.abs(this.textNodeLength-this.ttsText.length)/this.ttsText.length<.05}scrollByOffsetRatio(e){if(!this.contentEl||!this.ttsText.length)return;const t=this.contentEl.scrollHeight-this.contentEl.clientHeight;if(t<=0)return;const s=Math.min(1,Math.max(0,e/this.ttsText.length));this.contentEl.scrollTop=t*s}unwrapHighlights(){if(!this.contentEl)return;this.contentEl.querySelectorAll("span.highlight-span, span.note-span").forEach(t=>{const s=t.parentNode;s&&(s.replaceChild(document.createTextNode(t.textContent||""),t),s.normalize())})}updateNotesPanel(){if(!this.notesPanelEl||!this.notesListEl||!this.notesToggleEl||(this.notesPanelEl.classList.toggle("notes-panel-hidden",!this.notesOpen),this.notesToggleEl.textContent=this.notesOpen?"Hide":"Show",!this.notesOpen))return;if(!this.annotations.length){this.notesListEl.innerHTML='<div class="notes-empty">No notes or highlights yet.</div>';return}const e=this.annotations.map(t=>{const s=t.type==="note"?"Note":"Highlight",i=t.text?t.text:`Offset ${t.startOffset}`;return`
                <button class="notes-item" data-id="${t.id}">
                    <div class="notes-item-title">${s}</div>
                    <div class="notes-item-text">${i}</div>
                </button>
            `}).join("");this.notesListEl.innerHTML=e,this.notesListEl.querySelectorAll(".notes-item").forEach(t=>{t.addEventListener("click",()=>{const s=t.dataset.id;s&&this.onAnnotationSelect&&this.onAnnotationSelect(s)})})}}class Oc{constructor(e){p(this,"promptEvent");p(this,"onAvailabilityChange");this.onAvailabilityChange=e,window.addEventListener("beforeinstallprompt",t=>{t.preventDefault(),this.promptEvent=t,this.onAvailabilityChange?.(!0)}),window.addEventListener("appinstalled",()=>{this.promptEvent=null,this.onAvailabilityChange?.(!1)})}async promptInstall(){if(!this.promptEvent)return;this.promptEvent.prompt(),(await this.promptEvent.userChoice).outcome==="accepted"?(console.log("User accepted the A2HS prompt"),this.promptEvent=null,this.onAvailabilityChange?.(!1)):console.log("User dismissed the A2HS prompt")}}class Rn{constructor(){p(this,"container",null);p(this,"prevChunkEl",null);p(this,"chunkEl",null);p(this,"nextChunkEl",null);p(this,"currentChunkIndex",-1);p(this,"currentTokenIndex",-1);p(this,"focusContainer",null);p(this,"pagingBtn",null);p(this,"longPressTimer",null);p(this,"onPanicExit",null);p(this,"handlePointerDown",e=>{this.isPagingButtonEvent(e)||e.pointerType==="mouse"&&e.button!==0||(this.clearLongPressTimer(),this.longPressTimer=window.setTimeout(()=>{this.onPanicExit?.()},500))});p(this,"handlePointerUp",()=>{this.clearLongPressTimer()});p(this,"handlePointerCancel",()=>{this.clearLongPressTimer()});p(this,"handlePagingClick",e=>{e.stopPropagation(),this.onPanicExit?.()});p(this,"handlePagingPointerDown",e=>{e.stopPropagation()})}setPanicExitHandler(e){this.onPanicExit=e}mount(e){this.container=e,this.container.innerHTML=`
            <div class="focus-container">
                <button class="btn btn-secondary btn-sm focus-paging-btn" id="focus-paging-btn" type="button">Paging</button>
                <div class="focus-lines" id="focus-lines">
                    <div class="focus-chunk focus-ghost" id="focus-prev"></div>
                    <div class="focus-chunk focus-current" id="focus-chunk"></div>
                    <div class="focus-chunk focus-ghost" id="focus-next"></div>
                </div>
            </div>
        `,this.prevChunkEl=this.container.querySelector("#focus-prev"),this.chunkEl=this.container.querySelector("#focus-chunk"),this.nextChunkEl=this.container.querySelector("#focus-next"),this.focusContainer=this.container.querySelector(".focus-container"),this.pagingBtn=this.container.querySelector("#focus-paging-btn"),this.focusContainer&&(this.focusContainer.addEventListener("pointerdown",this.handlePointerDown),this.focusContainer.addEventListener("pointerup",this.handlePointerUp),this.focusContainer.addEventListener("pointerleave",this.handlePointerCancel),this.focusContainer.addEventListener("pointercancel",this.handlePointerCancel)),this.pagingBtn&&(this.pagingBtn.addEventListener("click",this.handlePagingClick),this.pagingBtn.addEventListener("pointerdown",this.handlePagingPointerDown))}unmount(){this.clearLongPressTimer(),this.focusContainer&&(this.focusContainer.removeEventListener("pointerdown",this.handlePointerDown),this.focusContainer.removeEventListener("pointerup",this.handlePointerUp),this.focusContainer.removeEventListener("pointerleave",this.handlePointerCancel),this.focusContainer.removeEventListener("pointercancel",this.handlePointerCancel)),this.pagingBtn&&(this.pagingBtn.removeEventListener("click",this.handlePagingClick),this.pagingBtn.removeEventListener("pointerdown",this.handlePagingPointerDown)),this.container&&(this.container.innerHTML="",this.container=null,this.prevChunkEl=null,this.chunkEl=null,this.nextChunkEl=null,this.currentChunkIndex=-1,this.focusContainer=null,this.pagingBtn=null)}update(e,t,s,i){if(!this.chunkEl||!this.prevChunkEl||!this.nextChunkEl||!t||t.length===0||this.currentChunkIndex===e&&this.currentTokenIndex===(s??-1))return;this.currentChunkIndex=e,this.currentTokenIndex=s??-1;const r=t[e],a=e>0?t[e-1]:null,l=e<t.length-1?t[e+1]:null;if(!r)return;this.prevChunkEl.textContent=a?.text??"",this.nextChunkEl.textContent=l?.text??"";const o=i&&s!==void 0?i[s]:void 0;if(o&&o.startOffset>=r.startOffset&&o.endOffset<=r.endOffset){const w=Math.max(0,o.startOffset-r.startOffset),b=Math.max(w,o.endOffset-r.startOffset),k=r.text.slice(0,w),S=r.text.slice(w,b),x=r.text.slice(b),C=ci(S),[I,v,O]=ui(S,C.orpIndex);this.chunkEl.innerHTML="";const E=document.createElement("span");E.className="focus-prefix",E.textContent=k;const B=document.createElement("span");B.className="focus-prefix",B.textContent=I;const L=document.createElement("span");L.className="focus-orp",L.textContent=v;const j=document.createElement("span");j.className="focus-suffix",j.textContent=O;const z=document.createElement("span");z.className="focus-suffix",z.textContent=x,this.chunkEl.append(E,B,L,j,z);return}const u=ci(r.text),[c,d,h]=ui(r.text,u.orpIndex);this.chunkEl.innerHTML="";const g=document.createElement("span");g.className="focus-prefix",g.textContent=c;const m=document.createElement("span");m.className="focus-orp",m.textContent=d;const y=document.createElement("span");y.className="focus-suffix",y.textContent=h,this.chunkEl.append(g,m,y)}setTheme(e){}clearLongPressTimer(){this.longPressTimer!==null&&(window.clearTimeout(this.longPressTimer),this.longPressTimer=null)}isPagingButtonEvent(e){return!!e.target?.closest("#focus-paging-btn")}}const Ka=/[\p{L}\p{N}''\u2019]+/gu,Dc=/[.!?]/g,Hr={en:["and","but","or","so","because","however","therefore","although","while"],de:["und","aber","oder","denn","weil","jedoch","deshalb","obwohl","wÃ¤hrend"],ru:["Ð¸","Ð½Ð¾","Ð¸Ð»Ð¸","ÑÐ°Ðº","Ð¿Ð¾ÑÐ¾Ð¼Ñ ÑÑÐ¾","Ð¾Ð´Ð½Ð°ÐºÐ¾","Ð¿Ð¾ÑÑÐ¾Ð¼Ñ","ÑÐ¾ÑÑ","Ð¿Ð¾ÐºÐ°"]},Wr=3,zr=12,Ln=15;function $c(n,e="en"){if(!n||n.trim().length===0)return[];const t=new Set;for(const u of n.matchAll(/[.?!;:]/g))t.add((u.index??0)+u[0].length);const s=Mc(e);for(const u of n.matchAll(s))t.add((u.index??0)+1);const i=Array.from(t).sort((u,c)=>u-c),r=[];let a=0;for(const u of i){if(u<=a)continue;const c=Rt(n,a,u);c&&r.push(c),a=u}if(a<n.length){const u=Rt(n,a,n.length);u&&r.push(u)}const l=qr(n,r),o=Nc(n,l);return qr(n,o)}function Mc(n){const e=n.split("-")[0].toLowerCase(),s=(Hr[e]||Hr.en).map(i=>i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")).join("|");return new RegExp(`,\\s+(?:${s})(?=\\s|$)`,"giu")}function Rt(n,e,t){let s=e,i=t;for(;s<i&&/\s/.test(n[s]);)s++;for(;i>s&&/\s/.test(n[i-1]);)i--;return i<=s?null:{text:n.slice(s,i),startOffset:s,endOffset:i}}function Ur(n){return n.match(Ka)?.length??0}function qr(n,e){if(e.length===0)return[];const t=[];let s=0;for(;s<e.length;){const i=e[s];if(Ur(i.text)<Wr&&s+1<e.length){const a=e[s+1],l=Rt(n,i.startOffset,a.endOffset);if(l){t.push(l),s+=2;continue}}t.push(i),s+=1}if(t.length>1){const i=t[t.length-1];if(Ur(i.text)<Wr){const r=t[t.length-2],a=Rt(n,r.startOffset,i.endOffset);a&&t.splice(t.length-2,2,a)}}return t}function Nc(n,e){const t=[];for(const s of e){const i=Array.from(s.text.matchAll(Ka));if(i.length<=Ln){t.push(s);continue}let r=s.startOffset,a=0;for(;a<i.length;){const o=i.length-a;if(o<=Ln)break;const u=o-Ln,c=u>0&&u<zr?zr:Ln,d=i[a+c-1];let g=s.startOffset+(d.index??0)+d[0].length;for(;g<s.endOffset&&/[)\]"'\u2019\u201D,.;:!?]/.test(n[g]);)g++;const m=Rt(n,r,g);for(m&&t.push(m),r=g;a<i.length&&s.startOffset+(i[a].index??0)<r;)a++}const l=Rt(n,r,s.endOffset);l&&t.push(l)}return t}function Bc(n){return n.match(Dc)?.length??0}function Fc(n,e,t,s="en"){const i=$c(n.text,s),r=[];let a=e;for(const l of i){const o=n.startOffset+l.startOffset,u=n.startOffset+l.endOffset,c=n.text.slice(l.startOffset,l.endOffset);r.push({id:Pt(),text:c,startOffset:o,endOffset:u,sentenceId:a,paraId:t}),a+=Bc(l.text)}return r}function jr(n,e){if(e.length===0)return[];const t=new Array(n.length).fill(0);let s=0;for(let i=0;i<n.length;i++){const r=n[i];for(;s<e.length&&r.startOffset>=e[s].endOffset;)s+=1;if(s>=e.length){t[i]=e.length-1;continue}r.startOffset<e[s].startOffset?t[i]=Math.max(0,s-1):t[i]=s}return t}function Vc(n){if(!n)return[];const e=[],t=/\n\s*\n/g;let s=0,i;for(;(i=t.exec(n))!==null;){const a=s,l=i.index,o=Kr(n,a,l);o&&e.push(o),s=t.lastIndex}const r=Kr(n,s,n.length);return r&&e.push(r),e}function Kr(n,e,t){let s=e,i=t;for(;s<i&&/\s/.test(n[s]);)s++;for(;i>s&&/\s/.test(n[i-1]);)i--;return i<=s?null:{text:n.slice(s,i),startOffset:s}}function Gr(n,e){return!e.length||n<=0?0:Math.min(e.length-1,Math.max(0,n-1))}function On(n,e){if(!e.length)return 0;const s=(e[n]??e[0]).sentenceId,i=e.find(l=>l.sentenceId===s);if(i&&i.index<n)return i.index;const r=s-1;if(r<0)return 0;const a=e.find(l=>l.sentenceId===r);return a?a.index:0}function Hc(n,e,t){const s=e/1e3,i=n-s;return Math.max(0,Math.min(i,t))}const Wc=3e4,zc=2,Uc=12e4,qc=6e4,jc=140,Kc=360;function Gc(){return{rewindTimestamps:[],lastAdjustTime:0,stableSince:null}}function Yc(n,e){e.rewindTimestamps.push(n),Ga(n,e),e.stableSince=null}function Zc(n,e,t){Ga(n,t);const s=t.rewindTimestamps.length;if(s>=zc&&Yr(n,t)){const i=Zr(Math.floor(e*.9));if(i!==e)return t.lastAdjustTime=n,t.stableSince=null,{nextWpm:i,reason:"slowdown"}}if(s===0&&(t.stableSince===null&&(t.stableSince=n),n-t.stableSince>=Uc&&Yr(n,t))){const i=Zr(Math.ceil(e*1.03));if(i!==e)return t.lastAdjustTime=n,t.stableSince=n,{nextWpm:i,reason:"speedup"}}return null}function Ga(n,e){const t=n-Wc;e.rewindTimestamps=e.rewindTimestamps.filter(s=>s>=t)}function Yr(n,e){return n-e.lastAdjustTime>=qc}function Zr(n){return Math.min(Kc,Math.max(jc,n))}function Xc(n){const{originalText:e,ttsText:t,contentType:s,title:i}=n,r=Jc(e,s);return{headings:su(r,t),textLength:t.length,title:i}}function Qc(n,e){const t=n.textLength||0,s=Xr(e,0,t),i=n.headings.slice().sort((h,g)=>h.startOffset-g.startOffset);if(i.length===0)return{chapterLabel:n.title||"Untitled",sectionLabel:null,chapterProgress:t>0?s/t*100:0,chapterStart:0,chapterEnd:t,hasStructure:!1};const r=ru(i,s),a=au(i,r),l=a?a.startOffset:0,o=ou(i,a)??t,u=lu(i,r,l,!!a),c=Math.max(1,o-l),d=(s-l)/c*100;return{chapterLabel:a?.text||n.title||"Untitled",sectionLabel:u?.text||null,chapterProgress:Xr(d,0,100),chapterStart:l,chapterEnd:o,hasStructure:!0}}function Jc(n,e){return n?e==="markdown"?eu(n):e==="html"?tu(n):nu(n):[]}function eu(n){const e=[],t=/^(#{1,6})\s+(.+)$/gm;let s;for(;(s=t.exec(n))!==null;){const i=s[1].length,a=s[2].trim().replace(/\s+#+\s*$/,"").trim();a&&e.push({level:i,text:a,startOffset:s.index})}return e}function tu(n){const t=new DOMParser().parseFromString(n,"text/html");return Array.from(t.querySelectorAll("h1, h2, h3, h4, h5, h6")).map(i=>{const r=parseInt(i.tagName.replace("H",""),10),a=(i.textContent||"").trim();return{level:Number.isNaN(r)?1:r,text:a,startOffset:0}}).filter(i=>i.text.length>0)}function nu(n){const e=[],t=n.split(/\r?\n/),s=[];let i=0;for(const r of t)s.push(i),i+=r.length+1;for(let r=0;r<t.length;r++){const l=t[r].trim();if(!l)continue;const o=r===0?!0:t[r-1].trim().length===0,u=r===t.length-1?!0:t[r+1].trim().length===0,c=/^(chapter|part|book)\b/i.test(l),d=/^section\b/i.test(l),h=cu(l,o,u);c||h?e.push({level:1,text:l,startOffset:s[r]}):d&&e.push({level:2,text:l,startOffset:s[r]})}return e}function su(n,e){if(!e)return n.map(i=>({...i,startOffset:0}));const t=[];let s=0;for(const i of n){const r=iu(e,i.text,s),a=r>=0?r:s;t.push({level:i.level,text:i.text,startOffset:a}),r>=0&&(s=r+i.text.length)}return t.sort((i,r)=>i.startOffset-r.startOffset)}function iu(n,e,t){if(!e)return-1;const s=n.indexOf(e,t);if(s>=0)return s;const i=n.toLowerCase(),r=e.toLowerCase(),a=i.indexOf(r,t);if(a>=0)return a;const l=uu(e).replace(/\s+/g,"\\s+"),o=new RegExp(l,"i"),c=n.slice(t).match(o);return c&&typeof c.index=="number"?t+c.index:-1}function ru(n,e){let t=-1;for(let s=0;s<n.length&&n[s].startOffset<=e;s++)t=s;return t}function au(n,e){for(let t=e;t>=0;t--)if(n[t].level===1)return n[t];return null}function ou(n,e){if(!e)return null;const t=e.startOffset;for(const s of n)if(s.level===1&&s.startOffset>t)return s.startOffset;return null}function lu(n,e,t,s){for(let i=e;i>=0;i--)if(n[i].level>=2&&n[i].level<=3&&n[i].startOffset>=t)return n[i];if(!s&&e>=0){const i=n[e];if(i.level>=2&&i.level<=3)return i}return null}function cu(n,e,t){return!(!e||!t||n.length<4||n.length>60||!/[A-Z]/.test(n)||/[a-z]/.test(n))}function uu(n){return n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Xr(n,e,t){return Math.min(t,Math.max(e,n))}class hu{constructor(e){p(this,"container");p(this,"labelEl");p(this,"percentEl");p(this,"fillEl");p(this,"structureMap",null);p(this,"lastLabel",null);p(this,"lastPercent",null);this.container=e,this.render()}render(){this.container.innerHTML=`
            <div class="structure-progress" id="structure-progress">
                <div class="structure-label" id="structure-label"></div>
                <div class="structure-bar" id="structure-bar">
                    <div class="structure-bar-fill" id="structure-bar-fill"></div>
                </div>
                <div class="structure-percent" id="structure-percent"></div>
            </div>
        `,this.labelEl=this.container.querySelector("#structure-label"),this.percentEl=this.container.querySelector("#structure-percent"),this.fillEl=this.container.querySelector("#structure-bar-fill")}setDocumentContext(e){this.structureMap=Xc(e),this.lastLabel=null,this.lastPercent=null,this.setVisible(!0)}updatePosition(e){if(!this.structureMap)return;const t=Qc(this.structureMap,e),s=t.sectionLabel?`${t.chapterLabel} -> ${t.sectionLabel}`:t.chapterLabel,i=Math.round(t.chapterProgress);s!==this.lastLabel&&(this.labelEl.textContent=s,this.lastLabel=s),i!==this.lastPercent&&(this.percentEl.textContent=`${i}%`,this.fillEl.style.width=`${i}%`,this.lastPercent=i)}clear(){this.structureMap=null,this.labelEl.textContent="",this.percentEl.textContent="",this.fillEl.style.width="0%",this.lastLabel=null,this.lastPercent=null}setVisible(e){this.container.classList.toggle("structure-progress-hidden",!e)}}class du{constructor(e,t){p(this,"container");p(this,"onClose");this.container=e,this.onClose=t,this.render(),this.setVisible(!1)}render(){this.container.innerHTML=`
            <div class="help-modal-overlay">
                <div class="help-modal">
                    <header class="help-header">
                        <h2>Keyboard Shortcuts</h2>
                        <button class="btn btn-secondary btn-icon" id="close-help" title="Close" aria-label="Close">${st.close}</button>
                    </header>
                    <div class="help-content">
                        <div class="help-row"><span class="help-key">?</span><span class="help-desc">Toggle this help</span></div>
                        <div class="help-row"><span class="help-key">Space</span><span class="help-desc">Play / Pause</span></div>
                        <div class="help-row"><span class="help-key">Left</span><span class="help-desc">Previous chunk</span></div>
                        <div class="help-row"><span class="help-key">Right</span><span class="help-desc">Next chunk</span></div>
                        <div class="help-row"><span class="help-key">Shift + Left</span><span class="help-desc">Previous sentence</span></div>
                        <div class="help-row"><span class="help-key">Shift + Right</span><span class="help-desc">Next sentence</span></div>
                        <div class="help-row"><span class="help-key">+</span><span class="help-desc">Increase speed</span></div>
                        <div class="help-row"><span class="help-key">-</span><span class="help-desc">Decrease speed</span></div>
                        <div class="help-row"><span class="help-key">Esc</span><span class="help-desc">Open paging view</span></div>
                    </div>
                </div>
            </div>
        `,this.container.querySelector("#close-help")?.addEventListener("click",()=>this.onClose()),this.container.querySelector(".help-modal-overlay")?.addEventListener("click",s=>{s.target?.classList.contains("help-modal-overlay")&&this.onClose()})}setVisible(e){this.container.classList.toggle("help-hidden",!e)}unmount(){this.container.innerHTML=""}}function Qr(n){let e=2166136261;for(let t=0;t<n.length;t++)e^=n.charCodeAt(t),e=Math.imul(e,16777619);return(e>>>0).toString(16)}const Jr=(n,e)=>`${n}:${e}`;class pu{async getChunks(e,t,s,i="en"){const r=Jr(e,t),a=await $.segmentCache.get(r);if(!a)return null;const l=Qr(`${i}|${s}`);return a.paragraphHash!==l?null:a.chunks.map(o=>({id:`${e}:${t}:${o.startOffset}`,text:o.text,startOffset:o.startOffset,endOffset:o.endOffset,sentenceId:o.sentenceId,paraId:o.paraId}))}async setChunks(e,t,s,i,r="en"){const a=Date.now(),l={id:Jr(e,t),docId:e,paraId:t,paragraphHash:Qr(`${r}|${s}`),chunks:i.map(o=>({text:o.text,startOffset:o.startOffset,endOffset:o.endOffset,sentenceId:o.sentenceId,paraId:o.paraId})),createdAt:a,lastUpdated:a};await $.segmentCache.put(l)}async clearForDoc(e){await $.segmentCache.where("docId").equals(e).delete()}}const ea=new pu;class fu{async addHighlight(e,t,s,i){const r={id:Pt(),docId:e,type:"highlight",startOffset:t,endOffset:s,paraId:i,createdAt:Date.now()};return await $.annotations.add(r),r}async addNote(e,t,s,i,r){const a={id:Pt(),docId:e,type:"note",startOffset:t,endOffset:s,paraId:r,text:i,createdAt:Date.now()};return await $.annotations.add(a),a}async getAnnotations(e){return await $.annotations.where("docId").equals(e).sortBy("startOffset")}async deleteAnnotation(e){await $.annotations.delete(e)}}const Ds=new fu,qt={library:st.library,newDoc:st.newDoc,settings:st.settings,install:st.install,info:st.info},$s={min:200,max:1400},Ms={min:120,max:450};class gu{constructor(e){p(this,"container");p(this,"audioEngine");p(this,"controls");p(this,"currentView");p(this,"rsvpView");p(this,"paragraphView");p(this,"focusView");p(this,"settings");p(this,"initialized",!1);p(this,"destroyed",!1);p(this,"appInstaller",null);p(this,"viewContainer");p(this,"uiLoopActive",!1);p(this,"isReaderActive",!1);p(this,"lastWpmLogTime",0);p(this,"settingsPanel");p(this,"infoModal");p(this,"textInput");p(this,"loadingOverlay");p(this,"documentList");p(this,"progress");p(this,"keyboardHelp");p(this,"isHelpOpen",!1);p(this,"voiceWarningEl",null);p(this,"voiceWarningInstallId",null);p(this,"fatigueNudgeEl",null);p(this,"fatigueActiveMs",0);p(this,"fatigueLastTickMs",null);p(this,"fatigueNudgeShown",!1);p(this,"scrollSaveTimer",null);p(this,"currentDocId",null);p(this,"currentDocTitle","");p(this,"currentTtsText","");p(this,"currentLanguage","en-US");p(this,"currentAnnotations",[]);p(this,"currentTokens",[]);p(this,"currentChunks",[]);p(this,"tokenChunkMap",[]);p(this,"adaptState",Gc());p(this,"lastPlaybackState","none");p(this,"keepAliveAudio");const t=document.getElementById(e);if(!t)throw new Error(`Container #${e} not found`);this.container=t,this.audioEngine=new hl,this.rsvpView=new Il,this.paragraphView=new qe,this.focusView=new Rn,this.paragraphView.setScrollHandler(s=>this.handleParagraphScroll(s)),this.focusView.setPanicExitHandler(()=>{this.handleFocusPanicExit()}),this.keepAliveAudio=new Audio}async init(){if(this.initialized)return;this.initialized=!0,this.renderShell(),this.appInstaller=new Oc(a=>{const l=this.container.querySelector("#btn-install-app");l&&(l.style.display=a?"inline-flex":"none")});const e=new URLSearchParams(window.location.search),t=e.get("title"),s=e.get("text"),i=e.get("url");if(t||s||i){console.log("[ReaderShell] Received shared content:",{title:t,textLength:s?.length,url:i});const a=window.location.pathname;window.history.replaceState({},document.title,a),await this.loadInitialState(),await xr(),await Sr(),await this.setupComponents()}else await this.loadInitialState();!t&&!s&&!i&&(await xr(),await Sr()),!t&&!s&&!i&&await this.setupComponents(),this.loadingOverlay=new _l;const r=document.querySelector(".loading");if(r&&r.remove(),t||s||i){this.settingsPanel||await this.setupComponents();let a=s||"";i&&(a&&(a+=`

`),a+=i);const l=t||"Shared Content";await this.handleNewDocument(l,a,a,"text")}this.startUiLoop(),this.setupMediaSession(),this.setupKeyboardShortcuts()}destroy(){if(this.destroyed)return;this.destroyed=!0,this.audioEngine.cancelSynthesis(),this.audioEngine.getController().pause().catch(()=>{}),this.audioEngine.destroy(),this.currentView?.unmount(),this.textInput?.unmount(),this.documentList?.unmount(),this.settingsPanel?.unmount(),this.keyboardHelp?.unmount();const e=document.querySelector(".loading-overlay");e&&e.remove(),this.container&&(this.container.innerHTML="")}renderShell(){this.keepAliveAudio=new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"),this.keepAliveAudio.loop=!0,this.keepAliveAudio.volume=0,this.container.innerHTML=`
            <div class="shell-container">
                <header class="header">
                    <h1>Spritz Voice</h1>
                    <div>
                        <button class="btn btn-secondary btn-icon" id="btn-library" title="Library" aria-label="Library">${qt.library}</button>
                        <button class="btn btn-secondary btn-icon" id="btn-new-text" title="New Document" aria-label="New Document">${qt.newDoc}</button>
                        <button class="btn btn-secondary btn-icon" id="btn-install-app" title="Install App" aria-label="Install App" style="display: none;">${qt.install}</button>
                        <button class="btn btn-secondary btn-icon" id="btn-info" title="Info & Help" aria-label="Info & Help">${qt.info}</button>
                        <button class="btn btn-secondary btn-icon" id="btn-settings" title="Settings" aria-label="Settings">${qt.settings}</button>
                    </div>
                </header>

                <div id="structure-progress-mount"></div>

                <div id="voice-warning" class="voice-warning voice-warning-hidden"></div>
                
                <main class="main-view" id="view-container">
                    <!-- Views or Text Input mounted here -->
                </main>
                
                <footer class="controls-area" id="controls-mount">
                </footer>

                <div id="fatigue-nudge" class="fatigue-nudge fatigue-nudge-hidden"></div>
                
                <div id="settings-mount"></div>
                <div id="info-mount"></div>
                <div id="help-mount"></div>
            </div>
        `,this.viewContainer=this.container.querySelector("#view-container"),this.container.querySelector("#btn-new-text")?.addEventListener("click",()=>{this.showTextInput()}),this.container.querySelector("#btn-library")?.addEventListener("click",()=>{this.showDocumentList()}),this.container.querySelector("#btn-settings")?.addEventListener("click",()=>{this.settingsPanel.mount()}),this.container.querySelector("#btn-info")?.addEventListener("click",()=>{this.infoModal.mount()}),this.container.querySelector("#btn-install-app")?.addEventListener("click",async()=>{await this.appInstaller?.promptInstall()})}async loadInitialState(){try{this.settings=await le.loadSettings()}catch(t){console.error("Failed to load initial state:",t),this.settings={voiceId:"default",speedWpm:250,strategy:"TOKEN",chunkSize:5,lookaheadSec:20,mode:"RSVP",pauseRules:{punctPauseMs:400,paragraphPauseMs:600},tokenizerVersion:"1",textSize:1,theme:"default",readerFontFamily:"literata",readerLineHeight:1.6,orpEnabled:!0,orpIntensity:1,language:"en-US",skipSettings:{seekSec:10,wordCount:1,sentenceCount:1,paragraphCount:1,mediaSkipBackUnit:"paragraph",mediaSkipFwdUnit:"paragraph"}}}const e=this.settings.theme||(this.settings.darkMode?"dark":"default");this.settings.theme=e,this.applyTheme(e),this.applyTypography(),this.applyOrpSettings()}async setupComponents(){const e=this.container.querySelector("#controls-mount"),t=this.audioEngine.getController();this.controls=new gl(e,{onPlayPause:()=>{this.audioEngine.getController().getScheduler().resumeContext();const c=this.audioEngine.getController();c.getState()==="PLAYING"?c.pause():c.play().catch(h=>console.error("Play failed",h)),this.keepAliveAudio.play().catch(()=>{})},onSeek:c=>{const d=c>0?1:-1,h=(this.settings.skipSettings?.seekSec||10)*d;h<0&&this.noteRewind(),t.seek(h)},onSkip:(c,d)=>{const h=this.currentTokens;if(!h.length)return;const g=(c==="word"?this.settings.skipSettings?.wordCount:c==="sentence"?this.settings.skipSettings?.sentenceCount:this.settings.skipSettings?.paragraphCount)||1,m=d>0?1:-1;if(c==="chunk"){if(!this.currentChunks.length)return;d===-1&&this.noteRewind();const y=t.getCurrentTokenIndex(),w=this.tokenChunkMap[y]??0,b=Gr(w,this.currentChunks),k=this.currentChunks[b];if(!k)return;const S=this.findTokenIndexForOffset(k.startOffset,y);t.seekByToken(S);return}for(let y=0;y<g;y++)if(c==="word")m===-1&&this.noteRewind(),t.skipWord(m,h);else if(c==="sentence")if(m===-1&&this.noteRewind(),m===-1){const w=On(t.getCurrentTokenIndex(),h);t.seekByToken(w)}else t.skipSentence(m,h);else c==="paragraph"&&(m===-1&&this.noteRewind(),t.skipParagraph(m,h))},onHighlight:()=>this.handleHighlightBuffer(),onNote:()=>this.handleAddNote(),onCopySentence:()=>this.handleCopySentence(),onViewChange:c=>this.switchView(c),onSpeedChange:c=>this.handleRateChange(c),onWpmChange:c=>this.handleWpmChange(c),onVolumeChange:c=>this.audioEngine.setVolume(c)},this.settings.playbackRate||1,this.settings.speedWpm||250,1);const s=this.settings.mode==="FOCUS"?Ms:$s;this.controls.setWpmRange(s.min,s.max);const i=this.settings.theme||(this.settings.darkMode?"dark":"default");this.settings.theme=i,this.applyTheme(i),this.applyTypography(),this.applyOrpSettings(),this.controls.setActiveView(this.settings.mode);const r=this.container.querySelector("#structure-progress-mount");this.progress=new hu(r),this.progress.setVisible(!1),this.voiceWarningEl=this.container.querySelector("#voice-warning"),this.fatigueNudgeEl=this.container.querySelector("#fatigue-nudge"),this.renderFatigueNudge();const a=this.container.querySelector("#help-mount");this.keyboardHelp=new du(a,()=>this.setHelpVisible(!1)),this.setHelpVisible(!1);const l=this.container.querySelector("#settings-mount"),o=await le.loadSettings();this.settingsPanel=new kl(l,{onClose:()=>this.settingsPanel.unmount(),onVoiceChange:async c=>{if(console.log(`[ReaderShell] onVoiceChange: ${c}`),o.voiceId=c,await le.saveSettings({voiceId:c}),this.settings.voiceId=c,this.currentDocId)try{await X.updateSettings(this.currentDocId,c,this.settings.speedWpm),console.log(`[ReaderShell] Saved voice ${c} to doc ${this.currentDocId}`)}catch(h){console.warn("Failed to save doc settings",h)}const d=(await this.audioEngine.getAvailableVoices()).find(h=>h.id===c);if(d&&!d.isInstalled){console.log(`[ReaderShell] Voice ${c} not installed, skipping synthesis`);return}this.loadingOverlay.show("Loading Voice...",()=>this.audioEngine.cancelSynthesis()),await this.audioEngine.updateSettings(this.settings,(h,g)=>{this.loadingOverlay.setProgress(h),g&&this.loadingOverlay.setText(g)}),this.loadingOverlay.hide()},onLanguageChange:async c=>{o.language=c,await le.saveSettings({language:c})},onInstallVoice:async c=>{this.loadingOverlay.show("Downloading Voice components...",()=>{});try{await this.audioEngine.installVoice(c,b=>{this.loadingOverlay.setProgress(b)});const d=await this.audioEngine.getAvailableVoices();this.settingsPanel.setVoices(d);const h=d.find(b=>b.id===c),m=(this.currentLanguage||"").toLowerCase().split("-")[0],y=h?.lang.toLowerCase()||"",w=!!(m&&y.startsWith(m));h&&(this.settings.voiceId===c||w)&&(this.settings.voiceId=c,this.currentDocId&&await X.updateSettings(this.currentDocId,c,this.settings.speedWpm),this.loadingOverlay.setText("Initializing voice..."),await this.audioEngine.updateSettings(this.settings,(b,k)=>{this.loadingOverlay.setProgress(b),k&&this.loadingOverlay.setText(k)},!0))}catch(d){alert("Failed to download voice: "+d.message)}finally{this.loadingOverlay.hide()}},onSpeedChange:async c=>{o.speedWpm=c,le.saveSettings({speedWpm:c}),console.log(`[Settings] Updated global default WPM to ${c}. Active doc remains at ${this.settings.speedWpm}`)},onStrategyChange:async c=>{this.settings.strategy=c,le.saveSettings({strategy:c}),this.loadingOverlay.show("Updating Strategy...",()=>this.audioEngine.cancelSynthesis()),await this.audioEngine.updateSettings(this.settings,(d,h)=>{this.loadingOverlay.setProgress(d),h&&this.loadingOverlay.setText(h)}),this.loadingOverlay.hide()},onTextSizeChange:async c=>{o.textSize=c,this.settings.textSize=c,le.saveSettings({textSize:c}),this.applyTypography()},onThemeChange:async c=>{o.theme=c,this.settings.theme=c,le.saveSettings({theme:c}),this.applyTheme(c)},onFontFamilyChange:async c=>{o.readerFontFamily=c,this.settings.readerFontFamily=c,le.saveSettings({readerFontFamily:c}),this.applyTypography()},onLineHeightChange:async c=>{o.readerLineHeight=c,this.settings.readerLineHeight=c,le.saveSettings({readerLineHeight:c}),this.applyTypography()},onOrpToggle:async c=>{o.orpEnabled=c,this.settings.orpEnabled=c,le.saveSettings({orpEnabled:c}),this.applyOrpSettings()},onOrpIntensityChange:async c=>{o.orpIntensity=c,this.settings.orpIntensity=c,le.saveSettings({orpIntensity:c}),this.applyOrpSettings()},onSkipSettingsChange:async c=>{this.settings.skipSettings=c,await le.saveSettings({skipSettings:c})}},o);const u=this.container.querySelector("#info-mount");this.infoModal=new vl(u,()=>{}),this.audioEngine.getAvailableVoices().then(c=>{this.settingsPanel.setVoices(c)}).catch(c=>console.error("Failed to fetch voices",c)),this.textInput=new Sl(this.viewContainer,async c=>{if(c.length===1){const{title:d,originalText:h,ttsText:g,contentType:m,language:y}=c[0];await this.handleNewDocument(d,h,g,m,y)}else c.length>1&&await this.handleBulkImport(c)}),this.documentList=new Tl(this.viewContainer,{onResume:c=>this.resumeDocument(c),onDelete:c=>{this.currentDocId===c&&(this.currentDocId=null,this.showDocumentList())},onNewDocument:()=>this.showTextInput()}),this.showDocumentList()}async handleNewDocument(e,t,s,i,r){this.loadingOverlay.show("Processing Document...",()=>this.audioEngine.cancelSynthesis());const a=Wn.tokenize(s);this.currentTokens=a,this.currentDocTitle=e,this.currentTtsText=s,this.currentLanguage=r||this.settings.language,r&&(this.settings.language=r);const l=await X.createDocument(e,t,s,i,a.length,r);if(this.currentChunks=await this.buildChunksWithCache(l.id,s,this.currentLanguage),this.tokenChunkMap=jr(a,this.currentChunks),this.currentDocId=l.id,this.currentAnnotations=[],await X.updateSettings(l.id,this.settings.voiceId,this.settings.speedWpm),r){const o=await this.selectVoiceForLanguage(r);o&&(this.settings.voiceId=o,await X.updateSettings(l.id,o,this.settings.speedWpm)),await this.warnIfVoiceMissing(r,o??null)}await this.audioEngine.loadDocument(l.id,a,this.settings,0,(o,u)=>{this.loadingOverlay.setProgress(o),u&&this.loadingOverlay.setText(u)}),this.paragraphView.setDocumentContext(t,i,s),this.paragraphView.setAnnotations([],null),this.progress.setDocumentContext({title:e,originalText:t,ttsText:s,contentType:i}),this.progress.setVisible(!0),this.resetFatigueNudge(),this.loadingOverlay.hide(),this.switchView(this.settings.mode),this.currentView&&this.currentView.update(0,a),this.setupPlaybackListeners(),this.updateMediaMetadata(e)}async handleBulkImport(e){this.loadingOverlay.show(`Importing ${e.length} documents...`,()=>{});for(let t=0;t<e.length;t++){const s=e[t],i=Wn.tokenize(s.ttsText);this.loadingOverlay.setText(`Importing ${t+1}/${e.length}: ${s.title}`),this.loadingOverlay.setProgress(t/e.length*100),await X.createDocument(s.title,s.originalText,s.ttsText,s.contentType,i.length,s.language)}this.loadingOverlay.hide(),await this.showDocumentList()}showTextInput(){this.isReaderActive=!1,this.audioEngine.getController().pause(),this.currentView&&this.currentView.unmount(),this.documentList.unmount(),this.textInput.mount(),this.progress.setVisible(!1)}async showDocumentList(){this.isReaderActive=!1,this.audioEngine.getController().pause(),this.currentView&&this.currentView.unmount(),this.textInput.unmount(),await this.documentList.mount(),this.progress.setVisible(!1)}async resumeDocument(e){const t=await X.getDocument(e);if(!t)return;this.currentDocId=e,this.currentDocTitle=t.title,this.currentTtsText=t.ttsText||t.originalText,this.currentLanguage=t.language||this.settings.language,t.language&&(this.settings.language=t.language),this.loadingOverlay.show("Loading Document...",()=>this.audioEngine.cancelSynthesis());const s=t.ttsText||t.originalText;this.paragraphView.setDocumentContext(t.originalText,t.contentType||"text",s);const i=Wn.tokenize(s);if(this.currentTokens=i,this.currentChunks=await this.buildChunksWithCache(t.id,s,this.currentLanguage),this.tokenChunkMap=jr(i,this.currentChunks),t.language){const l=await this.selectVoiceForLanguage(t.language),o=t.voiceId?await this.voiceMatchesLanguage(t.voiceId,t.language):!1;l&&(!t.voiceId||t.voiceId==="default"||!o)?(this.settings.voiceId=l,await X.updateSettings(t.id,l,this.settings.speedWpm)):t.voiceId&&t.voiceId!=="default"&&(this.settings.voiceId=t.voiceId),await this.warnIfVoiceMissing(t.language,l??t.voiceId??null)}else t.voiceId&&t.voiceId!=="default"&&(this.settings.voiceId=t.voiceId);t.speedWpm&&(this.settings.speedWpm=t.speedWpm,this.controls.setWpm(t.speedWpm)),t.mode&&(this.settings.mode=t.mode);const r=t.progressTokenIndex??0,a=t.progressOffset!==void 0?this.findTokenIndexForOffset(t.progressOffset,r):r;await this.audioEngine.loadDocument(t.id,i,this.settings,a,(l,o)=>{this.loadingOverlay.setProgress(l),o&&this.loadingOverlay.setText(o)}),this.progress.setDocumentContext({title:t.title,originalText:t.originalText,ttsText:s,contentType:t.contentType||"text"}),this.progress.setVisible(!0),this.resetFatigueNudge(),this.loadingOverlay.hide(),this.switchView(this.settings.mode),this.setupPlaybackListeners(),this.updateMediaMetadata(t.title),await this.loadAnnotations(e),this.settings.mode==="PARAGRAPH"&&t.progressScrollTop!==void 0&&window.setTimeout(()=>{this.paragraphView.setScrollTop(t.progressScrollTop||0)},0)}async buildChunksWithCache(e,t,s){const i=Vc(t),r=[];let a=0;for(let l=0;l<i.length;l++){const o=i[l],u=await ea.getChunks(e,l,o.text,s);if(u&&u.length>0){r.push(...u);const d=u[u.length-1].sentenceId;a=Math.max(a,d+1);continue}const c=Fc(o,a,l,s);if(r.push(...c),c.length>0){const d=c[c.length-1].sentenceId;a=Math.max(a,d+1)}else a+=1;await ea.setChunks(e,l,o.text,c,s)}return r}async voiceMatchesLanguage(e,t){const i=(await this.audioEngine.getAvailableVoices()).find(o=>o.id===e);if(!i)return!1;const r=t.toLowerCase(),a=r.split("-")[0],l=i.lang.toLowerCase();return l.startsWith(r)||l.startsWith(a)}switchView(e){if(this.isReaderActive=!0,this.currentDocId){const l=this.audioEngine.getController().getCurrentTokenIndex();X.updateReadingState(this.currentDocId,this.buildReadingState(l))}this.currentView&&this.currentView.unmount(),this.textInput.unmount(),this.documentList.unmount(),this.settings.mode=e,le.saveSettings({mode:e}),e==="RSVP"?this.currentView=this.rsvpView:e==="FOCUS"?this.currentView=this.focusView:this.currentView=this.paragraphView,this.currentView.mount(this.viewContainer),this.controls.setActiveView(e);const t=this.audioEngine.getController();if(this.currentView instanceof Rn){const l=t.getCurrentTokenIndex(),o=this.tokenChunkMap[l]??0;this.currentView.update(o,this.currentChunks,l,this.currentTokens)}else(this.currentTokens.length>0||this.currentView instanceof qe)&&this.currentView.update(t.getCurrentTokenIndex(),this.currentTokens);const s=e==="FOCUS"?Ms:$s,i=this.controls.setWpmRange(s.min,s.max);i!==this.settings.speedWpm&&this.handleWpmChange(i);const r=t.getCurrentTokenIndex(),a=this.currentTokens[r]?.startOffset??0;this.progress.updatePosition(a),this.progress.setVisible(!0)}startUiLoop(){if(this.uiLoopActive)return;this.uiLoopActive=!0;const e=()=>{const t=this.audioEngine.getController(),s=t.getScheduler(),i=t.getState()==="PLAYING",r=this.container.querySelector("#controls-mount");if(r&&(this.isReaderActive?r.classList.remove("collapsed"):r.classList.add("collapsed")),this.controls.setPlaying(i),"mediaSession"in navigator){const d=i?"playing":"paused";this.lastPlaybackState!==d&&(navigator.mediaSession.playbackState=d,this.lastPlaybackState=d);const h=s.getCurrentTime(),g=t.getDuration();if(g>0&&h<=g)try{navigator.mediaSession.setPositionState({duration:g,playbackRate:this.settings.playbackRate||1,position:h})}catch{}}const a=s.getCurrentTime(),l=t.getDuration();this.controls.setTime(a.toFixed(1),l>0?l.toFixed(1):"--:--");const o=t.getCurrentTokenIndex(),u=this.currentTokens.length,c=u>0?o/u*100:0;if(this.controls.setProgress(c),i){const d=performance.now();d-this.lastWpmLogTime>=1e3&&(console.log(`[Playback] WPM (controls): ${this.settings.speedWpm}`),this.lastWpmLogTime=d)}requestAnimationFrame(e)};requestAnimationFrame(e)}async handleRateChange(e){this.settings.playbackRate=e,await le.saveSettings({playbackRate:e}),this.audioEngine.updateSettings(this.settings)}async handleWpmChange(e){if(this.settings.speedWpm=e,this.currentDocId){const t=this.audioEngine.getController().getCurrentTokenIndex();await X.updateReadingState(this.currentDocId,{...this.buildReadingState(t),speedWpm:e})}this.loadingOverlay.show("Synthesizing...",()=>this.audioEngine.cancelSynthesis());try{await this.audioEngine.updateSettings(this.settings,(t,s)=>{this.loadingOverlay.setProgress(t),s&&this.loadingOverlay.setText(s)})}finally{this.loadingOverlay.hide()}}setupPlaybackListeners(){const e=this.audioEngine.getController();let t=0;const s=2e3;e.onTokenChanged=i=>{if(this.currentView instanceof Rn){const a=this.tokenChunkMap[i]??0;this.currentView.update(a,this.currentChunks,i,this.currentTokens)}else this.currentView&&this.currentView.update(i,this.currentTokens);const r=this.currentTokens[i]?.startOffset??0;if(this.progress.updatePosition(r),this.currentDocId){const a=Date.now();a-t>s&&(X.updateReadingState(this.currentDocId,this.buildReadingState(i)),t=a)}this.maybeAdaptSpeed()},e.onTimeUpdate=()=>{this.trackSessionTick()}}setupMediaSession(){if("mediaSession"in navigator){const e=this.audioEngine.getController(),t=()=>{e.getScheduler().resumeContext(),e.getState()==="PLAYING"?e.pause():e.play().catch(i=>console.error(i))},s=i=>{if(!this.currentTokens.length)return;const r=i===-1?this.settings.skipSettings?.mediaSkipBackUnit||"paragraph":this.settings.skipSettings?.mediaSkipFwdUnit||"paragraph";if(r==="seek"){const l=this.settings.skipSettings?.seekSec||10,u=e.getScheduler().getCurrentTime(),c=e.getDuration(),d=Hc(u,l*1e3*(i===-1?1:-1),c);i===-1&&this.noteRewind(),e.seek(d-u);return}const a=(r==="word"?this.settings.skipSettings?.wordCount:r==="sentence"?this.settings.skipSettings?.sentenceCount:this.settings.skipSettings?.paragraphCount)||1;for(let l=0;l<a;l++)if(r==="word")e.skipWord(i,this.currentTokens);else if(r==="sentence")if(i===-1){this.noteRewind();const o=On(e.getCurrentTokenIndex(),this.currentTokens);e.seekByToken(o)}else e.skipSentence(i,this.currentTokens);else i===-1&&this.noteRewind(),e.skipParagraph(i,this.currentTokens)};navigator.mediaSession.setActionHandler("play",t),navigator.mediaSession.setActionHandler("pause",t),navigator.mediaSession.setActionHandler("previoustrack",()=>s(-1)),navigator.mediaSession.setActionHandler("nexttrack",()=>s(1)),navigator.mediaSession.setActionHandler("seekbackward",()=>{const i=this.settings.skipSettings?.seekSec||10;this.noteRewind(),e.seek(-i)}),navigator.mediaSession.setActionHandler("seekforward",()=>{const i=this.settings.skipSettings?.seekSec||10;e.seek(i)}),navigator.mediaSession.setActionHandler("stop",()=>{e.pause(),e.seekByToken(0)})}}updateMediaMetadata(e){"mediaSession"in navigator&&(navigator.mediaSession.metadata=new MediaMetadata({title:e,artist:"Spritz Voice",album:"Reader"}))}setHelpVisible(e){this.isHelpOpen=e,this.keyboardHelp.setVisible(e)}renderFatigueNudge(){this.fatigueNudgeEl&&(this.fatigueNudgeEl.innerHTML=`
            <div class="fatigue-nudge-content" role="status" aria-live="polite">
                <div class="fatigue-text">
                    You have been reading for a while. Want a quick break or switch to paging?
                </div>
                <div class="fatigue-actions">
                    <button class="btn btn-secondary" id="fatigue-dismiss">Maybe later</button>
                    <button class="btn btn-secondary" id="fatigue-paging">Open paging</button>
                </div>
            </div>
        `,this.fatigueNudgeEl.querySelector("#fatigue-dismiss")?.addEventListener("click",()=>{this.hideFatigueNudge()}),this.fatigueNudgeEl.querySelector("#fatigue-paging")?.addEventListener("click",()=>{this.hideFatigueNudge(),this.openPagingFromShortcut()}))}showFatigueNudge(){!this.fatigueNudgeEl||this.fatigueNudgeShown||(this.fatigueNudgeShown=!0,this.fatigueNudgeEl.classList.remove("fatigue-nudge-hidden"))}hideFatigueNudge(){this.fatigueNudgeEl&&this.fatigueNudgeEl.classList.add("fatigue-nudge-hidden")}resetFatigueNudge(){this.fatigueActiveMs=0,this.fatigueLastTickMs=null,this.fatigueNudgeShown=!1,this.hideFatigueNudge()}trackSessionTick(){if(this.fatigueNudgeShown)return;const e=Date.now();if(this.fatigueLastTickMs===null){this.fatigueLastTickMs=e;return}const t=e-this.fatigueLastTickMs;this.fatigueLastTickMs=e,!(t<=0)&&(t>5e3||(this.fatigueActiveMs+=t,this.fatigueActiveMs>=20*60*1e3&&this.showFatigueNudge()))}async loadAnnotations(e){this.currentAnnotations=await Ds.getAnnotations(e),this.updateParagraphAnnotations()}updateParagraphAnnotations(){const e=this.currentAnnotations.map(t=>({id:t.id,type:t.type,startOffset:t.startOffset,endOffset:t.endOffset,text:t.type==="note"?t.text:this.buildSnippet(t.startOffset,t.endOffset)}));this.paragraphView.setAnnotations(e,t=>this.handleAnnotationSelect(t))}handleAnnotationSelect(e){const t=this.currentAnnotations.find(a=>a.id===e);if(!t)return;const s=this.audioEngine.getController(),i=s.getCurrentTokenIndex(),r=this.findTokenIndexForOffset(t.startOffset,i);this.currentView instanceof qe||this.switchView("PARAGRAPH"),s.seekByToken(r),this.currentView instanceof qe&&this.currentView.update(r,this.currentTokens)}buildSnippet(e,t){return(this.currentTtsText||"").slice(e,Math.min(t,e+140)).replace(/\s+/g," ").trim()}getSentenceRange(){const t=this.audioEngine.getController().getCurrentTokenIndex(),s=this.currentTokens[t];if(!s)return null;const i=s.sentenceId,r=this.currentTokens.filter(o=>o.sentenceId===i);if(!r.length)return null;const a=r[0],l=r[r.length-1];return{startOffset:a.startOffset,endOffset:l.endOffset}}getHighlightRange(){if(!this.currentChunks.length)return null;const t=this.audioEngine.getController().getCurrentTokenIndex(),s=this.tokenChunkMap[t]??0,i=Math.max(0,s-1),r=Math.min(this.currentChunks.length-1,s+1),a=this.currentChunks[i].startOffset,l=this.currentChunks[r].endOffset;return{startOffset:a,endOffset:l}}async handleHighlightBuffer(){if(!this.currentDocId)return;const e=this.getHighlightRange();if(!e)return;const s=this.audioEngine.getController().getCurrentTokenIndex(),i=this.tokenChunkMap[s]??0,r=this.currentChunks[i]?.paraId;await Ds.addHighlight(this.currentDocId,e.startOffset,e.endOffset,r),await this.loadAnnotations(this.currentDocId)}async handleAddNote(){if(!this.currentDocId)return;const e=this.getSentenceRange();if(!e)return;const t=window.prompt("Add a note for this sentence:");if(!t)return;const i=this.audioEngine.getController().getCurrentTokenIndex(),r=this.tokenChunkMap[i]??0,a=this.currentChunks[r]?.paraId;await Ds.addNote(this.currentDocId,e.startOffset,e.endOffset,t.trim(),a),await this.loadAnnotations(this.currentDocId)}async handleCopySentence(){const e=this.getSentenceRange();if(!e)return;const s=`${this.currentTtsText.slice(e.startOffset,e.endOffset).replace(/\s+/g," ").trim()} â ${this.currentDocTitle}`.trim();try{await navigator.clipboard.writeText(s)}catch{const i=document.createElement("textarea");i.value=s,document.body.appendChild(i),i.select(),document.execCommand("copy"),i.remove()}}handleParagraphScroll(e){this.currentDocId&&this.currentView instanceof qe&&(this.scrollSaveTimer!==null&&window.clearTimeout(this.scrollSaveTimer),this.scrollSaveTimer=window.setTimeout(()=>{const t=this.audioEngine.getController().getCurrentTokenIndex(),s=this.buildReadingState(t);s.progressScrollTop=e,X.updateReadingState(this.currentDocId,s),this.scrollSaveTimer=null},500))}noteRewind(){Yc(Date.now(),this.adaptState)}maybeAdaptSpeed(){const e=Date.now(),t=Zc(e,this.settings.speedWpm,this.adaptState);t&&t.nextWpm!==this.settings.speedWpm&&this.handleWpmChange(t.nextWpm)}getActiveWpmRange(){return this.settings.mode==="FOCUS"?Ms:$s}applyTheme(e){const t=document.documentElement;t.classList.remove("theme-default","theme-calm","theme-dark","dark-mode"),t.classList.add(`theme-${e}`)}applyTypography(){const e=document.documentElement,t=this.settings.textSize||1,s=this.settings.readerLineHeight||1.6,i=this.settings.readerFontFamily||"literata",r={literata:'"Literata", "Times New Roman", serif',"source-serif":'"Source Serif 4", "Georgia", serif',atkinson:'"Atkinson Hyperlegible", "Arial", sans-serif'},a=r[i]||r.literata;e.style.setProperty("--font-size-base",`${16*t}px`),e.style.setProperty("--reader-font-size",`${16*t}px`),e.style.setProperty("--reader-font-scale",t.toString()),e.style.setProperty("--reader-font-family",a),e.style.setProperty("--reader-line-height",s.toString())}applyOrpSettings(){const e=document.documentElement,t=this.settings.orpEnabled!==!1,s=typeof this.settings.orpIntensity=="number"?this.settings.orpIntensity:1;e.style.setProperty("--orp-opacity",Math.max(0,Math.min(1,s)).toString()),e.classList.toggle("orp-disabled",!t)}showVoiceWarning(e){this.voiceWarningEl&&(this.voiceWarningEl.innerHTML=`
            <div class="voice-warning-content">
                <div class="voice-warning-text">
                    <div class="voice-warning-title">Voice not installed</div>
                    <div>${e}</div>
                </div>
                <div class="voice-warning-actions">
                    <button class="btn btn-secondary btn-sm" id="voice-warning-download" ${this.voiceWarningInstallId?"":"disabled"}>
                        Download Voice
                    </button>
                    <button class="btn btn-secondary btn-sm" id="voice-warning-settings">Open Settings</button>
                    <button class="btn btn-secondary btn-sm" id="voice-warning-dismiss">Dismiss</button>
                </div>
            </div>
        `,this.voiceWarningEl.classList.remove("voice-warning-hidden"),this.voiceWarningEl.querySelector("#voice-warning-settings")?.addEventListener("click",()=>{this.settingsPanel.mount()}),this.voiceWarningEl.querySelector("#voice-warning-download")?.addEventListener("click",async()=>{if(!this.voiceWarningInstallId)return;const t=this.voiceWarningEl?.querySelector("#voice-warning-download");t&&(t.disabled=!0,t.textContent="Downloading...");try{await this.audioEngine.installVoice(this.voiceWarningInstallId),this.settings.voiceId=this.voiceWarningInstallId,this.currentDocId&&await X.updateSettings(this.currentDocId,this.voiceWarningInstallId,this.settings.speedWpm),await this.audioEngine.updateSettings(this.settings,void 0,!0),this.hideVoiceWarning()}catch{t&&(t.disabled=!1,t.textContent="Download Voice")}}),this.voiceWarningEl.querySelector("#voice-warning-dismiss")?.addEventListener("click",()=>{this.voiceWarningEl?.classList.add("voice-warning-hidden")}))}hideVoiceWarning(){this.voiceWarningEl?.classList.add("voice-warning-hidden")}async warnIfVoiceMissing(e,t){if(!e)return;const s=await this.audioEngine.getAvailableVoices(),i=t?s.find(r=>r.id===t):void 0;if(!i){this.voiceWarningInstallId=null,this.showVoiceWarning(`${this.formatLanguageLabel(e)} voice is not available. Using English voice for now.`);return}i.isInstalled?(this.voiceWarningInstallId=null,this.hideVoiceWarning()):(this.voiceWarningInstallId=i.id,this.showVoiceWarning(`${i.name} (${this.formatLanguageLabel(e)}) is not installed. Using English voice for now.`))}formatLanguageLabel(e){switch(e.split("-")[0].toLowerCase()){case"de":return"German";case"ru":return"Russian";case"es":return"Spanish";case"fr":return"French";case"en":return"English";default:return e}}handleSpeedShortcut(e){const s=this.getActiveWpmRange(),i=Math.min(s.max,Math.max(s.min,this.settings.speedWpm+10*e));i!==this.settings.speedWpm&&this.handleWpmChange(i)}buildReadingState(e){const t=this.currentTokens[e],s=this.tokenChunkMap[e]??0,i=this.currentChunks[s],r=this.currentView instanceof qe?this.paragraphView.getScrollTop():void 0;return{progressTokenIndex:e,progressOffset:t?.startOffset??0,progressChunkIndex:s,progressParaId:i?.paraId??0,progressScrollTop:r,speedWpm:this.settings.speedWpm,mode:this.settings.mode}}openPagingFromShortcut(){if(this.currentView instanceof Rn){this.handleFocusPanicExit();return}this.currentView instanceof qe||this.switchView("PARAGRAPH")}setupKeyboardShortcuts(){window.addEventListener("keydown",e=>{const t=this.audioEngine.getController(),s=e.target;if(!(s.tagName==="INPUT"||s.tagName==="TEXTAREA")){if(this.isHelpOpen){(e.key==="Escape"||e.key==="?"||e.code==="Slash"&&e.shiftKey)&&(e.preventDefault(),this.setHelpVisible(!1));return}if(e.key==="?"||e.code==="Slash"&&e.shiftKey){e.preventDefault(),this.setHelpVisible(!0);return}switch(e.code){case"Space":e.preventDefault(),t.getScheduler().resumeContext(),t.getState()==="PLAYING"?t.pause():t.play().catch(console.error);break;case"MediaPlayPause":t.getScheduler().resumeContext(),t.getState()==="PLAYING"?t.pause():t.play().catch(console.error);break;case"MediaTrackNext":if(navigator.mediaSession){const i=this.settings.skipSettings?.mediaSkipFwdUnit||"paragraph";if(i==="seek"){const r=this.settings.skipSettings?.seekSec||10;t.seek(r)}else{const r=(i==="word"?this.settings.skipSettings?.wordCount:i==="sentence"?this.settings.skipSettings?.sentenceCount:this.settings.skipSettings?.paragraphCount)||1;for(let a=0;a<r;a++)i==="word"?t.skipWord(1,this.currentTokens):i==="sentence"?t.skipSentence(1,this.currentTokens):t.skipParagraph(1,this.currentTokens)}}break;case"MediaTrackPrevious":if(navigator.mediaSession){const i=this.settings.skipSettings?.mediaSkipBackUnit||"paragraph";if(i==="seek"){const r=this.settings.skipSettings?.seekSec||10;this.noteRewind(),t.seek(-r)}else{const r=(i==="word"?this.settings.skipSettings?.wordCount:i==="sentence"?this.settings.skipSettings?.sentenceCount:this.settings.skipSettings?.paragraphCount)||1;for(let a=0;a<r;a++)if(i==="word")t.skipWord(-1,this.currentTokens);else if(i==="sentence"){this.noteRewind();const l=On(t.getCurrentTokenIndex(),this.currentTokens);t.seekByToken(l)}else this.noteRewind(),t.skipParagraph(-1,this.currentTokens)}}break;case"MediaStop":t.pause(),t.seekByToken(0);break;case"ArrowLeft":{if(e.preventDefault(),!this.currentTokens.length||!this.currentChunks.length)return;if(e.shiftKey){this.noteRewind();const u=On(t.getCurrentTokenIndex(),this.currentTokens);t.seekByToken(u);return}this.noteRewind();const i=t.getCurrentTokenIndex(),r=this.tokenChunkMap[i]??0,a=Gr(r,this.currentChunks),l=this.currentChunks[a];if(!l)return;const o=this.findTokenIndexForOffset(l.startOffset,i);t.seekByToken(o);break}case"ArrowRight":{if(e.preventDefault(),!this.currentTokens.length||!this.currentChunks.length)return;if(e.shiftKey){t.skipSentence(1,this.currentTokens);return}const i=t.getCurrentTokenIndex(),r=this.tokenChunkMap[i]??0,a=Math.min(this.currentChunks.length-1,r+1),l=this.currentChunks[a];if(!l)return;const o=this.findTokenIndexForOffset(l.startOffset,i);t.seekByToken(o);break}case"Equal":case"NumpadAdd":e.preventDefault(),this.handleSpeedShortcut(1);break;case"Minus":case"NumpadSubtract":e.preventDefault(),this.handleSpeedShortcut(-1);break;case"Escape":e.preventDefault(),this.openPagingFromShortcut();break}}})}async selectVoiceForLanguage(e){const t=await this.audioEngine.getAvailableVoices(),s=e.toLowerCase(),i=s.split("-")[0];let r=t.find(a=>a.lang.toLowerCase().startsWith(s)&&a.isInstalled);return r||(r=t.find(a=>a.lang.toLowerCase().startsWith(i)&&a.isInstalled),r)||(r=t.find(a=>a.lang.toLowerCase().startsWith(s)),r)||(r=t.find(a=>a.lang.toLowerCase().startsWith(i)),r)?r.id:null}async handleFocusPanicExit(){const e=this.audioEngine.getController();if(!this.currentTokens.length||!this.currentChunks.length){this.switchView("PARAGRAPH");return}if(e.getState()==="PLAYING")try{await e.pause()}catch{}const t=e.getCurrentTokenIndex(),s=this.tokenChunkMap[t]??0,i=this.currentChunks[s],r=i?this.findTokenIndexForOffset(i.startOffset,t):Math.max(0,t);e.seekByToken(r),this.switchView("PARAGRAPH"),this.currentView instanceof qe&&this.currentView.update(r,this.currentTokens)}findTokenIndexForOffset(e,t){if(!this.currentTokens.length)return t;let s=0,i=this.currentTokens.length-1,r=-1;for(;s<=i;){const a=Math.floor((s+i)/2);this.currentTokens[a].startOffset>=e?(r=a,i=a-1):s=a+1}return r===-1?this.currentTokens.length-1:r}}function mu(n={}){const{immediate:e=!1,onNeedRefresh:t,onOfflineReady:s,onRegistered:i,onRegisteredSW:r,onRegisterError:a}=n;let l,o;const u=async(d=!0)=>{await o};async function c(){if("serviceWorker"in navigator){if(l=await Gt(async()=>{const{Workbox:d}=await import("./workbox-window.prod.es5-vqzQaGvo.js");return{Workbox:d}},[]).then(({Workbox:d})=>new d("/spirtzVioice/beta/sw.js",{scope:"/spirtzVioice/beta/",type:"classic"})).catch(d=>{a?.(d)}),!l)return;l.addEventListener("activated",d=>{(d.isUpdate||d.isExternal)&&window.location.reload()}),l.addEventListener("installed",d=>{d.isUpdate||s?.()}),l.register({immediate:e}).then(d=>{r?r("/spirtzVioice/beta/sw.js",d):i?.(d)}).catch(d=>{a?.(d)})}}return o=c(),u}console.log("Spirtz Voice initializing...");if(!window.__spirtzApp){const n=new gu("app");window.__spirtzApp=n,n.init().catch(console.error)}console.log("Spirtz Voice mounted.");mu({immediate:!0,onOfflineReady(){console.log("Spirtz Voice ready for offline use.")},onNeedRefresh(){console.log("Spirtz Voice update available.")}});
