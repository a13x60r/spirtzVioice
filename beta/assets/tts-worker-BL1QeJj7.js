var P=Object.defineProperty;var B=(o,e,t)=>e in o?P(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var f=(o,e,t)=>B(o,typeof e!="symbol"?e+"":e,t);const O={};class T{constructor(){f(this,"workers",[]);f(this,"activeWorkers",new Set)}getWorker(e){const t=this.workers.find(r=>!this.activeWorkers.has(r));if(t)return this.activeWorkers.add(t),t;if(this.workers.length<3){const r=new Worker(e);return this.workers.push(r),this.activeWorkers.add(r),r}return console.warn("Worker pool exhausted, spawning temporary worker"),new Worker(e)}releaseWorker(e){this.workers.includes(e)?this.activeWorkers.delete(e):e.terminate()}removeWorker(e){this.activeWorkers.delete(e),this.workers=this.workers.filter(t=>t!==e),e.terminate()}}const E=new T,z=async(o,e,t,r,n,l,c,i,h,u,s=!1,k="https://cdnjs.cloudflare.com/ajax/libs/onnxruntime-web/1.17.1/",V,C=!1,L)=>(s&&console.warn("Emotion inference is not supported in this local adaptation of piper-wasm."),new Promise((x,S)=>{const d=E.getWorker(r),W=g=>{const a=g.data;switch(a.kind){case"output":{_(),x({file:a.file,duration:a.duration,phonemes:a.phonemes,phonemeIds:a.phonemeIds});break}case"stderr":{console.error(a.message),_(),S(new Error(a.message));break}case"fetch":{a.blob&&(O[a.url]=a.blob),a.blob||a.total&&a.loaded/a.total;break}}},_=()=>{d.removeEventListener("message",W),E.releaseWorker(d)};d.addEventListener("message",W),d.addEventListener("error",g=>{console.error("Piper worker error:",g),d.removeEventListener("message",W),E.removeWorker(d),S(new Error(`Worker error: ${g.message}`))});const y=navigator.hardwareConcurrency||4,M=self.crossOriginIsolated;!M&&y>1&&console.warn(`[Piper] Cross-Origin Isolation is FALSE. Forcing single-threaded mode to prevent hang. Cores available: ${y}`);const I=M?Math.max(1,Math.floor(y/3)):1;d.postMessage({kind:"init",input:i,speakerId:c,blobs:O,piperPhonemizeJsUrl:o,piperPhonemizeWasmUrl:e,piperPhonemizeDataUrl:t,modelUrl:n,modelConfigUrl:l,phonemeIds:u,onnxruntimeUrl:k,lengthScale:V,numThreads:I,useWebGPU:C,gpuPreference:L})})),m="/spirtzVioice/beta/piper/";class j{constructor(e=""){f(this,"currentModelUrl",m+"en_US-amy-medium.onnx");f(this,"currentConfigUrl",m+"en_US-amy-medium.onnx.json");f(this,"originUrl");f(this,"currentVoiceId",null);f(this,"isWarm",!1);this.originUrl=e||""}toAbsoluteUrl(e){if(this.originUrl&&!e.startsWith("http")&&!e.startsWith("blob:")){const t=this.originUrl.replace(/\/$/,""),r=e.startsWith("/")?e:"/"+e;return t+r}return e}async init(){console.log("OfflineVoice (Piper) initializing...")}async getVoices(){return[{id:"en_US-amy-medium.onnx",name:"Amy (Medium) - English US"}]}async loadVoice(e,t){if(console.log(`[OfflineVoice] loadVoice called for ${e}, hasAssets=${!!t}`),!(this.isWarm&&this.currentVoiceId===e&&!t)){if(t)console.log(`Loading custom voice assets for ${e}`),this.currentModelUrl.startsWith("blob:")&&URL.revokeObjectURL(this.currentModelUrl),this.currentConfigUrl.startsWith("blob:")&&URL.revokeObjectURL(this.currentConfigUrl),this.currentModelUrl=URL.createObjectURL(t.model instanceof Blob?t.model:new Blob([t.model])),this.currentConfigUrl=URL.createObjectURL(t.config instanceof Blob?t.config:new Blob([t.config]));else{const n={default:"en_US-amy-medium.onnx","en-us":"en_US-amy-medium.onnx",amy:"en_US-amy-medium.onnx","en_US-amy-medium.onnx":"en_US-amy-medium.onnx"}[e]||"en_US-amy-medium.onnx";this.currentModelUrl=m+n,this.currentConfigUrl=m+n+".json",console.log(`Configured voice: ${e} -> ${n}`)}this.currentVoiceId=e,this.isWarm=!1,console.log(`[OfflineVoice] Warming up voice ${e}...`);try{const r=this.synthesize("Ready",300),n=new Promise((l,c)=>setTimeout(()=>c(new Error("Warmup timeout")),1e4));await Promise.race([r,n]),console.log("[OfflineVoice] Warmup complete."),this.isWarm=!0}catch(r){console.warn("[OfflineVoice] Warmup failed (non-fatal if network issue persists, but likely to fail later):",r)}}}async synthesize(e,t,r=!1,n){const c=175/Math.max(50,t);try{const i=await z(this.toAbsoluteUrl(m+"piper_phonemize.js"),this.toAbsoluteUrl(m+"piper_phonemize.wasm"),this.toAbsoluteUrl(m+"piper_phonemize.data"),this.toAbsoluteUrl(m+"piper_worker.js"),this.toAbsoluteUrl(this.currentModelUrl),this.toAbsoluteUrl(this.currentConfigUrl),null,e,s=>{},null,!1,this.toAbsoluteUrl(m),c,r,n),u=await i.file.arrayBuffer();return{audioData:new Float32Array(0),sampleRate:22050,durationSec:i.duration/1e3,wavBuffer:u}}catch(i){throw console.error("Piper synthesis failed",i),i}}}function $(o,e,t=1){const n=o.length,l=t*2,c=e*l,i=n*l,h=44+i,u=new ArrayBuffer(h),s=new DataView(u);return U(s,0,"RIFF"),s.setUint32(4,36+i,!0),U(s,8,"WAVE"),U(s,12,"fmt "),s.setUint32(16,16,!0),s.setUint16(20,1,!0),s.setUint16(22,t,!0),s.setUint32(24,e,!0),s.setUint32(28,c,!0),s.setUint16(32,l,!0),s.setUint16(34,16,!0),U(s,36,"data"),s.setUint32(40,i,!0),D(s,44,o),u}function U(o,e,t){for(let r=0;r<t.length;r++)o.setUint8(e+r,t.charCodeAt(r))}function D(o,e,t){for(let r=0;r<t.length;r++,e+=2){let n=Math.max(-1,Math.min(1,t[r]));n=n<0?n*32768:n*32767,o.setInt16(e,n,!0)}}const b=self;let p,A="",v=null,R=!1;b.onmessage=async o=>{const{type:e,payload:t}=o.data;try{switch(e){case"INIT":A=t?.originUrl||"",p=new j(A),await p.init(),w("INIT_COMPLETE");break;case"GET_VOICES":{const r=await p.getVoices();w("VOICES_LIST",r);break}case"SYNTHESIZE_CHUNK":await F(t);break;case"LOAD_VOICE":{const{voiceId:r,assets:n}=t;if(R&&v===r&&!n){w("VOICE_LOADED",{voiceId:r});break}await p.loadVoice(r,n),v=r,R=!0,w("VOICE_LOADED",{voiceId:r});break}default:console.warn("Unknown message type:",e)}}catch(r){console.error("Worker error:",r),b.postMessage({type:"CHUNK_ERROR",error:r.message,payload:t})}};async function F(o){const{chunkText:e,chunkHash:t,speedWpm:r,useWebGPU:n,gpuPreference:l}=o,{audioData:c,sampleRate:i,durationSec:h,wavBuffer:u}=await p.synthesize(e,r,n??!1,l);let s;u?s=u:s=$(c,i);const k={chunkHash:t,audioData:s,durationSec:h,sampleRate:i};b.postMessage({type:"CHUNK_COMPLETE",payload:k},[s])}function w(o,e){b.postMessage({type:o,payload:e})}
